10186

♪ ♪

David: Xin chào, và chào mừng đến với "Có gì mới trong Dữ liệu cốt lõi." Tên tôi là David Stites, và tôi là một kỹ sư trong nhóm Core Data.

Trong phiên này, bạn sẽ tìm hiểu về các công nghệ mới trong Dữ liệu cốt lõi sẽ giúp bạn thiết kế, truy vấn, cập nhật và di chuyển mô hình dữ liệu cốt lõi trong ứng dụng của mình một cách nhanh chóng và dễ dàng hơn.

Tôi sẽ bắt đầu bằng cách nói về các thuộc tính tổng hợp, một cách mới tuyệt vời để sắp xếp dữ liệu có cấu trúc trong mô hình ứng dụng của bạn, trước khi nói về cách "giai đoạn" di chuyển mô hình phức tạp nhất của bạn để bạn có thể sử dụng di chuyển nhẹ và tôi sẽ kết thúc với cách trì hoãn di chuyển mô hình của bạn để giữ

Thuộc tính tổng hợp là một loại thuộc tính mới.

Các thuộc tính tổng hợp cho phép đóng gói các kiểu dữ liệu phức tạp và tùy chỉnh trong một thuộc tính duy nhất.

Mỗi thuộc tính tổng hợp bao gồm các thuộc tính của các loại Dữ liệu Cốt lõi tích hợp mà bạn đã quen thuộc, chẳng hạn như Chuỗi, Float, Int và Dữ liệu.

Các thuộc tính tổng hợp có thể được lồng vào nhau để thuộc tính tổng hợp cấp cao nhất có thể chứa các thuộc tính tổng hợp bổ sung.

Trình chỉnh sửa mô hình Dữ liệu Lõi Xcode đã được cập nhật để giúp dễ dàng xác định và quản lý các thuộc tính tổng hợp của mô hình của bạn.

Các thuộc tính tổng hợp là một sự thay thế hấp dẫn cho việc sử dụng các thuộc tính loại có thể chuyển đổi để tạo ra các loại dữ liệu tùy chỉnh bền vững.

Không cần phải viết mã để biến đổi giá trị của thuộc tính.

Không giống như các thuộc tính có thể chuyển đổi, các thuộc tính tổng hợp cho phép NSFetchRequests với NSPredicates được cấu hình với các đường dẫn khóa không gian tên của thuộc tính tổng hợp.

Các thuộc tính tổng hợp có thể được sử dụng để gói gọn sự gia tăng của các thuộc tính phẳng, dẫn đến mã dễ bảo trì và dễ đọc hơn.

Các thuộc tính tổng hợp có thể được sử dụng để cải thiện hiệu suất của ứng dụng của bạn.

Nếu mô hình dữ liệu của bạn được cấu tạo theo cách mà việc tìm nạp một thực thể hầu như luôn dẫn đến việc truy cập mối quan hệ với một thực thể khác, bạn có thể tái cấu trúc mối quan hệ đó thành sử dụng các thuộc tính tổng hợp.

Hiệu quả của việc nhúng một thuộc tính tổng hợp vào thực thể đầu tiên là nó ngăn ngừa lỗi trong các đối tượng trong mối quan hệ.

Lớp thuộc tính tổng hợp là NSCompositeAttributeDescription.

Loại thuộc tính cho NSCompositeAttributeDescription là NSCompositeAttributeType.

Lớp NSCompositeAttributeDescription chứa một mảng, các phần tử, bao gồm NSAttributeDescription hoặc NSCompositeAttributeDescription lồng nhau khác.

Mảng phần tử không thể chứa các loại mô tả thuộc tính khác, chẳng hạn như NSRelationshipDescription.

Cố gắng thiết lập các phần tử không hợp lệ sẽ dẫn đến NSInvalidArgumentException.

Tôi sẽ mô tả cho bạn cách áp dụng các thuộc tính tổng hợp với bản demo.

Hãy xem xét mô hình dữ liệu cơ bản này với một thực thể Máy bay.

Nó có một số thuộc tính, bao gồm một thuộc tính màu sắc, là một loại có thể biến đổi.

Máy biến áp cho loại đó lưu trữ và phân tích cú pháp một chuỗi được định dạng mô tả các màu chính, phụ và thứ ba của máy bay.

Tôi sẽ cải thiện thực thể này bằng cách thay thế thuộc tính màu sắc bằng thuộc tính tổng hợp colorScheme để lưu trữ màu sơn của máy bay.

colorScheme là một thuộc tính tổng hợp với các phần tử: Tiểu học, phụ và đại học, mỗi phần tử là một thuộc tính Chuỗi.

Trong Xcode, tôi sẽ mở một dự án là một ứng dụng tôi sử dụng để theo dõi thời gian bay của mình.

Mô hình dữ liệu cho ứng dụng đó được cấu hình với thực thể Máy bay mà tôi vừa nói đến, cũng như một vài thực thể khác.

Để bắt đầu chuyển đổi, trong trình chỉnh sửa mô hình Dữ liệu Cốt lõi, tôi đang thêm một thuộc tính tổng hợp mới có tên colorScheme.

Trong tổng hợp đó, tôi đang thêm ba thuộc tính chuỗi, chính, phụ và đại học.

Trong thực thể Máy bay, tôi sẽ thêm thuộc tính tổng hợp và đặt loại thuộc tính đó thành colorScheme.

Công việc trong mô hình hiện đã hoàn tất và đã đến lúc cập nhật mã.

Trong quá mục Triển khai Máy bay của mình, tôi đang thêm một thuộc tính mới, @NSManaged var colorScheme, có loại là Từ điển có khóa Chuỗi và Bất kỳ đối tượng nào.

Khi tôi sử dụng thuộc tính tổng hợp này trong suốt mã, tôi đang truy cập các giá trị bằng ký hiệu từ điển, với tên của thuộc tính làm khóa.

Ở đây, tôi đang thiết lập thuộc tính colorScheme của máy bay bằng cách sử dụng các phím String chính, phụ và đại học.

Tương tự, khi tôi định cấu hình NSFetchRequest với NSPredicate, các phần tử của thuộc tính tổng hợp được truy cập thông qua đường dẫn khóa không gian tên.

Ở đây, colorScheme.primary được sử dụng để lọc trên thuộc tính đó.

Khi một ứng dụng phát triển, có thể cần phải thay đổi mô hình dữ liệu.

Việc cập nhật mô hình dữ liệu yêu cầu những thay đổi đó được hiện thực hóa trong lược đồ lưu trữ cơ bản.

Nếu thuộc tính numPassengers được thêm vào mô hình, bộ nhớ tương ứng phải được cập nhật.

Quá trình thực hiện thay đổi lược đồ được gọi là di chuyển.

Sau khi di chuyển, những thay đổi được phản ánh đầy đủ trong bộ nhớ cơ bản.

Core Data có bộ công cụ di chuyển tích hợp để giúp cập nhật bộ nhớ dữ liệu của ứng dụng với mô hình dữ liệu hiện tại.

Nói chung, những công cụ này được gọi là "di cư nhẹ". Để tìm hiểu thêm về di chuyển nhẹ, hãy xem "Tiến hóa lược đồ ứng dụng của bạn" từ WWDC 2022.

Đôi khi, những thay đổi kết hợp đối với mô hình dữ liệu vượt quá khả năng di chuyển nhẹ.

Giải pháp cho vấn đề này là di chuyển theo giai đoạn.

API di chuyển theo giai đoạn được thiết kế với một vài mục tiêu: Giúp bạn di chuyển các mô hình dữ liệu phức tạp có các thay đổi lược đồ nhẹ không phù hợp, đơn giản hóa ứng dụng của bạn bằng cách có khả năng xóa hàng nghìn dòng mã liên quan đến di chuyển và cơ sở hạ tầng di chuyển và cung cấp cơ hội cho ứng dụng của bạn có quyền kiểm soát

Để sử dụng API này, có một số bước bạn sẽ cần thực hiện: Xác định khi nào các thay đổi đối với mô hình của bạn không phù hợp với các hoạt động được hỗ trợ bởi di chuyển nhẹ, phân tách các thay đổi mô hình không phù hợp thành một loạt các thay đổi mô hình phù hợp được hỗ trợ bởi di chuyển nhẹ, mô tả tổng thứ tự của NSMan

Tại một số thời điểm nhất định trong quá trình di chuyển, quyền kiểm soát thực thi sẽ được cung cấp cho ứng dụng của bạn để thực hiện bất kỳ tác vụ cần thiết nào liên quan đến quá trình di chuyển đó.

Để xác định khi nào mô hình của bạn có những thay đổi nhẹ không phù hợp, bạn có một số tùy chọn.

Tùy chọn đầu tiên là xem lại các thay đổi lược đồ theo cách thủ công và đảm bảo mỗi thay đổi đều đủ điều kiện để di chuyển nhẹ.

Tùy chọn thứ hai là cố gắng mở cửa hàng liên tục với mô hình mới và các tùy chọn di chuyển nhẹ, NSMigratePersistentStores AutomaticallyOption và NSInferMappingModelAutomaticallyOption được đặt thành true.

Nếu các thay đổi không đủ điều kiện nhẹ, bạn sẽ nhận được NSPersistentStore IncompatibleVersionHashError.

Lựa chọn cuối cùng là sử dụng NSMappingModel.inferredMappingModel (forSourceModel:destinationModel:).

Phương thức này trả về mô hình suy ra nếu Core Data có thể tạo ra nó.

Nếu không, nó trả về số không.

Xem xét mô hình Máy bay một lần nữa, nó có một thuộc tính mới, flightData, lưu trữ dữ liệu ở định dạng nhị phân.

Giả sử cần phải phi chuẩn hóa mô hình này và tách tất cả dữ liệu chuyến bay thành loại thực thể riêng của nó, tất cả trong khi vẫn giữ bất kỳ dữ liệu hiện có nào và mối quan hệ với máy bay mà nó được tạo ra.

Đây là một thay đổi mô hình rất phức tạp và bản thân nó không đủ điều kiện để di chuyển nhẹ.

Những thay đổi này cần được phân tách để sử dụng di chuyển theo giai đoạn.

Khi phân tích các thay đổi không nhẹ, mục tiêu là chuyển đổi các tác vụ di chuyển không đủ điều kiện để di chuyển nhẹ thành một chuỗi di chuyển tối thiểu đủ điều kiện để di chuyển nhẹ.

Mỗi mô hình được giới thiệu sẽ có một hoặc nhiều hoạt động nằm trong khả năng di chuyển nhẹ tạo nên những thay đổi không phù hợp.

Kết quả là một loạt các di chuyển trong đó mỗi mô hình có thể di chuyển nhẹ nhưng tương đương với di chuyển không phù hợp.

Quay trở lại ví dụ, tôi đã gắn nhãn mô hình ban đầu ModelV1.

Việc di chuyển mô hình này sẽ được phân tách bằng cách giới thiệu hai phiên bản mô hình mới, ModelV2 và ModelV3.

Trong ModelV2, thực thể Máy bay có được một mối quan hệ được gọi là flightParameters, đây là một tập hợp các thực thể FlightData mới được tạo ra.

Thực thể FlightData có dữ liệu thuộc tính loại nhị phân và mối quan hệ với Máy bay.

Để bảo toàn dữ liệu hiện có, giai đoạn di chuyển sẽ sao chép dữ liệu từ thực thể Máy bay sang các thực thể FlightData mới và liên kết chúng với Máy bay.

Mô hình cuối cùng của chúng tôi là ModelV3, được tạo ra từ ModelV2.

Trong ModelV3, thuộc tính flightData cũ bị xóa khỏi thực thể Máy bay và mô hình được phi chuẩn hóa thành công và tất cả dữ liệu hiện có được bảo toàn.

Mỗi bước được mô tả đều nằm trong khả năng di chuyển nhẹ.

Để mô tả tổng thứ tự của các mô hình, hỗ trợ cấp khung Dữ liệu Cốt lõi bao gồm các lớp sau: NSStagedMigrationManager, NSCustomMigrationStage, NSLightweightMigrationStage và NSManagedObjectModelReference.

Lớp NSStagedMigrationManager gói gọn tổng thứ tự của NSCustomMigrationStage và NSLightweightMigrationStage bổ sung do bạn mô tả.

Trình quản lý di chuyển theo giai đoạn cũng quản lý vòng lặp sự kiện di chuyển và cung cấp quyền truy cập vào cửa hàng di chuyển thông qua NSPersistentContainer.

Người quản lý được thêm vào các tùy chọn cửa hàng bằng cách sử dụng khóa NSPersistentStoreStagedMigrationManager OptionKey.

Các giai đoạn di chuyển tạo thành cơ sở để di chuyển giữa các phiên bản của một mô hình.

Khi bạn áp dụng di chuyển theo giai đoạn, bạn sẽ mô tả từng phiên bản mô hình thành Core Data bằng cách sử dụng NSCustomMigrationStage hoặc NSLightweightMigrationStage.

Lớp NSLightweightMigrationStage mô tả một loạt các mô hình không yêu cầu phân tách và đủ điều kiện di chuyển nhẹ.

Đây có thể sẽ là phần lớn các mô hình của bạn.

Các giai đoạn di chuyển nhẹ này được sử dụng để bổ sung tổng thứ tự của các mô hình được mô tả cho Dữ liệu cốt lõi.

Tất cả các phiên bản mô hình nhẹ phải được thể hiện trong một hoặc nhiều NSLightweightMigrationStage's.

Mỗi phiên bản đã phân tách của mô hình bạn tạo sẽ được biểu diễn bằng NSCustomMigrationStage và chứa tham chiếu mô hình nguồn và tham chiếu mô hình đích.

NSCustomMigrationStage cung cấp các trình xử lý tùy chọn chạy ngay trước và sau giai đoạn di chuyển.

Những trình xử lý này cung cấp cho bạn khả năng chạy mã tùy chỉnh trong quá trình di chuyển.

Di chuyển theo giai đoạn sử dụng lớp NSManagedObjectModelReference.

Lớp này đại diện cho lời hứa của NSManagedObjectModel.

Trong quá trình di chuyển, Core Data sẽ thực hiện lời hứa này.

NSManagedObjectModelReference linh hoạt và có thể được tạo theo nhiều cách khác nhau.

Mọi NSManagedObjectModelReference cần được khởi tạo với tổng kiểm tra phiên bản.

Điều này là để xác nhận mô hình đã không vô tình thay đổi.

Tổng kiểm tra có thể thu được bằng cách sử dụng phương thức NSManagedObjectModel .versionChecksum.

Ngoài ra, bạn có thể truy xuất tổng kiểm tra phiên bản từ nhật ký xây dựng Xcode trong "Mô hình dữ liệu biên dịch". Tìm kiếm chuỗi "tổng kiểm tra phiên bản". Đối với các mô hình có phiên bản, tổng kiểm tra cũng có sẵn trong VersionInfo.plist của gói NSManagedObjectModel.

Quay trở lại ví dụ, để bắt đầu sử dụng di chuyển theo giai đoạn, tôi sẽ bắt đầu bằng cách tạo các tham chiếu mô hình cho mỗi trong ba mô hình.

Tôi đang sử dụng trình khởi tạo chấp nhận tên mô hình và tham chiếu gói, nhưng cũng có các tùy chọn khác.

Bước tiếp theo là mô tả các giai đoạn di chuyển cần thiết.

Vì giai đoạn đầu tiên chỉ thêm thuộc tính flightData, có thể được biểu diễn trong giai đoạn nhẹ, vì việc thêm thuộc tính là một thay đổi nhẹ.

Tuy nhiên, giai đoạn tiếp theo sẽ là giai đoạn tùy chỉnh vì các thay đổi mô hình đã được phân tách thành hai phiên bản mô hình và chúng tôi cần chạy mã tùy chỉnh để bảo toàn dữ liệu hiện có.

Giai đoạn di chuyển tùy chỉnh được khởi tạo với ModelV2 và ModelV3.

Trong willMigrateHandler, mã tìm nạp các hàng thực thể trong đó flightData không phải là số không.

Các loại NSManagedObject và NSFetchRequestResult chung đang được sử dụng thay vì lớp con đối tượng được quản lý bởi Máy bay do thực tế là lớp Máy bay có thể không tồn tại như mong đợi trong quá trình di chuyển.

Đối với mỗi thực thể Máy bay được tìm nạp, dữ liệu được sao chép vào một phiên bản mới của FlightData và hai thực thể có liên quan và tồn tại.

Khi kết thúc quá trình thực hiện giai đoạn di chuyển này, lược đồ cửa hàng được cập nhật lên mô hình mới nhất và dữ liệu hiện có đã được giữ nguyên.

Để hoàn thành việc di chuyển theo giai đoạn, tôi tạo một NSStagedMigrationManager với giai đoạn di chuyển nhẹ và giai đoạn di chuyển tùy chỉnh.

NSStagedMigrationManager được thêm vào các tùy chọn NSPersistentStoreDescription với khóa NSPersistentStore StagedMigrationManagerOptionKey.

Các cửa hàng liên tục sau đó được tải để bắt đầu quá trình di chuyển và ảnh hưởng đến lược đồ cửa hàng.

Và thế là xong.

Dữ liệu cốt lõi sẽ tự động áp dụng các giai đoạn cần thiết và di chuyển lược đồ cửa hàng.

Một số di chuyển nhẹ yêu cầu thời gian chạy bổ sung mà ứng dụng của bạn có thể không cung cấp ở phía trước.

Quá trình chuyển đổi dữ liệu người dùng trong quá trình di chuyển nhẹ không phải là tức thời.

Ví dụ, nếu việc di chuyển liên quan đến việc sao chép dữ liệu từ cột này sang cột khác hoặc bảng này sang bảng khác, có thể mất một thời gian.

Điều này có thể dẫn đến trải nghiệm người dùng khó chịu, đặc biệt nếu việc di chuyển được thực hiện tại thời điểm khởi chạy.

Di chuyển hoãn lại có thể giúp bạn giải quyết vấn đề này.

API này sẽ cho phép bạn trì hoãn một số công việc được thực hiện trong quá trình di chuyển nhẹ với khả năng hoàn thành công việc bị trì hoãn vào một ngày sau đó.

Trong quá trình di chuyển nhẹ, nếu một thực thể có chuyển đổi di chuyển yêu cầu dọn dẹp, chẳng hạn như cập nhật chỉ mục hoặc thả một cột sau khi thực hiện sao chép bảng, chuyển đổi bảng này có thể bị trì hoãn cho đến khi bạn cho rằng các tài nguyên có sẵn để thực hiện chuyển đổi bảng.

Sự di chuyển nhẹ vẫn đồng bộ và xảy ra bình thường.

Chỉ có việc dọn dẹp lược đồ được hoãn lại.

Ứng dụng của bạn sẽ sử dụng lược đồ mới nhất như bình thường.

Để chọn tham gia di chuyển hoãn lại, hãy đặt NSPersistentStore DeferredLightweightMigrationOptionKey trong các tùy chọn cửa hàng thành true.

API di chuyển bị trì hoãn có khả năng tương thích thời gian chạy trở lại macOS Big Sur và iOS 14.

Di chuyển hoãn chỉ khả dụng cho các loại cửa hàng SQLite.

Một số ví dụ về nơi di chuyển hoãn có thể hữu ích bao gồm: Xóa các thuộc tính hoặc mối quan hệ khỏi một thực thể, thay đổi các mối quan hệ trong đó hệ thống phân cấp thực thể không còn tồn tại và thay đổi các mối quan hệ từ được sắp xếp thành không có thứ tự.

Để hoàn thành các tác vụ di chuyển bị trì hoãn, hãy kiểm tra siêu dữ liệu lưu trữ liên tục.

Nếu nó chứa khóa NSPersistentStore DeferredLightweightMigrationOptionKey, đó là tín hiệu cho bạn rằng có công việc di chuyển hoãn cần được hoàn thành.

Việc di chuyển bị trì hoãn có thể được xử lý bằng cách gọi NSPersistentStoreCoordinator .finishDeferredLightweightMigration.

Để trì hoãn bất kỳ việc di chuyển nhẹ nào trong ứng dụng của bạn, hãy đặt NSPersistentStoreDeferred LightweightMigrationOptionKey thành true trong các tùy chọn cửa hàng của bạn khi thêm cửa hàng liên tục vào điều phối viên.

Khi đây là thời điểm tốt để hoàn thành việc di chuyển hoãn lại, bạn có thể kiểm tra xem liệu có công việc hoãn lại đang chờ xử lý hay không bằng cách kiểm tra siêu dữ liệu cho cửa hàng.

Nếu NSPersistentStoreDeferredLightweight MigrationOptionKey được đặt thành true, thì hãy gọi finishDeferredLightweightMigration().

Để lên lịch các tác vụ di chuyển bị trì hoãn của bạn, hãy cân nhắc sử dụng API Nhiệm vụ Nền.

BGProcessingTask dành cho các hoạt động tốn thời gian như cập nhật dữ liệu lâu dài và bảo trì ứng dụng.

Hệ thống sẽ xác định thời điểm tốt nhất để thực hiện nhiệm vụ của bạn.

Tuy nhiên, nói chung các tác vụ xử lý chỉ chạy trên thiết bị khi nó không hoạt động và sẽ chấm dứt bất kỳ tác vụ xử lý nền nào khi người dùng bắt đầu sử dụng thiết bị.

Di chuyển hoãn lại và theo giai đoạn có thể được kết hợp.

Nếu bạn có một tập hợp các di chuyển phức tạp có thể mất một lúc, hãy cân nhắc thiết kế các giai đoạn tận dụng cả hai khả năng của API.

Quay trở lại mô hình ví dụ, trong ModelV3, nơi chúng tôi xóa thuộc tính flightData, điều này có thể tạo ra một ứng cử viên di chuyển hoãn lại tốt.

Có ba công nghệ mới tuyệt vời trong Core Data.

Đóng gói các loại dữ liệu tùy chỉnh của bạn theo cách lồng nhau, có cấu trúc bằng cách sử dụng các thuộc tính tổng hợp, thực hiện di chuyển mô hình phức tạp bằng cách di chuyển theo giai đoạn bằng cách phân tách các thay đổi mô hình của bạn và tăng tốc hiệu suất ứng dụng của bạn bằng cách trì hoãn một số công việc di chuyển bằng cách sử dụng di chuyển hoãn

Cả ba công nghệ đều hoạt động hài hòa để cải thiện ứng dụng của bạn.

Nhóm của chúng tôi rất vui khi biết cách bạn sử dụng những công nghệ mới này.

Cảm ơn vì đã xem, và chúc bạn có một WWDC tuyệt vời.

♪ ♪