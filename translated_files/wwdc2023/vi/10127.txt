10127

♪ ♪

Xin chào mọi người, tôi là Gauri Jog, và tôi làm việc trong nhóm Hệ sinh thái kim loại ở đây tại Apple.

Tôi rất vui được nói chuyện với bạn về việc tối ưu hóa trình kết xuất GPU bằng Metal.

Các ứng dụng và công cụ trò chơi tạo nội dung kỹ thuật số hiện đại trao quyền cho người sáng tạo nội dung tương tác tạo và sửa đổi tài liệu cho tài sản 3D của họ.

Có một số kỹ thuật phổ biến để xử lý các vật liệu phức tạp và năng động này trong thời gian chạy.

Một số ứng dụng biên dịch tài liệu thành các bộ đổ bóng riêng lẻ và những ứng dụng khác sử dụng các giải pháp dựa trên dữ liệu như bộ đổ bóng uber hoặc máy ảo đổ bóng.

Những quy trình làm việc lấy vật liệu làm trung tâm này có hai mục tiêu hiệu suất chính.

Tác giả của tài liệu phải đáp ứng nhanh chóng và trải nghiệm tốt nhất.

Hiệu suất kết xuất phải tốt nhất có thể cho tính tương tác thời gian thực và kết xuất khung hình cuối cùng hiệu quả.

Trong bản trình diễn Blender 3D này, chỉnh sửa tài liệu đáp ứng.

Khi bạn sửa đổi thanh trượt vật liệu trong giao diện người dùng, kết quả sẽ được hiển thị ngay lập tức trong khung nhìn mà không bị giật do biên dịch lại đổ bóng.

Sau khi tài liệu được sửa đổi, hiệu suất kết xuất kết quả sẽ nhanh chóng và tương tác, mang đến cho người sáng tạo nội dung khả năng xem hiệu quả kết quả công việc của họ.

Để đạt được quy trình làm việc đáp ứng và hiệu quả trong ứng dụng của bạn, bạn có thể tận dụng các tính năng chính của Metal và triển khai các phương pháp hay nhất của Metal.

Metal có thể giúp bạn tối đa hóa hiệu suất của các bộ đổ bóng phức tạp tận dụng biên dịch không đồng bộ để giữ cho ứng dụng đáp ứng, biên dịch nhanh hơn với liên kết động và điều chỉnh bộ đổ bóng tính toán của bạn với các tùy chọn trình biên dịch Metal mới.

Tối ưu hóa bộ đổ bóng của bạn là chìa khóa cho hiệu suất.

Bộ đổ bóng uber là một ví dụ về bộ đổ bóng dài và phức tạp có thể được sử dụng để hiển thị bất kỳ vật liệu nào có thể.

Những loại đổ bóng này có rất nhiều nhánh cho bất kỳ sự kết hợp nào có thể.

Khi các nghệ sĩ tạo ra vật liệu, các thông số vật liệu được lưu trữ trong bộ đệm Kim loại, được sử dụng bởi bộ đổ bóng vật liệu.

Bộ đệm này được cập nhật khi bạn thay đổi các tham số, nhưng không cần biên dịch lại.

Cách tiếp cận này cung cấp trải nghiệm tác giả đáp ứng tuyệt vời.

Tuy nhiên, bộ đổ bóng uber không phải là tối ưu vì chúng phải tính đến tất cả các tùy chọn có thể.

Để tạo ra biến thể đổ bóng tối ưu nhất, bạn nên sử dụng chuyên môn hóa kim loại với các hằng số hàm.

Chỉ cần khai báo các hằng số hàm trong bộ đổ bóng kim loại của bạn và đặt giá trị của chúng trong thời gian chạy khi chúng được thay đổi.

Nội dung bộ đệm vật liệu chỉ đơn giản là trở thành hằng số trong trạng thái đường ống đổ bóng của bạn, phân nhánh động được loại bỏ.

Các vật liệu chuyên dụng mang lại cho bạn hiệu suất cao nhất.

Đây là so sánh dữ liệu hiệu suất thời gian thực từ hai tài sản thử nghiệm phổ biến trong Blender 3D, Wanderer và Tree Creature.

Đầu tiên là hiệu suất cơ bản trong khung hình trên giây của các cảnh bằng cách sử dụng bộ đổ bóng uber.

Thứ hai là cách tiếp cận đổ bóng chuyên biệt với các hằng số hàm hoạt động nhanh hơn nhiều.

Để tạo ra biến thể đổ bóng chuyên dụng nhanh nhất, hãy sử dụng hằng số chức năng để vô hiệu hóa các tính năng không sử dụng và loại bỏ sự phân nhánh.

Bộ đổ bóng uber sẽ truy vấn các tham số vật liệu từ bộ đệm thực hiện các nhánh có điều kiện trong thời gian chạy để bật và tắt các tính năng.

Với các hằng số hàm, bạn khai báo một hằng số cho mỗi tính năng vật liệu.

Bây giờ nhánh động cho đường dẫn mã tính năng được thay thế bằng hằng số hàm, loại bỏ tất cả mã không sử dụng.

Đây là cùng một trình đổ bóng uber hiện đang sử dụng hằng số hàm.

Trình biên dịch Metal có thể gấp chúng dưới dạng booleans liên tục và xóa mã không sử dụng.

Các biểu thức nhánh giải quyết thành sai sẽ được tối ưu hóa, chỉ để lại các nhánh thực.

Tất cả các luồng điều khiển không sử dụng đều được tối ưu hóa.

Bộ đổ bóng chuyên dụng hiện không cần truy vấn dữ liệu vật liệu, có luồng điều khiển đơn giản hơn nhiều.

Tải bộ nhớ và các nhánh đã bị loại bỏ dẫn đến hiệu suất thời gian chạy nhanh hơn.

Chuyên môn hóa chức năng cũng giúp gấp các hằng số.

Các thông số vật liệu không thay đổi được thay thế bằng các hằng số.

Vật liệu ví dụ này sử dụng một tập hợp các thông số đầu vào từ bộ đệm Kim loại.

Các thông số có thể là màu sắc, trọng lượng, màu sáng và nhiều hơn nữa.

Tại thời điểm tạo vật liệu, các tham số tĩnh này có thể được thay thế bằng các hằng số hàm.

Các hằng số hàm tạo ra mã tối ưu nhất mà không cần đọc bộ đệm.

Ở phía máy chủ, các giá trị hằng số hàm được cung cấp khi tạo trạng thái đường ống chuyên biệt.

Cấu trúc MaterialParameter có thể được sử dụng để biểu diễn tất cả các tham số không đổi cho một vật liệu.

IsGlossy là một ví dụ về tính năng vật liệu boolean cờ kiểm soát độ bóng.

MaterialColor là một ví dụ về tham số vectơ được sử dụng để mô tả màu sắc.

Để tạo một Đối tượng Trạng thái Đường ống chuyên dụng, hãy lặp lại bộ MetalFunctionConstantValues và chèn các giá trị bằng cách sử dụng setConstantValue.

Sau đó chỉ cần tạo một Render Pipeline như bình thường.

Sự khác biệt duy nhất là khi tạo hàm phân đoạn, bạn sẽ sử dụng biến thể của newFunctionWithName với constantValues.

Cuối cùng, tạo Đối tượng Trạng thái Đường ống của bạn.

Bộ đổ bóng kết quả là biến thể hoạt động tối ưu nhất của vật liệu này.

Luôn sử dụng phần Hiệu suất gỡ lỗi GPU của Xcode để xác nhận tác động của việc sử dụng hằng số hàm.

Bộ đổ bóng uber ban đầu cho thấy một số lượng lớn các hướng dẫn ALU và một lượng lớn sự cố tràn.

Số lần chờ bộ nhớ cũng rất lớn.

Cách tiếp cận chuyên biệt giúp giảm đau ngay lập tức cho ALU và sự cố tràn dầu.

Điều này là do loại bỏ mã chết và gấp các hằng số.

Ngoài ra, số lần chờ bộ nhớ nhỏ hơn đáng kể.

Quan sát bộ đổ bóng uber ban đầu trong chi phí thực thi bộ đổ bóng thời gian chạy, GPU đang dành thời gian đáng kể để chờ bộ nhớ.

Ngược lại, cách tiếp cận chuyên biệt dành ít thời gian hơn cho việc chờ đợi bộ nhớ, cho phép sử dụng ALU hiệu quả hơn, cùng với các lợi ích hiệu quả khác.

Trong chế độ xem dòng thời gian Trình gỡ lỗi GPU, phải mất 58 mili giây để hiển thị vật liệu vượt qua bằng cách sử dụng đổ bóng uber.

Và chỉ 12,5 mili giây để kết xuất với các phiên bản chuyên biệt.

Đó là một sự cải tiến khá đáng kể.

Chuyên môn hóa vật liệu yêu cầu biên dịch đổ bóng thời gian chạy và điều này thường sẽ dẫn đến việc quá giang nếu bạn chặn và đợi các tài liệu chuyên biệt này được tạo.

Các API biên dịch không đồng bộ Metal cho phép bạn sử dụng các bộ đổ bóng uber chung và giữ cho trải nghiệm người dùng tương tác và đáp ứng trong khi tạo các phiên bản chuyên biệt trong nền.

Để chọn tham gia tạo trạng thái đường ống không đồng bộ, hãy cung cấp trình xử lý hoàn thành.

Những cuộc gọi này sẽ quay lại ngay lập tức cho phép bạn giữ cho trải nghiệm người dùng tương tác và đáp ứng.

Trình xử lý hoàn thành sẽ được gọi khi trạng thái đường ống chuyên dụng sẵn sàng và bạn có thể chuyển sang bộ đổ bóng tối ưu ngay lập tức.

Đây là sơ đồ của quy trình làm việc vật liệu không đồng bộ.

Theo mặc định, khi vật liệu chưa được chuyên biệt hóa, bạn sử dụng bộ đổ bóng uber của mình.

Đồng thời, Metal biên dịch bộ đổ bóng chuyên dụng trong nền.

Sau khi hoàn thành việc này, bạn có thể chuyển bộ đổ bóng uber cho vật liệu chuyên dụng nhanh chóng.

Bộ sưu tập Runtime Metal shaders được thiết kế để cung cấp mức độ song song cân bằng.

Tuy nhiên, các ứng dụng tạo nội dung hiện đại cần cung cấp quy trình chỉnh sửa đa vật liệu, dẫn đến nhiều lần biên dịch lại đổ bóng.

Để giúp đỡ nhu cầu tác giả nặng nề như vậy, bạn có thể muốn yêu cầu Metal tối đa hóa tính song song biên dịch đổ bóng.

Thiết bị kim loại có một thuộc tính mới trong macOS13.3 được gọi là should-Maximize-Concurrent-Compilation.

Khi bạn đặt nó thành Có, trình biên dịch Metal sẽ tận dụng tốt nhất các lõi CPU của bạn.

Tối đa hóa biên dịch đồng thời thực sự tuyệt vời cho quy trình làm việc của tác giả đa tài liệu.

Với các công việc biên dịch bổ sung có sẵn, các biến thể vật liệu chuyên biệt có sẵn sớm hơn nhiều.

Đây là cách tất cả hoạt động trong thực tế.

Khi các thông số vật liệu được thay đổi, các biến thể chuyên biệt hiện tại của vật liệu bị vô hiệu hóa, có một công tắc quay trở lại sử dụng bộ đổ bóng uber để giữ cho chất lỏng tác giả.

Một công việc không đồng bộ mới được xếp hàng đợi và khi hoàn thành, bạn có thể quan sát thấy sự cải thiện hiệu suất đáng kể sau khi tài liệu chuyên dụng được tham gia.

Hầu hết các ứng dụng hiện đại đều có các vật liệu cực kỳ phức tạp, vì vậy có thể mất một khoảng thời gian đáng kể để một biến thể chuyên dụng sẵn sàng.

Các thư viện động trong Metal có thể được sử dụng để biên dịch trước các chức năng tiện ích và giảm thời gian biên dịch tài liệu tổng thể.

Bạn làm điều này bằng cách chia các nhóm chức năng thành các thư viện động riêng biệt.

Để biên dịch thời gian chạy nhanh hơn, các thư viện tiện ích có thể được biên dịch trước ngoại tuyến.

Và cuối cùng bạn biên dịch ít mã hơn nhiều trong thời gian chạy.

Nếu tôi lấy bộ đổ bóng uber trước đó và chia nó thành các dylibs.

Một cách tiếp cận là chia nó theo các nhóm chức năng chung.

Trong trường hợp này, một thư viện tiện ích toán học và một thư viện khác cho các chức năng chiếu sáng.

Để làm cho các ký hiệu hàm hiển thị cho liên kết, bạn chỉ định khả năng hiển thị "mặc định".

Các biểu tượng cũng có thể bị ẩn khỏi các chương trình bên ngoài bằng cách gán khả năng hiển thị cho "ẩn".

Có hai thuộc tính để kiểm tra xem thiết bị Metal của bạn có hỗ trợ các thư viện động hay không.

Đối với các đường ống kết xuất, bạn nên sử dụng thuộc tính supportsRenderDynamicLibraries của thiết bị Metal.

Điều này hiện có sẵn trên các thiết bị có dòng GPU Apple6 trở lên.

Đối với các đường ống tính toán, bạn nên truy vấn thuộc tính supportsDynamicLibraries.

Cái này có sẵn trên Apple6 trở lên và cho hầu hết các dòng GPU Mac2.

Để tạo một thư viện động từ một thư viện Metal hiện có, chỉ cần gọi newDynamicLibrary và chuyển nó thành thư viện Metal.

Để tạo từ URL, hãy gọi phương thức newDynamicLibraryWithURL và cung cấp đường dẫn đến thư viện động được lưu trữ.

Bạn có thể biên dịch trước các thư viện động ngoại tuyến bằng cách sử dụng chuỗi công cụ biên dịch kim loại.

Khi tải các thư viện động được biên dịch trước trong thời gian chạy, việc biên dịch hoàn toàn tránh được.

Để chỉ định dylibs trong giai đoạn liên kết: chuyển một mảng các Đối tượng Thư viện Động Kim loại vào các tham số Thư viện được tải sẵn trên bộ mô tả đường ống.

Ngoài ra còn có tùy chọn cung cấp mảng thư viện động này thông qua Tùy chọn biên dịch kim loại khi biên dịch các thư viện đổ bóng khác.

Di chuyển các phần lớn mã tiện ích vào các thư viện động rút ngắn đáng kể thời gian chạy biên dịch.

Và cuối cùng, việc điều chỉnh các tùy chọn trình biên dịch thực sự quan trọng đối với các trường hợp tính toán như truy tìm đường dẫn trong kết xuất chất lượng sản xuất cuối cùng.

Và có một tính năng Metal bổ sung để tận dụng tối đa hiệu suất trong kết xuất cuối cùng của bạn.

Các tùy chọn trình biên dịch kim loại và gợi ý chiếm chỗ, cho phép bạn điều chỉnh hiệu suất của bất kỳ hạt nhân tính toán nào trong số này một cách cụ thể khi làm việc với liên kết động.

Mọi khối lượng công việc GPU đều có một điểm ngọt ngào về hiệu suất cần phân tích và đánh giá.

Có một Metal API để nhắm mục tiêu công suất GPU mong muốn, hiện cũng có sẵn cho các thư viện động.

Điều này có thể mở khóa hiệu suất cho khối lượng công việc hiện có mà không cần thay đổi mã hoặc thuật toán gốc.

Điều đáng chú ý là bất kỳ điều chỉnh nào cũng cần được thực hiện trên mỗi thiết bị vì các đặc tính hiệu suất có thể khác nhau tùy thuộc vào kiến trúc GPU.

Thuộc tính mô tả đường ống tính toán Metal cho phép bạn thể hiện mức chiếm dụng mong muốn bằng cách chỉ định giá trị Max-Total-Threads-Per-Threadgroup.

Giá trị càng cao, bạn gợi ý trình biên dịch càng nhắm đến công suất cao.

Bây giờ, sử dụng thuộc tính Metal-Compile-Options mới này cho các thư viện động, bạn có thể khớp với mức độ lấp đầy mong muốn của đối tượng trạng thái đường ống.

Max-Total-Threads-Per-Threadgroup có sẵn cho MetalCompileOptions trong iOS 16.4 và macOS 13.3.

Bây giờ bạn có thể chỉ cần kết hợp công suất mong muốn của Pipeline State Object trong khi điều chỉnh các thư viện động Metal để có hiệu suất tối ưu.

Biểu đồ này của hiệu suất hạt nhân tính toán giao điểm và đổ bóng của Blender Cycles cho thấy tác động của việc thay đổi Max-Total-Threads-Per-Threadgroup.

Đó là biến duy nhất được thay đổi cho đối tượng trạng thái đường ống và dylibs.

Trong trường hợp này, có một điểm ngọt ngào nơi hạt nhân hoạt động tốt nhất.

Mỗi khối lượng công việc và thiết bị là duy nhất và giá trị tối ưu của Max-Total-Threads-Per-Threadgroup khác nhau tùy thuộc vào bản chất của hạt nhân.

Giá trị tối ưu không phải lúc nào cũng nhất thiết phải là số lượng luồng tối đa trên mỗi nhóm luồng mà GPU hỗ trợ.

Thử nghiệm với hạt nhân của bạn để tìm giá trị tối ưu mà bạn muốn sử dụng và nướng trong mã.

Đây là hạt nhân tô bóng Blender Cycles, số liệu thống kê trình biên dịch chứng minh rằng hạt nhân rất phức tạp.

Có một số thông số ảnh hưởng đến thời gian chạy thực tế.

Lượng tràn, số lượng thanh ghi được sử dụng và các hoạt động khác như tải bộ nhớ.

Bằng cách điều chỉnh Max-Total-Threads-Per-Threadgroup, bạn có thể thay đổi công suất mục tiêu và tìm thấy điểm ngọt ngào về hiệu suất đó.

Sau khi tìm thấy điểm ngọt ngào, sự cố tràn tăng lên một chút, nhưng tăng công suất lấp đầy tổng thể đã dẫn đến hiệu suất hạt nhân tốt hơn đáng kể.

Trình theo dõi đường dẫn Cycles trong Blender 3D 3.5 hiện đã được tối ưu hóa tốt cho Metal và nó sử dụng tất cả các phương pháp hay nhất mà tôi đã đề cập ngày hôm nay.

Hãy nhớ tối đa hóa hiệu suất đổ bóng của các bộ đổ bóng lớn và phức tạp bằng cách sử dụng chuyên môn hóa chức năng, sử dụng biên dịch không đồng bộ để giữ cho ứng dụng đáp ứng dụng trong khi tạo các bộ đổ bóng được tối ưu hóa trong nền, cho phép liên kết động để biên dịch nhanh hơn trong thời gian chạy và điều chỉnh hạt nhân tính toán của bạn

Hãy chắc chắn kiểm tra các phiên trước, nơi bạn có thể học cách mở rộng quy mô khối lượng công việc tính toán cho GPU của Apple và khám phá thêm quy trình biên dịch trong Metal.

Cảm ơn bạn đã xem.

♪ ♪