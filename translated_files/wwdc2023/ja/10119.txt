10119

♪まろやかなインストゥルメンタルヒップホップ♪

♪

デビッド・ジョンソン:皆さん、こんにちは。

「Safari拡張機能の新機能」へようこそ。

私の名前はデビッド・ジョンソンで、ここアップルのSafari拡張機能エンジニアです。

今日は、ユーザーエクスペリエンスと新機能の改善を強調して、Safari拡張機能の最近の開発についてお伝えできることを嬉しく思います。

まず、今日App Storeで利用可能な2000以上のSafari拡張機能を作成して共有していただきありがとうございます。

iOSのSafari拡張機能の需要は特に印象的でした。

彼らはしばしば、WWDC21で導入されて以来、App Storeのトップカテゴリの1つです。

拡張機能により、ユーザーはmacOS、iOS、iPadOSでブラウジング体験をカスタマイズできます。

Safari拡張機能を構築するには、コンテンツブロッカー、共有拡張機能、アプリ拡張機能、ウェブ拡張機能の4つの方法があります。

Safari 17はこれらのタイプをすべてサポートし続けていますが、ブラウザのカスタマイズの未来はウェブ拡張機能にあります。

Appleは、他の主要なブラウザベンダーと一緒にウェブ拡張機能を標準化することに専念しています。

このコラボレーションは、互換性を向上させ、開発を合理化し、すべてのブラウザで使い慣れた体験を確保することを目的としています。

私たちは、Appleが誇らしげに共同議長を務めるW3C WebExtensionsコミュニティグループで協力しています。

他のブラウザや拡張機能開発者と接続して、この標準化の取り組みを推進することで、より強力で統一されたWeb拡張機能エコシステムを構築しています。

今日のトピックに飛び込む前に、Safariのウェブ拡張機能に関する2つの重要な詳細を共有したいと思います。

まず、Safari 17はマニフェストv2とv3の両方のウェブ拡張機能を引き続きサポートします。

マニフェストv3に新機能を追加し続けますので、拡張機能に意味のあるときに更新してください。

第二に、ウェブ拡張機能は、プラットフォーム間でSafariの拡張機能を構築するための最良の方法です。

単一の共有コードベースで、Web拡張機能を使用すると、iOS、iPadOS、macOS、およびxrOSでSafariの機能をカスタマイズできます。

そうです、iOSとiPadOSで利用可能なウェブ拡張機能はxrOSでも利用できるようになります。

xrOSのWeb拡張機能は、期待どおりに機能し、スクリプトを注入したり、バックグラウンドコンテンツを実行したり、ポップオーバーを表示したりする機能など、iOSの拡張機能と同じ機能を備えています。

拡張機能がxrOSでのブラウジング体験をどのように強化するかを楽しみにしています。

xrOSのSafariの詳細については、「Meet Safari for xrOS」をご覧ください。

これらの発表が邪魔にならないように、今日のセッションの残りの部分で取り上げるものは次のとおりです。

まず、いくつかの新しく更新された拡張機能APIと、それらがSafari拡張機能の機能をどのように強化するかを掘り下げます。

次に、Safariアプリ拡張機能のサイトごとのアクセス許可をカバーし、ユーザーがブラウジング体験をより詳細に制御できるようにします。

そして最後に、Safariプロファイルとプライベートブラウジングの両方との互換性を確保する方法を見ていきます。

まず、新しい拡張API。

コンテンツブロッカーは、Webページをクリーンアップし、迷惑を取り除き、スクリプトの読み込みをブロックするのに最適な方法です。

コンテンツブロッカーは、JSONで定義されたルールを使用して、訪問されたウェブサイトに関する情報にアクセスすることなく、コンテンツをブロックまたは非表示にします。

ウェブページ上のコンテンツを宣言的に隠すのは難しい場合があります。

そのため、コンテンツブロッカーは:has()セレクタをサポートするようになりました。

:Has()セレクタは、コンテンツブロッカーが子に基づいて親要素を正確にターゲットにできるため、素晴らしいです。

このルール例では、クラス .paid-promo の子要素を持つクラス .post を持つ要素を非表示にしています。

ウェブページのコンテンツを非表示にしたり、ネットワーク要求をブロックしたりする拡張機能は、最も一般的なタイプの拡張機能の一部です。

そのため、Safariは、ユーザーに安全でプライベートなブラウジング体験を提供する革新的で効果的な拡張機能の作成を引き続きサポートしています。

Web拡張機能を使用してネットワーク要求をブロックまたは変更する場合は、宣言型ネット要求のこれらの更新を確認する必要があります。

Declarative Net Requestは、Web拡張機能がネットワーク要求をブロックおよび変更する方法を提供する強力なAPIです。

コンテンツブロッカーと同様に、拡張機能はJSON形式でルールを提供し、Safariは残りを処理します。

これは、特にバッテリー駆動のデバイスでの電力効率の向上を意味します。

これらのルールは宣言的であるため、拡張機能はユーザーが訪問したウェブページにアクセスする必要がなく、プライバシーとセキュリティが向上します。

Safari 16.4の宣言型ネットリクエストの大きなアップデートの1つは、拡張機能がリクエストヘッダーを変更できるようになったことです。

この例では、example.comへのすべてのリクエストに対してカスタムユーザーエージェントヘッダーを設定するアクションを定義しました。

ヘッダーの設定以外にも、このアクションタイプは、新しい値を追加したり、既存の値を削除したり、HTTPリクエストからヘッダーを完全に削除したりして、ヘッダーを変更できます。

ネットワーク要求の変更は強力なツールであり、心に留めておくべき重要なポイントがいくつかあります。

まず、マニフェストでdeclarativeNetRequestWithHostAccess権限を宣言する必要があります。

Safari 16.4では、この許可はリダイレクトアクションにも必要になりました。

また、拡張機能は、変更ヘッダーやリダイレクトアクションを適用するためのサイトごとの権限を付与する必要があります。

これにより、ユーザーはサイトごとにデータを制御できます。これにより、ユーザーはサイトごとにデータを管理できます。

これらの考慮事項を念頭に置いて、ユーザーに合わせたエクスペリエンスを提供する強力でプライバシーに優しいコンテンツブロック拡張機能を作成できます。

Declarative Net Requestを使用する拡張機能を構築する場合は、ブロックしたリクエストの数をユーザーに知らせることをお勧めします。

新しい declarativeNetRequest.setExtensionActionOptions API を使用して、ブロックされたロードの数などのアクション数を表示するようにバッジテキストを設定できます。

この例では、displayActionCountAsBadgeTextオプションをtrueに設定しました。これは現在、このAPIの唯一のオプションです。

拡張バッジは、実行したアクションに基づいて自動的に更新されます。

これにより、ユーザーは閲覧履歴を非公開にしながら、拡張機能のアクティビティと有効性を簡単に監視できます。

次に、拡張機能の動作をより詳細に制御できるスクリプトAPIの更新について説明します。

APIのregisterContentScriptセットを使用すると、プログラムで登録、更新、または削除できるコンテンツスクリプトを作成できます。

これは、コンテンツスクリプトに適用する特定のページや条件をターゲットにできることを意味します。

この例では、webkit.orgに一致するページに注入するスクリプトを登録しています。

このスクリプトの登録は、セッション間も持続します。

この新しいAPIは、拡張機能マニフェストで定義された静的コンテンツスクリプトを補完し、コンテンツスクリプトの管理に柔軟性を高め、拡張機能のより高度な機能を作成できるようにします。

Safari 16.4はまた、ウェブ拡張機能に新しいストレージエリアをもたらします:セッションストレージエリア。

セッションストレージからデータを保存および取得するには、他のストレージ領域と同じ使い慣れた機能を使用します。

このAPIを使用すると、ブラウザセッションの期間中、データをメモリに保存でき、非永続的なバックグラウンドページの読み込み間でデータにアクセスするための迅速かつ効率的な方法を提供します。

ローカルストレージとは異なり、セッションストレージはディスクに保持されず、Safariが終了するとクリアされます。

これにより、セッションストレージは、ローカルストレージに保存すべきではない復号化キーや認証トークンなどの機密データやセキュリティ関連のデータを格納するのに特に役立ちます。

最後に、拡張機能にさまざまなUI要素に適したアイコンサイズがすべて揃っていることを確認するのは面倒です。

そのため、Safari 16.4から、どのサイズでも美しく見える単一のSVGアイコンを作成できるようになりました。

Safariは、拡張機能のアイコンを急激にスケーリングし、他のすべてに集中できるようにします。

これらのAPIアップデートは、今年のSafari拡張機能の改善のほんの一部です。

それでは、Safariアプリの拡張機能とサイトごとのアクセス許可について話しましょう。

Web拡張機能からのサイトごとのアクセス許可にすでに精通している場合は、アプリ拡張機能でも同じように機能します。

ユーザーは、閲覧時のウェブサイトへの拡張アクセスを許可することができ、より良いプライバシーと制御を提供します。

拡張機能が最初にオンになると、ユーザーが訪問したサイトにアクセスできなくなります。

拡張機能が初めてページにアクセスしようとすると、Safariは拡張機能のツールバー項目にバッジを付け、拡張機能が現在のページにアクセスしたいことをユーザーに警告します。

ユーザーがそのツールバー項目をクリックすると、拡張機能が持つアクセスに関する情報が表示され、1日許可するか、または常に許可するオプションが表示されます。

許可が付与されると、拡張機能のツールバー項目は、拡張機能が現在のページにアクセスできることを示すために着色されます。

Safari 17にアップグレードし、すでにSafariアプリの拡張機能をオンにしている人は、それらの拡張機能のすべての権限が移行されます。

また、プライバシーを高めるオプションを提供するバナーも表示されます。

Ask for Each Websiteが選択されている場合、すべてのSafariアプリ拡張機能のアクセス許可がリセットされ、ユーザーは訪問した各サイトへの拡張機能へのアクセスを許可することができます。

Safari 17でこの変更をサポートするために採用する新しいAPIはありません。ただし、拡張機能の仮定を確認し、拡張機能がSafari 17でどのように動作するかをテストするにはしばらく時間がかかります。

ユーザーは、すべてのSafariアプリ拡張機能がアクセスできるウェブサイトを完全に制御できます。

ユーザーから許可が付与されると、拡張機能は自動的にサイトにアクセスできます。

ただし、許可はいつでも付与または取り消すことができます。

ツールバーの項目は、すべての拡張機能に対してデフォルトで表示されるようになりました。

拡張アイコンがSafariでどのように表示されるかを見て、適切に着色できるPDFベクターアイコンを提供してください。

最後に、プロファイルとプライベートブラウジングの両方で拡張機能がどのように機能するかの更新について話しましょう。

Safari 17では、ユーザーは、他のブラウジングコンテキストで拡張機能をオフにすることなく、プライベートブラウジングウィンドウとタブにアクセスできる拡張機能を制御できます。

スクリプトを注入する拡張機能、またはユーザーが訪問したページに関する情報を読み取ることができる拡張機能は、デフォルトでオフになっています。

ただし、コンテンツブロッカーなどのコンテンツにアクセスしない拡張機能は、追加のプライバシーに関する懸念がないため、プライベートブラウジングで自動的に許可されます。

これはmacOSのSafari設定で更新された拡張機能ペインで、iOSにも同様のアップデートがあります。

プライベートブラウジングでこの拡張を許可する新しいオプションがあります。

拡張機能がオンになっている場合は、Safariの設定でワンクリックで、その拡張機能のプライベートブラウジングへのアクセスも許可します。

プロフィールは今年Safariで新しく登場します。

それらはブラウジングデータを分離し続ける方法です。

プロフィールには、個別の履歴、クッキー、およびウェブサイトデータが含まれています。

ユーザーは、プロファイルごとにオンにする拡張機能を選択することもできます。

これには、新しいタブページの拡張機能が含まれます。

そしてもちろん、これらの設定はすべて、iCloudを介してユーザーのiPhone、iPad、Macのすべてで同期されます。

Safari設定の拡張機能ペインも更新され、拡張機能がアクティブなプロファイルが一覧表示されます。

ここでは、Sea Creatorの拡張機能が仕事と学校の両方のプロファイルでアクティブであることがわかります。

プロファイルで拡張機能がオンになっている場合、それはその拡張機能のまったく新しいインスタンスです。

これは、各インスタンスが異なるUUID、バックグラウンドページ、およびストレージを持つことを意味します。

ただし、サイトごとの権限はプロファイル間で共有されます。

つまり、ユーザーは拡張機能へのアクセスを一度だけ許可する必要があります。

プロファイルで実行する場合、拡張機能はそのプロファイルに関連するウィンドウ、タブ、およびその他のデータにのみアクセスできます。

拡張機能がネイティブホストアプリと通信する場合は、アプリが複数のプロファイルからメッセージを受信することを期待し、それらのプロファイル間のデータの分離を尊重していることを確認してください。

アプリが beginRequest(with context:)の呼び出しを受信すると、userInfo辞書をデコードします。

拡張機能がプロファイルでアクティブな場合、キーSFExtensionProfileKeyのprofileIdentifier値があります。

拡張機能はプロファイルごとに一意のインスタンスを持つため、バックグラウンドコンテンツを個別に検査することができます。

Safari 17の開発メニューから、Web拡張機能の背景コンテンツメニュー項目に飛び込んで、拡張機能ごとにグループ化された背景ページとサービスワーカーを見ることができます。

各拡張機能は、プロファイルごとに検査可能なコンテンツを一覧表示します。

今年のSafari開発者機能の改善の詳細については、「Web Inspectorの新機能」と「Safari開発者機能の再発見」をご覧ください。

要約すると、SafariはWeb拡張機能を標準化し、革新的で効果的な拡張機能を作成するための新しいAPIを提供することにコミットしています。

WECGに参加して、ディスカッションに参加して、ウェブ拡張機能の未来を形作るのを手伝ってください。

アプリ拡張機能のサイトごとの権限と、:has()セレクタなどの新機能のサポートにより、ユーザーに安全でプライベートなブラウジング体験を提供する拡張機能を作成できます。

これらの新機能を活用し、プロファイルとプライベートブラウジングの両方でうまく機能するように拡張機能を更新することを忘れないでください。

そして最後に、Safari 17で拡張機能をテストする際に、フィードバックアシスタントを通じてフィードバックを提供します。

聞いてくれてありがとう、そしてWWDCの素晴らしい残りをお過ごしください。

♪