10023

♪まろやかなインストゥルメンタルヒップホップ♪

♪

こんにちは、ようこそ。

私の名前はSirishaで、HealthKitチームのエンジニアです。

今日、App Storeには、ユーザーが健康になり、健康を維持するのに役立つ何百もの健康とフィットネスアプリがあります。

そして、それらすべてのために、HealthKitは一元化された暗号化されたデータベースを提供するので、あなたの素晴らしいアプリは、あなたのユーザーに彼らの健康データのまとまりのあるビューを表示することができます。

今、ワークアウトAPIはHealthKitが提供する最も強力なもののいくつかであり、私はそれらを愛しています。

今日のビデオでは、サイクリングのトレーニングを追跡するためのApple Watch用のサンプルサイクリングアプリを作成しました。

そして、より簡単にアクセスできるように、iPhoneをハンドルバーに取り付けてサイクリングコンピュータとして使用したいと思います。

そうすれば、ハンドルバーから手を離すことなく、Apple Watchに表示されるライブメトリクスをすばやく簡単に見ることができます。

HealthKitは、Apple WatchとiPhoneの間のアクティブなワークアウトセッションを制御およびミラーリングするための新しいワークアウトAPIを導入しています。

サイクリングの速度、パワー、ケイデンス、機能的しきい値パワー、またはFTPを追跡するための新しいデータタイプを追加して、サイクリングワークアウトのサポートを更新します。

そして、それが十分でなかった場合、HealthKitと健康アプリは現在iPad上にあります。

これで、iPadでiCloudアカウントにサインインした顧客は、HealthKitを介してiPadに同期された健康データが表示されます。

あなたが提供できるより豊かな健康とワークアウト後の経験を想像してみてください。

今日は、サンプルアプリを使って、ペアリングされたiPhoneでApple Watchで実行されているワークアウトをミラーリングする方法を実演します。

次に、新しいサイクリングメトリクスを収集し、デバイス間で同期する方法を示すコードを追加します。

そして、iPadでワークアウトを表示するために必要な承認の詳細をまとめます。

それでは、Apple Watch、iPhone、iPadがどのように連携して素晴らしいワークアウト体験を提供できるかを確認しましょう。

私の例では、私はApple Watchでワークアウトを実行しています。

ワークアウトセッションを集中型オブジェクトとして使用して、ライフサイクル、開始、一時停止、停止を管理しています。

ワークアウトセッションにまだ慣れていない場合は、以前の講演「ワークアウトで作業する新しい方法」と「Apple Watch用のワークアウトアプリを構築する」を見ることをお勧めします。

さて、iPhoneからワークアウトを制御するには、このワークアウトセッションをApple WatchからiPhoneに取得する必要があります。

これを行うには、HealthKitの新しいミラーリングセッションAPIを使用します。

Apple Watchでミラーリングされたセッションが開始されると、iPhoneアプリが実行されていない場合は、バックグラウンドで起動され、ワークアウトセッションが引き渡されます。

セッションを受けるには、私のiPhoneアプリの準備ができている必要があります。

だから、まず、HealthStoreを使用してiPhoneアプリの起動シーケンスでハンドラーを設定します。

そうすれば、私のApple Watchからセッションを受け取る準備が整います。

iPhoneアプリがフォアグラウンドまたはバックグラウンドで起動されるたびに、Apple Watchから渡されたアクティブなワークアウトセッションを受け取るために、ミラーリングスタートハンドラを実装します。

次に、アクティビティタイプのサイクリングでワークアウト構成を作成します。

次に、iPhoneアプリの既存のStart Watch App APIを呼び出すと、ペアリングされたApple Watchでアプリを起動し、ワークアウトの設定を渡します。

iPhoneから設定を受け取ると、Apple Watchアプリでワークアウトセッションを作成できます。

私のApple Watchのワークアウトセッションはプライマリセッションと呼ばれています。

そして、私のiPhoneのワークアウトセッションはミラーリングセッションと呼ばれています。

だから、これがその外観です。

iPhoneアプリでワークアウトを開始すると、Apple WatchのアプリがiPhoneから送信された設定で起動します。

これまでのところ、とても良いです。

今、このAPIをとても便利にしているのは、HealthKitがプライマリとミラーリングされたセッション状態の両方を同期させるということです。

たとえば、Apple Watchでプライマリセッションが一時停止されると、iPhoneのミラーリングされたセッションも一時停止されます。

アクティブなワークアウトセッションのコピーをiPhoneに取得することに加えて、HealthKitは両方のデバイス間で関連するワークアウトデータを交換するための新しいAPIを提供し、アクティビティを開始および終了したり、イベントを生成したりする機能も提供します。

さて、プライマリセッションの準備が整い、iPhoneがハンドラーを受け取る準備ができたので、startMirroringToCompanionDeviceに電話してApple Watchからミラーリングを開始し、プライマリセッションを開始します。

Apple WatchでstartMirroringを呼び出すと、HealthKitはコンパニオンiPhoneアプリをバックグラウンドで起動し、アプリに10秒でライブアクティビティを開始し、ハンドラーに電話してミラーリングを開始します。

素晴らしい、私たちはApple Watchでセッションを開始し、iPhoneでコピーを手に入れました。

さて、セッション状態がデバイス間でどのように通信されるかをお見せしましょう。

私の例のアプリでは、セッションが実行中、一時停止中など、ワークアウトセッションの状態をユーザーに表示したいと考えています。

そこで、セッション状態の更新と生成されたイベントを監視するために、Apple WatchとiPhoneでセッションデリゲートを設定します。

iPhoneアプリで取得したミラーリングされたセッションへの参照を保持することが重要であることを覚えておいてください。

Apple WatchでstartActivityを呼び出すと、プライマリセッションが開始され、セッションの状態が実行中に変更されます。

この状態の更新は、プライマリセッションのセッションデリゲートとして設定されているため、私のApple Watchアプリに配信されます。

私のiPhoneのアプリも、ミラーリングされたセッションデリゲートを通じて状態を更新します。

アクティブなワークアウトセッションをiPhoneに持ち込み、セッションの変更を監視するのはとても簡単です。

だから、これがそのように見えます。

Apple Watchでワークアウトセッションが開始されると、iPhoneとApple Watchの一時停止ボタンがアクティブになり、ワークアウトセッションが実行中であることを示します。

プライマリセッションとミラーリングセッションの間でセッション状態を同期するだけでなく、一時停止や再開などのイベントを生成して送信することもできます。

Apple Watchでワークアウトセッションを一時停止すると、Apple WatchアプリとiPhoneのミラーリングされたセッションの両方が、セッションデリゲートを通じて一時停止イベントについて通知されます。

そして、それはこのように見えます。

Apple Watchでワークアウトセッションを一時停止すると、両方のデバイスの再開ボタンがアクティブになります。

iPhoneでワークアウトセッションがあるので、iPhoneからもワークアウトをコントロールできます。

iPhoneでミラーリングされたセッションを再開すると、Apple Watchのプライマリセッションデリゲートに状態の変更が通知され、ミラーリングされたセッションデリゲートは再開イベントを受け取ります。

次に、サイクリング速度、パワー、ケイデンスなどの新しいデータタイプを含む、HealthKitが今年導入する新しいサイクリング機能を活用する方法を紹介したいと思います。心拍数モニターが心拍数データを健康データベースに収集して書き込む方法と同様に、これらのデータタイプを提供するように設計されたBluetoothデバイスに直接接続する新しい機能。そして最後に、Apple WatchのHealthKitがこれらのBluetoothデバイスから収集されたデータに基づいてFTPを自動的に

私の自転車には、パワーとケイデンスを収集するパワーメーターがあり、それをApple Watchとペアリングしました。

センサーは私のApple Watchにデータを書き込み、私は乗車中に表示されるようにそのデータをiPhoneに送信するためにアプリを拡張したいと思います。

これを行うには、まず、推奨されるワークアウトビルダーAPI beginCollectionを使用してサイクリングメトリクスの収集を開始します。

そして、sendData(toRemoteWorkoutSession) APIを使用してデータを送信します。

サイクリングメトリクスを送信するには、Apple WatchのBluetoothセンサーから受信した速度、ケイデンス、電力データをパッケージ化し、プライマリセッションでsendData(toRemoteWorkoutSession)を呼び出します。

その結果、iPhoneのミラーリングされたセッションデリゲートは、パッケージデータを含むdidReceiveDataFromRemoteDeviceコールを受信し、解凍してiPhoneに表示できます。

これは、私のApple Watchからサイクリングメトリクスを送信する私のサンプルアプリでどのように見え、それらが私のiPhoneアプリでどのように表示されるかです。

sendData(toRemoteWorkoutSession)を使用すると、iPhoneからApple Watchに反対方向にデータを送信することもできます。

私の例では、次の乗車のためのより良い水分補給計画を作成することを期待して、後で分析できるように、トレーニング中の水分摂取量を追跡したいと考えています。

これを行うには、ミラーリングされたセッションで消費した水の量を梱包してiPhoneからApple Watchに送ります。

プライマリセッションのデリゲートメソッドdidReceiveDataFromRemoteDeviceは、パックを解凍してApple Watchに保存するパッケージ化されたデータで呼び出されます。

だから、これが私のサンプルアプリでどのように見えるかです。

ボタンをタップして摂取した1オンスの水を数えると、Apple Watchに送信され、消費された水の総量が表示されます。

これで、stopMirroringToCompanionDevice APIを呼び出すことで、ワークアウト中にいつでもセッションのミラーリングを停止できます。

このメソッドを呼び出すと、コンパニオンデバイスへのデータの送信が停止し、ミラーリングされたセッションのdidDisconnectFromRemoteDevice WithErrorデリゲートメソッドが呼び出されます。

そして、サイクリングが終わったら、プライマリセッションを終了し、ビルダーを完成させてApple Watchに保存します。

ワークアウトのサンプルをApple Watchに保存した後、他のデバイスに同期し、ワークアウト後の要約をより詳細なチャートと視覚化で表示できるようになりました。

すごい！私の次のステップは、iPadで実行されているアプリでワークアウト後の概要を提示することです。

Apple Watchに保存したばかりのワークアウトは自動的にiPadに同期されるため、ワークアウトデータを視覚化するためにいくつかの変更を加えるだけで済みます。

HealthKitデータにアクセスする他のアプリと同様に、iPad上の私のアプリはまずユーザーの承認を得る必要があります。

アプリが承認を要求すると、必要に応じて承認シートが表示されます。

iPadでは、アプリに複数のウィンドウシーンがある可能性があるため、承認シートが適切なシーンに表示されていることを確認することが重要です。

私のアプリでこれを行うには、まずHealthKitUIフレームワークをインポートします。

読書に興味のあるデータタイプ、特にアクティブエネルギー、サイクリングスピード、パワー、ケイデンス、心拍数、ワークアウトサンプルを指定します。

次に、SwiftUIアプリを構築したので、HealthKitUIフレームワークの新しいhealthDataAccessRequestビュー修飾子を使用し、共有して読みたいデータ型とトリガーを渡します。

トリガーをtrueに設定すると、私のアプリに承認シートが表示されます。

UIKitアプリの場合、healthStores.authorizationView ControllerPresenterプロパティを設定し、共有して読み取るタイプの承認を要求します。

さて、承認を処理して、iPadで私のワークアウトをチェックしましょう。

すごい！

これで、ワークアウトデータにアクセスし、iPadの画面サイズを利用して、アプリのより豊かな体験を生み出すことができます。

超簡単じゃない？

これで、iPhoneからワークアウトを開始および制御し、Apple Watchから豊富なサイクリングデータを収集して同期し、最後にiPadでワークアウトの詳細を表示できます。

最後に、iPadでの認証をサポートするようにアプリを必ずアップデートしてください。

フィットネスアプリにサイクリングが含まれている場合は、新しいデータタイプのサポートを追加できます。

iPhoneとApple Watchでワークアウトアプリを構築する場合は、新しいミラーリングされたセッションAPIをチェックして、データのミラーリングと両方のデバイス間の状態の制御を開始します。

アプリがそれを必要とする場合は、同期識別子とバージョン番号を使用して、サーバーとユーザーのデバイス全体でデータの一貫性を維持します。

そして最後に、フィードバックをお寄せください。

私たちは、世界を健康に保つために、これらの素晴らしいアプリを構築し続けるために必要な機能をサポートしたいと考えています。

ご覧いただきありがとうございます。

♪