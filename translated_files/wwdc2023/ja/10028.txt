10028

♪ ♪

ルカ：こんにちは！私の名前はルカで、SwiftUIチームのエンジニアです。

今日は、新しいエキサイティングな機能でウィジェットに命を吹き込む方法について説明します。

ウィジェットはiOSとmacOSの体験の愛されている部分であり、今ではインタラクティブ性とアニメーションで、さらに強力です。

インタラクティブ性により、ユーザーはウィジェット内のデータを直接操作し、アプリで最も重要なアクションを実行するための強力なインタラクションを作成できます。

そして、アニメーションは、ユーザーがコンテンツがどのように変化したか、そして彼らの行動の結果が何であるかを理解するのを助けることによって、ウィジェットに命を吹き込みます。

私はこれらすべての新機能にとても興奮しているので、始めましょう。

まず、アニメーションと、ウィジェットを素晴らしく見せるのがいかに簡単かについて説明します。

その後、ウィジェットにインタラクティブ性を追加する方法を説明します。

アニメーションから始めましょう。

この講演を通して、私たちは私の友人ニルスが日中のカフェイン摂取量を追跡するために取り組んでいるアプリを使用するつもりです。

カフェインの総量と今日最後に飲んだ飲み物を示すウィジェットがすでにあります。

ウィジェットを最新のSDKで再コンパイルすると、ウィジェットの内容が変更されるたびに、システムはデフォルトのアニメーションでエントリ間の遷移をアニメーション化します。

見栄えをさらに良くするためにここにいくつかの調整を追加しますが、Xcodeに飛び込む前に、アニメーションがウィジェットでどのように機能するかについて簡単に説明しましょう。

通常のSwiftUIアプリでは、状態を使用してビューの変更を推進します。

そして、アニメーションはwithAnimationのような修飾子を使用して状態突然変異によって駆動されます。

しかし、ウィジェットの動作は少し異なります。

ウィジェットには状態がありません。

代わりに、特定の時間にレンダリングされた異なるビューに対応するエントリで構成されたタイムラインを作成します。

SwiftUIは、エントリ間で何が同じで何が違うかを決定し、変更された部分をアニメーション化します。

デフォルトでは、ウィジェットは暗黙のスプリングアニメーションとさまざまな暗黙のコンテンツトランジションを取得しますが、SwiftUIが箱から出してすぐに提供するすべてのトランジション、アニメーション、およびコンテンツトランジションAPIを使用して、ウィジェットのアニメーションをカスタマイズできます。

SwiftUIのすべてのアニメーションプリミティブがどのように機能するかについては、これ以上詳しく説明しません。

そのために、「Explore SwiftUI Animation」という素晴らしい講演があります。さて、Xcodeを開き、いくつかの調整で、ウィジェットが朝のカプチーノのラテアートと同じくらい豪華になり、新しいXcode Preview APIがこれらのアニメーションをすばやく反復するのにどのように役立つかをお見せします。

ここには、私のウィジェットを構成するすべてのビューがあります。

メインビューには2つのビューを持つVStackがあり、1つ目はカフェインの総量を示し、2つ目は今日飲んだ最後の飲み物です。

ここでcontainerBackground修飾子を使用して、ウィジェットの背景を定義する方法に注意してください。

これにより、MacとiPadでサポートされているすべての新しい場所に表示できます。

通常、ウィジェットのアニメーションを見るには、たくさんのエントリがあり、その瞬間が画面に表示されるのを待つ必要がありますが、それは面倒で遅くなる可能性がありますが、幸いなことに、今年導入する新しいAPIプレビューで素晴らしいソリューションがあります。

systemSmallでウィジェットの新しいプレビューを定義し、ウィジェットを定義するタイプを渡すことができます。

そして今、先ほど定義したいくつかのエントリでタイムラインをレンダリングする方法を指定できます。

キャンバスでそれを行うと、タイムラインのプレビューと、すべてのエントリがどのように見えるかを確認できます。

しかし、これをチェックしてください!

プレビューをクリックすると、エントリ間を遷移するときにウィジェットがどのようにアニメーション化されるかがわかります。

これはかなりかっこいい！

そして、これはこの新しいプレビューAPIができることの表面を引っ掻いているだけです。

この新しい強力なAPIの詳細については、セッション「XcodeプレビューでプログラマティックUIを構築する」をチェックしてください。

さて、これらのアニメーションを微調整し始める時間です。

私が最初にやりたいことは、カフェイン量のテキストから始めることです。

今、それはちょうど次の値とクロスフェードしていますが、私は本当に上昇する値にいくつかのドラマを追加したいです。

この場合、ビューは変更されませんが、テキストコンテンツのみが変更され、それをアニメーション化するには、コンテンツトランジションを使用できます。

そして、私はカフェインの価値で数字のテキストを追加することを選択します。

これは、変更時に目立つようにしたい重要な数値のために特別に作られたコンテンツの移行です。

すごく良さそうだね！

さて、私は最後の飲み物を示す景色に焦点を当てたいと思います。

新しい飲み物が入ってくることを強調するためのトランジションを追加したい。

最初にしたいことは、ID修飾子を使用して、このビューのアイデンティティをレンダリングされている特定のログに関連付けることです。

これにより、このログが変更されるたびに、これは新しいビューであり、新しいビューに移行する必要があることをSwiftUIに通知します。

そして今、私は移行を指定することができます。プッシュは良いことだと思います。

どの端から？

下からは良い選択だと思います。

さて、あなたはすでに今何をすべきか知っています。プレビューキャンバスに戻ります。

そして、ええ、私は下からのこの移行が好きです。

最後の微調整。

そんなにコーヒーを飲むと少し不安になり、それをこのトランジションのアニメーション曲線に反映させたい。

素晴らしいのは、通常のSwiftUIアプリのように、アニメーション修飾子を使用して、より短い持続時間の滑らかなスプリングを選択し、そのアニメーションをログ値にバインドできることです。

そして今、アニメーションは私のカフェインと一致します。

私たちが今持っているものについてかなり気分が良いので、インタラクティブ性に注意を切り替えましょう。

インタラクティブ性により、ウィジェットから直接アクションを実行できます!

Xcodeに飛び込む前に、ウィジェットの仕組みのアーキテクチャについて少し話し合いたいと思います。

これにより、インタラクティブ性がどのように機能するかについて、より良いメンタルモデルを作成できます。

ウィジェットを作成するときは、システムによって検出され、独立したプロセスとして実行されるウィジェット拡張を定義します。

ウィジェットは、効果的にウィジェットのモデルである一連のエントリを返すタイムラインプロバイダーを定義します。

ウィジェットが表示されている場合、システムはウィジェット拡張プロセスを起動し、タイムラインプロバイダーにエントリを尋ねます。

これらのエントリは、ウィジェット設定の一部であるビュービルダーにフィードバックされ、これらのエントリに基づいて一連のビューを生成するために使用されます。

その後、システムはこれらのビューの表現を生成し、ディスクにアーカイブします。

特定のエントリを表示する時間になると、システムはそのプロセスでウィジェットのアーカイブされた表現をデコードしてレンダリングします。

ちょっと立ち止まって、この最後の点を繰り返します。

ビューコードはアーカイブ中にのみ実行されます。

そのビューの別の表現は、システムプロセスによってレンダリングされます。

しかし、データが静的でない場合は、それらのエントリを更新することをお勧めします。

ウィジェットに表示されるデータを更新するたびに、アプリのreloadTimelines関数を呼び出すことで、これを行うことができます。

これは、先ほど説明したプロセスを繰り返し、新しいエントリを再生成し、ディスク上のビューの新しいコピーをアーカイブします。

この建築には3つの重要なポイントがあります。

まず、ウィジェットが表示されているとき、コードは実行されていません。

タイムラインエントリを更新することで、ウィジェットコンテンツの変更を推進します。これはインタラクティブなウィジェットにも当てはまります。

通常、ウィジェットの更新は最善の努力で行われますが、重要なことに、インタラクションから開始されたリロードは常に発生することが保証されています。

邪魔にならないように、インタラクティブ性を追加する方法を見てみましょう。

素晴らしいのは、ボタンやトグルなど、すでに慣れ親しんでいるコントロールを使用して、ウィジェットの一部をインタラクティブにできることです。

しかし、ウィジェットは別のプロセスでレンダリングされるため、SwiftUIはプロセス空間でクロージャを実行したり、バインディングを変更したりしないことを忘れないでください。

したがって、ウィジェット拡張機能によって実行され、システムによって呼び出されるアクションを表す方法が必要です。

ありがたいことに、この問題に対する解決策はすでにあります。アプリの意図です。

アプリのインテントを使用して、アプリのアクションをショートカットまたはSiriに公開した可能性があります。

そして今、同じ意図を使用してウィジェットのアクションを表すことができます。

AppIntentは、システムによって実行できるアクションをコードで定義できるプロトコルです。

たとえば、ここでは、todoアプリでtodoアイテムを切り替えるアプリの意図を定義しています。

インテントは、入力として多くのパラメータと、インテントを実行するためのビジネスロジックを持つperperという非同期関数として定義します。

アプリインテントは非常に強力で、それらについて知っておくべきことがたくさんあるので、WWDC22と23の「アプリインテントに飛び込む」と「アプリのインテントの強化を探る」セッションを必ずチェックしてください。

また、UIから直接App Intentを実行する機能をサポートするために、SwiftUIとAppIntentsの両方をインポートするときに、AppIntentを引数として受け入れ、これらのコントロールが操作されたときにそのインテントを実行するButtonとToggleに新しいイニシャライザのファミリーがあります。

インタラクティブなウィジェットでは、AppIntentを使用したボタンとトグルのみがサポートされていることに注意してください。

他のコントロールは機能しません。

そしてもちろん、これらの初期化子はアプリでも機能します。これは、ウィジェットとアプリの間でアプリのインテントロジックを共有できるのでクールです。

Xcodeとコーヒートラッカーアプリに戻り、インタラクティブ性を追加しましょう。

現在、ユーザーはアプリを開くことによってのみ新しい飲み物を記録することができますが、インタラクティブなウィジェットが輝く場所は、あなたのアプリで最も重要なアクションを表面化するためのアクセラレータであり、私のアプリの場合、これは間違いなく新しい飲み物のロギングです。

だから、私がすでに作成したファイルに追加しましょう。

私が最初にしたいことは、新しい飲み物を記録するためにAppIntentに準拠したタイプを定義することです。

システムで使用できる人間が読めるタイトルを与え、エスプレッソをストアに記録し、空のインテント結果を返すことで、実行要件を実装します。

私が注意を喚起したいのは、実行は非同期関数であり、ログ書き込み操作を待っているときにここで行っているのとまったく同じようにデータベースに書き込むなど、非同期作業を行う場合は、それを十分に活用する必要があるということです。

パフォーマンスが戻るとすぐに、システムはすぐにウィジェットのタイムラインのリロードを開始し、ウィジェットのコンテンツを更新する機会を提供します。

繰り返しますが、実行から戻る前に、更新されたウィジェットをリロードするために必要なすべての情報を保持していることを確認してください。

私は飲み物をエスプレッソにハードコード化しましたが、もちろん、特定の飲み物をログに渡すことができるようにしたいです。

これを行うには、@Parameterプロパティラッパーとすべてのパラメータを入力する初期化子を使用して、ストアドプロパティを追加できます。

このプロパティラッパーを使用することが重要です。なぜなら、注釈が付けられている保存されたプロパティのみが永続化され、ウィジェット拡張でインテントが実行されたときに利用可能になるからです。

このインテントを呼び出すボタンを追加する前に、ここでアプリインテントを使用することの重要なエコシステムの利点を強調したいと思います。

私が今定義したこのアプリの意図は、ショートカットとSiriで利用可能になるので、ここでそれを定義するための投資は、ウィジェットを超えてあなたのユーザーエクスペリエンスに配当を支払うでしょう。

そして今、ウィジェットにボタンを追加する準備が整いました。

ボタンを押しながら新しいビューを作成しましょう。

このビューでは、アプリの意図を取るこのボタン初期化子を使用しているので、定義したばかりのものを渡すことができます。

そして、いくつかのスペーサーを使って、このビューをウィジェットの残りの部分に追加しましょう。

今、私たちはすべてを整えました、これが構築して実行することによってウィジェットでどのように機能するかを見てみましょう。

ここでのちょっとしたヒント：実際にウィジェット拡張機能のターゲットを直接構築することができ、Xcodeがホーム画面にウィジェットをインストールします。

私のウィジェットには、先ほど定義したボタンがあります。

それをタップすると、この最後のエスプレッソを記録できます。

しかし、私のウィジェットが可能な限り最高のユーザーエクスペリエンスを提供するために、私がしたい追加の変更も1つあります。

アプリのインテントの実行が終了すると、ウィジェットがタイムラインをリロードします。

これにより、アクションからUIの変更まで、小さなレイテンシが発生する可能性があります。

しかし、このレイテンシはMac上のiPhoneウィジェットでより顕著になる可能性があるため、箱から出して解決策を提供しています。

たとえば、私のウィジェットでは、カフェインの総量を示す値は、更新されたエントリが到着するまで更新されません。

invalidatableContent修飾子を使用して、このビューに注釈を付けることができます。

このウィジェットをiPhoneからMacに追加しました。

ボタンをタップしましょう。

カフェインの量を示すビューは、更新が来るまでその値が無効になっていることを示すシステム効果を示しています。

ボタンの動作を見て、invalidableContent修飾子を使用すると、ユーザーがレイテンシの認識を向上させることができます。

この修飾子を慎重に使用してください。

変更される可能性のあるすべてのビューに注釈を付ける必要はありません。

この修飾子は、ユーザーに正しい期待値を設定するために意味のあるビューで使用する必要があります。

Toggleはさらに一歩進んで、ウィジェットの拡張機能への往復を待つことなく、対話したときにプレゼンテーションを楽観的に更新します。

これは、両方の設定でトグルスタイルを事前にレンダリングすることで、アーカイブ時にあなたに代わって自動的に行われます。

独自のトグルスタイルを定義する場合は、スタイルからconfiguration isOnプロパティを確認し、それを使用して外観を切り替えてください。

これで、インタラクティブ性とアニメーションの概要は終わりです。

アニメーションとインタラクティブ性により、ウィジェットに新しい命を吹き込む機会があり、これらすべての新しい場所にあるウィジェットを使用すると、どこにいてもユーザーにこれらの小さな楽しいインタラクションをもたらすことができます。

したがって、新しいXcode Preview APIの助けを借りてウィジェットのアニメーションを微調整し、アプリで最も重要なアクションを探し、ウィジェットに表示し、いつでもどこでもユーザーに強力なインタラクションを提供します。

ありがとう！

♪ ♪