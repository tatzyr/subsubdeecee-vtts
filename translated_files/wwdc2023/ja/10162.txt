10162

♪ ♪

Cody: こんにちは、「The SwiftUI cookbook for focus」へようこそ。

私はCodyです。今日は、SwiftUIのフォーカスAPIを使用して、本当に素晴らしいユーザーエクスペリエンスを調理できることのいくつかについて説明します。

このビデオでは、おいしいAPIの詳細の固定メニューから3コースの食事を提供し、一連の細かいコード例と組み合わせます。

前菜として、私は焦点の非常に基本的なレビューにいくつかの時間を費やします:それは何ですか、そしてそれはどんな仕事をしますか?

最初のコースでは、フォーカス体験を作る成分を見て、あなたの口蓋を磨きます。

それらの材料がレイアウトされているので、私は本当に料理を始めることができます。

メインコースでは、フォーカスの外観を制御し、フォーカスの動きを観察し、カスタムコントロールでキーボード入力に応答するためのいくつかのレシピを掘り下げます。

では、フォーカスとは何ですか?

フォーカスは、誰かがキーボードのキーを押したり、Apple TV Remoteでスワイプしたり、時計のDigital Crownを回したりしたときに、どのように反応するかを決定するためのツールです。

これらの入力方法には、共通する1つの重要な詳細があります。

それ自体では、入力が意図されている画面上のコントロールを特定するのに十分な情報を提供していません。

これをマウス、トラックパッド、タッチスクリーンなどと比較してください。

マウスまたはトラックパッドを使用すると、画面上のカーソルは、システムがインタラクションのターゲットを見つけるために使用する画面座標とクリックを関連付けます。

フォーカスは、システムがポインタカーソルなしで直接入力するために必要な追加情報を提供します。

ビューにフォーカスがある場合、システムはそれをキーボード、Apple TVリモコン、およびApple Watchデジタルクラウンからの入力に応答するための出発点として使用します。

フォーカスは単なる実装の詳細ではありません。

アプリを使用している人々にとっても同様に重要であり、フォーカスされたビューが特に強調されている理由です。

macOSは、フォーカスされたビューの周りに自動的に境界線を追加し、キーボード入力を受信することを示しています。

watchOSは、コントロールの周りに緑色の境界線を描画し、デジタルクラウンを回転させることでコントロールの値を変更できることを知らせます。

また、tvOSでは、フォーカスされたビューは、他のコントロールの平面の上に持ち上げるホバー効果を受けます。

フォーカスビューを強調することは、いくつかの方法で人々を助けます。

キーボードで入力したり、リモコンをスワイプしたりすると、入力がどこに行くかを予測できます。

そして、複雑または詳細なレイアウトでは、アプリのどの部分とやり取りしているかを一目で人々に思い出させます。

フォーカスは特別な種類のカーソルのように振る舞います。

マウスカーソルのように画面上のポイントを追跡する代わりに、UIのどの部分がフォーカス入力のターゲットであるかを追跡します。

このため、私はフォーカスをユーザーの注意を引くカーソルとして考えるのが好きです。

フォーカスとは何か、それがアプリにどのように表示されるかを少しわかったので、最初のコースをレイアウトし、すべてのアプリのフォーカスエクスペリエンスに入る基本的な要素を見てみましょう：フォーカス可能なビュー、フォーカス状態、フォーカスされた値、フォーカスセクション。

焦点を絞って調理するときに考慮すべき主な成分は、焦点を絞ったビュー自体です。

これは、フォーカス入力に応答するときにシステムが出発点として使用するビューです。

異なるコントロールは、異なる状況下で、異なる理由で集中可能です。

macOSとiPadOSのテキストフィールドとボタンを比較してください。

テキストフィールドは、タップしても、Tabキーを押して以前のコントロールからフォーカスを移動しても、常にフォーカス可能です。

この種のコントロールは、継続的なフォーカス入力をキャプチャする役割であるため、編集のフォーカスをサポートします。

ボタンは違います。彼らの仕事は、クリックとタップを処理することです。

macOSとiPadOSは、タップしたときにボタンにフォーカスを与えず、Tabキーでボタンに到達する唯一の方法は、システム全体でキーボードナビゲーションをオンにすることです。

この設定に精通していない場合は、macOSシステム設定のキーボード設定ペインで見つけることができます。

「キーボードナビゲーション」というラベルの付いたスイッチです。

そのスイッチを切り替えた後、Tabキーを押してボタンに焦点を合わせ、スペースバーを押して起動することができます。

ボタンはアクティベーションのフォーカスをサポートします。

これらのコントロールは、仕事をするためにフォーカスを必要としませんが、クリックとタップに代わるフォーカス駆動の代替手段をサポートするために、システムが許可すればフォーカスを取ります。

iOS 17とmacOS Sonomaでは、フォーカスシステムに参加するためのカスタムコントロール用の新しいAPIがあります。

「フォーカス可能な」ビュー修飾子を適用すると、コントロールがサポートするフォーカスインタラクションの種類を指定することで、結果の動作を微調整できるようになりました。

フォーカスを使用して時間の経過とともに状態を更新するコントロールについては、編集インタラクションを指定します。

直接ポインタアクティベーションの代替手段としてフォーカスを使用するコントロールについては、アクティベートインタラクションを指定します。

引数をまったく提供しない場合、システムはすべてのインタラクションに制御の焦点を与えます。

macOS Sonoma以前は、フォーカス可能な修飾子はアクティベーションセマンティクスのみをサポートしていました。

macOSコードでフォーカス可能な修飾子をすでに使用している場合は、新しい動作がユースケースに合っていることを確認してください。

「インタラクション」引数を追加してコードを更新する必要があるかもしれません。

次の成分は、瞬間ごとにフォーカスシステムの状態に関連しています。

この成分は適切に「FocusState」と名付けられています。

システムは、どのビューにフォーカスがあるかを追跡し、アプリはロジックでその情報を使用して、入力の処理方法とビューのスタイルを決定することができます。

システムの状態を観察するには、特定のビューに焦点を当てて提供した値を関連付けるバインディングを作成します。

ビューは、これらのバインディングを読んで、ビューがフォーカスされるなど、フォーカスが変更されたとき、またはフォーカスが却下されたときに通知を受けることができます。

ブール値を持つフォーカス状態プロパティは、ここに示すように、単一のビューがフォーカスされているかどうかを示します。

より複雑なケースでは、カスタムデータ型を使用することもできます。

後で、この例について話し合い、フォーカス状態をプログラムで変更する方法を紹介します。

次に、Focused Values APIです。

Focused Values APIは、ユーザーインターフェイスのリモート部分をリンクするデータ依存関係を構築する方法の問題を解決します。

このAPIを使用して、アクティブなシーンで何が起こっているかに基づいてアプリのコマンドを更新します。

焦点を絞った値は、これらの異なる要素間のデータフローを可能にします。

カスタムを定義し、それを使用してメインメニューのコンテンツを構築します。

フォーカスされた値の作成と使用は、カスタム環境キーとオブジェクトの作成と使用に似ています。

「FocusedValueKey」プロトコルを使用して新しいキーを定義し、新しいキーを使用して値を取得して設定する計算されたプロパティで「FocusedValues」を拡張します。

使用するデータは、シーンのビューから取得され、値、バインディング、または観測可能なオブジェクトにすることができます。

いずれにせよ、ビュー修飾子のファミリを使用して、ビュー階層のその部分にあるフォーカスとデータを関連付けます。

環境値と同様に、動的プロパティを宣言することで、フォーカスされた値にアクセスします。

この例では、フォーカスされた値はバインディングなので、「@FocusedBinding」プロパティラッパーを使用し、カスタムキーパスを提供します。

「@FocusedBinding」は、フォーカスされたビューとその祖先を見て、現在キーに関連付けられたバインディングがあるかどうかを確認します。

プロパティラッパーは自動的にバインディングを解除するので、バインドされた値を直接操作できます。

私がする必要がある唯一の他のことは、ビューのボディで私の新しいプロパティを使用することです。

時間が経つにつれて、異なるコントロール間でフォーカスが移動し、異なるウィンドウがアクティブになると、システムは新しいコンテキストで見つけた値を反映するようにビューを更新します。

最後の成分はフォーカスセクションのAPIです。

フォーカスセクションは、誰かがApple TV Remoteでスワイプしたり、キーボードのTabキーを押したりしたときに、フォーカスがどのように動くかに影響を与える方法を提供します。

デフォルトでは、フォーカスは画面の最上端に最も近いコントロールから始まります。

そこから、タブを押すと、現在のロケールのレイアウト順序に従って、あるコントロールから次のコントロールにフォーカスが移動します。

画面の最後のコントロールに到達すると、タブをもう一度押すとシーケンスが再起動します。

Apple TVのリモコンでのフォーカスの動きは指向性です。

上下、左右にスワイプして、コントロール間でフォーカスを移動できます。

方向移動は、隣接するターゲット間でのみ機能します。

この例では、クレームブリュレボタンから他のデザートの1つに右にスワイプできます。

しかし、クレームブリュレの固定具を食料品リストに追加したい場合は、下にスワイプできません。

そのボタンはクリームブリュレボタンの真下にないので、私のジェスチャーは失敗します。

これらのフォーカスターゲットを整列させるには、下部ボタンのコンテナをフォーカスセクションとしてマークします。

フォーカスセクションは動きのジェスチャーのターゲットになりますが、フォーカス可能にはなりません。

代わりに、彼らは最も近いフォーカス可能なコンテンツにフォーカスを導きます。

効果的であるためには、フォーカスセクションは内容よりも多くのスペースを占有する必要があります。

この場合、ボタンの前後にスペーサーを追加して、画面の幅に合わせてスタックを成長させます。

より大きなフォーカスターゲットが配置されているので、どこからでも下にスワイプして下のボタンに到達できるようになりました。

私はすでにそのクレームブリュレを味わうことができます!

カスタムコントロールのルックアンドフィールを磨き、一般的なタスクから摩擦を取り除くために、先ほど説明した主成分を組み合わせたレシピをいくつか説明します。

最近、私は仲間のシェフCurtが作った料理本アプリを使っています。

あなたは彼のWWDC22のビデオからそれを認識するかもしれません。

このセクションのレシピは、私が取り組んできたいくつかの新機能に基づいており、行動に集中するための注意の恩恵を受けるでしょう。

例えば、私は食料品店への次の旅行で何を得るべきかを覚えておくために、アプリ内の食料品リストを追加しました。

この最初のレシピは、プログラマティックフォーカスの動きのダッシュが、私の食料品リストの編集を楽しい経験にする方法を示しています。

食料品リストシートが表示されると、最後には常に空のアイテムがあります。

空のアイテムをタップするとキーボードが上がるので、購入する必要があるものを説明できます。

食料品の追加は頻繁な作業なので、リストが表示されるたびに自動的に空のアイテムに焦点を合わせることで、タップを節約したいと思います。

先ほど、フォーカスステートAPIを使用して、どのビューにフォーカスがあるかを観察して更新する方法を示しました。

ここでも同じAPIを使います。

前の例では、フラグを使用して、単一のビューにフォーカスがあるかどうかを知らせました。

私の食料品リストの場合、観察すべきテキストフィールドがいくつかあります。

FocusStateの値は、このような場合の任意のハッシュ可能なタイプにすることができます。

この画面に追加する各成分には一意のIDがあり、フォーカスされたテキストフィールドに関連付けられたIDを保存することでフォーカスを追跡できます。

「Focused(_:equals:)」修飾子を使用して、各テキストフィールドとその成分の間のリンクを作ります。

この修飾子に2つの引数を提供する必要があります。「focusedItem」プロパティへのバインディングと、フォーカスがそのテキストフィールドにあるときにバインディングを更新する必要がある成分IDです。

食料品リストをタップすると、アプリを実行し、「focusedItem」プロパティが異なるID値で更新されていることを確認できます。

フォーカス状態のバインディングが整っていると、食料品リストが最初に画面に表示されたときに、テキストフィールドにプログラムでフォーカスを移動するために必要なものがあります。

これを行うには、「defaultFocus(_:_:)」ビュー修飾子をリストに追加します。これは、iOS 17でも利用可能になりました。

システムがこの画面で初めてフォーカスを評価しているとき、最後の食料品リストアイテムのIDで私のバインディングを更新しようとします。

これらの変更により、私の食料品リストに追加することは2段階のプロセスになりました。

ツールバーボタンをタップしてシートを表示し、入力を開始します。

ステップ3はありません。

買い物リストが増えるにつれて、ツールバーの追加ボタンをタップすると、新しい空のリスト項目が作成されますが、フォーカスは元の場所のままであることに気づきます。

焦点を合わせるには、空のアイテムをタップする必要があります。

これは、新しいアイテムが表示されたらすぐに入力を開始できるように、アプリがプログラムでフォーカスを移動させたい別のケースです。

違いは、今、私は変化のタイミングをコントロールしたいということです。

幸いなことに、デフォルトのフォーカスを設定するために作成したのと同じフォーカス状態バインディングを使用できます。

私のGroceryListViewには、モデルに新しいアイテムを追加する「addEmptyItem」メソッドがあります。

そして、私はすでに新しいアイテムのTextFieldを「currentItemID」プロパティに関連付けているので、ツールバーボタンのアクションの一部として新しいIDでプロパティを更新する必要があります。

ヴォイラ！

今、私の食料品リストを開始または更新したいとき、私はそれが必要な場所に焦点を置くために何かをタップする必要はありません、私はちょうど入力を開始することができます。

次に、私が作成したカスタムコントロールのフォーカスインタラクションを改善するために、さらにいくつかの成分を使用しましょう。

この時点で、私は多くのレシピをカタログ化しました。

それぞれを試してみると、どれがうまく出てきて、どれが再考が必要か、少なくとももう少し塩が必要かを思い出したいです。

これを助けるために、私は料理の旅の高値と安値をキャプチャするために、絵文字でカスタムピッカーコントロールを構築しました。

絵文字をタップして各レシピを評価できますが、キーボードナビゲーションのライフスタイルを送っている人として、タブキーでコントロールに集中し、矢印キーを使用して選択を変更できるようにしたいと思っています。

それを実現させましょう。

これが私の絵文字ピッカーの基本的な構造です:私が最初にする必要があるのは、コントロールを集中可能にすることです。

引数なしで「フォーカス可能な」修飾子を追加することから始めます。

これにより、Tabキーを押すとコントロールにフォーカス可能になりますが、他のボタンや同様のコントロールでは表示できない追加の動作に気付きます。

たとえば、私のコントロールはクリックに焦点を当てますが、ボタンやセグメント化されたコントロールはそうではありません。

これらのコントロールは、フォーカスするために「キーボードナビゲーション」を必要とします。

私のもそうすべきです。

その動作を取得するには、アクティベーションのためにフォーカス可能なコントロールを指定します。

アクティベーションのためにフォーカス可能なコントロールは、クリック時にフォーカスせず、キーボードでフォーカスを受け取るには「キーボードナビゲーション」をオンにする必要があります。

次に気づいたのは、macOSが私のコントロールの周りに描くフォーカスリングが長方形であることです。

より洗練された外観のために、私はフォーカスリングがカプセル型の背景のパスをたどってほしい。

フォーカスリングは常にビューのコンテンツ形状に従いますが、私の場合はデフォルトでは長方形です。

「contentShape」修飾子を使用し、ビューを視覚的にクリップするために使用しているのと同じカプセル形状で渡します。

私のコントロールがフォーカス可能になったので、次のステップはキー押下を処理させることです。

左右の矢印キーを使って、選択した評価を変更できるようにしたいです。

「onMoveCommand」修飾子を使用すると、Macキーボードで矢印キーが押されたときや、Apple TVリモコンで方向エッジがタップされたときなど、プラットフォームに適した移動コマンドに応答して実行するアクションを提供できます。

システムは移動方向でアクションを呼び出すので、それに基づいて評価選択を左右に移動します。

コントロールコンテンツは、アラビア語やヘブライ語などの右から左の言語を使用している人々のために水平に反転する必要があります。

移動コマンドアクションが環境の「layoutDirection」を使用してこれを説明していることを確認してください。

フォーカス動作を実装することの素敵なことの1つは、同じコントロールを取り、Apple Watchアプリで素晴らしい結果を得ることができるということです。

watchOSのフォーカス入力を処理するには、「onMoveCommand」修飾子の代わりに「digitalCrownRotation」修飾子を使用します。

そして、フォーカスがあるときに、isFocused環境値を使用して、コントロールの周りにおなじみの緑色の境界線を描きます。

これらのいくつかの修飾子だけで、私は簡単なコントロールを取り、キーボードとデジタルクラウンのサポートを追加することができました。

最後のレシピは、完成した結果を撮っていた写真を紹介するために構築してきたフォーカス可能なグリッドビューです。

私はこれを怠惰なグリッドとして構築しており、すでにいくつかの選択動作を実装しています。

したがって、画像をクリックすると選択され、ダブルクリックするとレシピの詳細ビューに移動します。

今、私はそれがフォーカスインタラクションをどのように処理すべきかを考える必要があります。

具体的には、Tabキーを押すときにグリッドをフォーカス可能にしたいです。

集中したら、矢印キーで選択を更新し、Returnキーで選択したレシピの詳細に連れて行ってほしい。

前に話した成分のいくつかと、キー押下を処理し、フォーカスがあるときにグリッドがどのように表示されるかをカスタマイズするために、いくつかの余分なものを使用します。

前の例と同様に、最初のステップはグリッドを集中可能にすることです。

この場合、インタラクションを指定する必要はありません。

デフォルトでは、「キーボードナビゲーション」が有効になっているかどうかにかかわらず、グリッドはクリックし、キーボードを使用してタブするときにフォーカスされます。

これはまさに私が欲しいものです。

グリッドをフォーカス可能にしたので、システムは自動的にその周りにフォーカスリングを描画します。

選択可能なコンテンツのコンテナの場合、その効果は冗長です。

選択したレシピの周りに追加した色付きの境界線は、グリッドにフォーカスがあるかどうかをすでに伝えています。

「focusEffectDisabled」修飾子を使用して、自動フォーカスリングをオフにすることができます。

ビューが選択されている境界線やその他の指標には「SelectionShapeStyle」を使用します。

選択したアクセントカラーに自動的に適応し、フォーカスがグリッドからサイドバーに移動するときのように、祖先ビューのどれもフォーカスがないと灰色に変わります。

次にやりたいことは、選択したレシピをお気に入りとしてマークするためのメインメニューコマンドを接続することです。

これにはFocused Values APIを使用し、必要に応じてメニューコマンドを更新するために、選択範囲にバインディングを渡します。

矢印キーの選択をサポートするには、onMoveCommand修飾子を使用します。

そして、システムが呼び出すと、移動方向を使用してグリッドの選択したレシピを更新します。

最後に、選択に基づいて行動し、Returnキーが押されたときにそれに移動する方法が欲しいです。

macOS SonomaとiOS 17で新しい「onKeyPress」修飾子でこれを行うことができます。

この修飾子は、キーまたは文字のセットと、接続されたハードウェアキーボードでこれらのキーのいずれかが押されたときに実行するアクションを取ります。

アクションがプレスを処理しなかった場合は「無視」を返し、ディスパッチはビュー階層を続行する必要があります。

また、ボーナス機能として、「onKeyPress」を使用してタイプ選択を実装するので、名前の最初の文字を入力してレシピをすばやくスクロールして選択できます。

macOSのグリッドに素晴らしいキーボード体験を構築したので、tvOSのグリッドに目を向けましょう。

tvOSでは、グリッド内の各セルはフォーカス可能であるため、フォーカスがリモコンで異なる方向に移動すると、その方向のセルがフォーカスになり、他のセルよりも視覚的に上昇します。

システムは、ボタンとナビゲーションリンクでデフォルトで「リフト」ホバー効果を使用します。

そして、この効果は、テキストを含むビューや、テキストと画像を組み合わせたビューに適しています。

しかし、これらのレシピ写真は別の効果の恩恵を受けるでしょう。

tvOS 17の新機能で、フォーカス可能なビューにハイライトホバー効果を適用できます。

この効果は、リモコンをスワイプすると、焦点を合わせたアイテムに遠近感シフトと鏡面の輝きを追加し、レシピのサムネイルのようなアートワークや写真によく似合います。

そして、私のtvOSアプリのトップのチェリーとして、フォーカスセクションを追加します。

グリッドはボタンのリストの横にあり、私はしばしばこれら2つのグループ間を移動する必要があります。

アプリを使用すると、おなじみの問題に気づきます。

フォーカスがグリッドの下の行の1つにある場合、フォーカスターゲットが互いに隣接していないため、左にスワイプしてカテゴリボタンを移動できません。

レイアウトの全高みにまたがるフォーカスセクションにカテゴリリストを配置します。

クレームブリュレから左にスワイプすると、予想通り、フォーカスがカテゴリに移動します。

そして、グリッドは完成しました。

ベリシモ！

私はこのビデオで多くの分野をカバーしました。

あなたの焦点成分を集めて、あなたが作ることができるものを見る時が来ました。

キーボードナビゲーションを有効にして、macOSとiPadOSのアプリをテストします。

デフォルトのフォーカスを最も有用な場所に配置します。

フォーカスセクションでコントロールを整理して、不規則なレイアウトを通して動きを導くのに役立ちます。

ありがとう、そしてどうぞ召し上がってください!