10007

♪ ♪

スコット：こんにちは、仮想化チームのスコット・ミオニスです。今日は、macOS Sonomaの機能がどのように仮想化でシームレスな体験を生み出すことができるかについて説明します。

仮想化フレームワークを使用すると、仮想マシンを設定、管理、実行できます。

macOS Sonomaでは、仮想MacとLinux仮想マシンはこれまで以上に強力です。

それらはより使いやすく、新しい構成オプションにより、高度にカスタマイズ可能です。

これを可能にする機能がたくさんあります。 たくさんの機能があります。

このセッションでは、いくつかの重要な項目と、それらをアプリケーションで活用する方法を探りましょう。

まず、仮想マシンの新しいワークフローとユーザーエクスペリエンスの改善。

次に、新しいストレージとキーボードの設定オプション。

そして最後に、Rosetta 2がLinux仮想マシンでx86_64アプリケーションをさらに高速に実行する方法。

仮想マシンで作業する新しい方法をいくつか掘り下げてみましょう。

2つの強力な新機能について説明します。

まず、サイズ変更可能なディスプレイです。

実行時にサイズを変更してウィンドウを埋める仮想マシン用の新しい表示オプション。

次に、仮想マシンの保存と復元です。

後で再開できるように、実行中の仮想マシンをディスクにシリアライズするメカニズム。

サイズ変更可能なディスプレイから始めましょう。

画面サイズは、仮想Macでの作業の大きな部分を占めています。

サイズ変更可能なディスプレイを使用すると、仮想マシンは画面の解像度を動的に調整してウィンドウを埋め、スペースを最も効率的に利用します。

これをコードに入れましょう。

独自のアプリケーションでサイズ変更可能なディスプレイを使用するには、まずVZVirtualMachineViewを初期化します。

ディスプレイのサイズを変更可能にするには、新しい「automaticallyReconfiguresDisplay」プロパティをtrueに設定します。

そして、それだけです!

VZVirtualMachineViewのサイズを変更すると、仮想マシンに表示サイズを調整するように自動的に指示されます。

また、ディスプレイを固定したままにしたい場合は、このプロパティはデフォルト値のままです。

次に、仮想マシンの保存と復元について話し合いましょう。

仮想マシンを停止することは、VMの電源を切ることを意味します。

仮想マシンを起動することは、コールドブートを行うことを意味します。

しかし、Macで作業するとき、ほとんどのアプリケーションは作業中に進捗状況を保存します。

仮想マシンにも同じことが言えます。

仮想マシンを実行していて、進歩を失うことなくそれを閉じたいとしましょう。

仮想マシンをファイルに保存して、後で実行を再開できます。

または、自分の仕事をバックアップしたいとしましょう。

仮想マシンはいつでも保存でき、ディスクや補助ストレージなどの外部リソースを複製するようにします。

そして、時間をさかのぼりたい場合は、仮想マシンを元の状態に戻すことができます。

この機能で多くのことが可能になります。

では、それを行動に移しましょう。

私はmacOS Sonomaを実行しており、デスクトップには仮想Macがあり、仮想化サンプルアプリケーションでmacOS Sonomaも実行しています。

そして、私はApple Storeへの次のエキサイティングな旅行のためにいくつかの研究をしています。

もちろん、私はマップを開いていて、AirPodsの詳細についてはAppleのウェブサイトを閲覧しています。

さて、仮想マシンの電源を切らずに休憩を取りたいです。

そのため、アプリケーションを終了すると、仮想マシンを保存します。

その後、アプリケーションを再起動すると、仮想マシンはすべてのタブを開いたまま、中断したところから動作を再開します。

これを独自のアプリケーションに組み込む方法を探りましょう。

仮想マシンを保存する前に、仮想マシンを一時停止します。

これにより、仮想マシンは安定した状態になり、実行は中断されます。

次に、新しいsaveMachineState APIを呼び出し、仮想マシンのすべてのランタイム状態を含む、指定したURLにファイルを書き込みます。

後で実行し続けるために必要なものすべて。

ディスクイメージなどの外部リソースは、別々にコピーする必要があります。

仮想マシンを保存したので、復元しましょう。 復元しましょう。

仮想マシンの状態を復元するには、同じ構成から新しいVZVirtualMachineを作成することから始めます。

仮想マシンをコールドブートする仮想マシンを直接起動する代わりに、新しいrestoreMachineState APIを呼び出して、以前に保存されたファイルのURLを渡します。

そして今、仮想マシンは以前とまったく同じ状態です。

中断したところから実行を再開できます。

以前の保存から仮想マシンを復元する場合、心に留めておくべきことがいくつかあります。

まず、セーブファイルには仮想マシンのデータが含まれています。

保護する必要があります。 は保護する必要があります

これらのファイルは、可能な限り強力な保証を提供するためにハードウェアで暗号化されています。

他のMacやユーザーアカウントは、他人のセーブファイルを読んだり、仮想マシンを復元したりすることはできません。

また、今日保存されたファイルはバージョン管理されているため、将来的には新しい機能を追加することができます。

ファイル形式が変更され、保存ファイルを復元できない場合、フレームワークは特定のエラーコードを返しますので、アプリケーションはそれを処理できます。

これが起こると、ファイルを破棄し、仮想マシンを再起動すると、軌道に戻ります。

次に、仮想マシンを構築する新しい方法をいくつか探りましょう。

まず、ネットワークブロックデバイスです。

これにより、ストレージデバイスをネットワーク経由で仮想マシンに接続できます。

次は、virtioブロックデバイスの代替品であるNVMeコントローラデバイスのサポートです。

そして最後に、Macキーボードは、GlobeキーのようなApple固有のキーを仮想マシンに直接マッピングすることで、仮想Macでの作業をより直感的にします。

ネットワークブロックデバイスから始めましょう。

仮想化フレームワークでは、ストレージは通常ローカルで提供され、同じMacでディスクイメージを読み書きします。

しかし、macOS Sonomaでは、仮想化フレームワークはサーバーからリモートでストレージを提供できます。

これを可能にするプロトコルは、ネットワークブロックデバイス、またはNBDです。

それがどのように機能するかを掘り下げてみましょう。

仮想化フレームワークは、NBDプロトコルのクライアント側を実装します。

仮想マシンがディスクにアクセスすると、リクエストは同じ仕様に準拠したNBDサーバーに転送されます。

必要なI/Oを行うと、NBDサーバーはデータで応答します。

これは2つの理由で非常に柔軟です。

まず、ストレージは、同じMac上、またはネットワーク上のリモートサーバー上のどこにでも常駐できるようになりました。

第二に、ストレージは独自のサーバーによって管理されているため、カスタムイメージフォーマットでも物理ドライブでも、必要なカスタムI/Oを実装できます。

これらはすべて、仮想マシンに完全に透過的です。

これを設定する方法を見てみましょう。 

仮想化フレームワークAPIでは、ストレージデバイスの初期化には2つの部分があります。

まず、デバイスの種類を選択します。

これは、仮想マシンに提示されるインターフェイスを定義します。

そして、添付ファイルを選択すると、データがMacで実際にどのように表現されるかが選択されます。

仮想マシンでは、組み合わせて組み合わせることができます。

仮想化フレームワークは、virtioブロックデバイスやUSBマスストレージデバイスなどの仮想デバイスをサポートしています。

また、これらのデバイスのいずれかでは、ディスクイメージ上のデータの読み取りと書き込みを行うディスクイメージアタッチメントや、NBDサーバー上のデータの読み取りと書き込みを行う新しいネットワークブロックデバイスアタッチメントなどの添付ファイルを使用できます。

このNBD添付ファイルをコードで設定しましょう。

これをアプリケーションで使用するには、まずNBDサーバーを指すURLを指定します。

これは、特定のサーバー上の特定のディスクを識別する特別なURLです。

次に、このURLで新しいNBDストレージアタッチメントを初期化します。

最後に、この添付ファイルでストレージデバイスを初期化します。

この例では、virtioブロックデバイスを使用しています。

ほとんどのユースケースでは、これは最もパフォーマンスの高いオプションである可能性が高い。

ストレージはネットワーク経由で提供されているため、接続はいつでも失われる可能性があります。

このような場合は、仮想マシンを一時停止したり、接続を再確立したりして、アクションを実行できます。

この場合、接続の状態が変更されたときに通知されるカスタムデリゲートクラスを添付できるため、必要なコードを実行できます。

仮想化フレームワークのストレージオプションに追加するのは、Non-Volatile Memory Express、またはNVMeです。

NVMeは、多くのLinuxカーネルで有効になっている標準化された技術であり、そのアプリケーションはより具体的であるため、なぜそれを使用したいのかから始めましょう。

大多数のユースケースでは、virtioブロックストレージによって提供される準仮想化インターフェイスは、最も簡単で最速の使用です。

これは確かに仮想Macの場合です。

しかし、一部のLinux仮想マシンにはvirtioドライバがありません。

これらは、仮想環境で実行するように構築されていないカーネルである可能性があります。

これらのカーネルがしばしば持っているのは、NVMeコントローラデバイスのドライバです。

macOS Sonomaでは、NVMeコントローラデバイスは仮想化フレームワークによってエミュレートされ、より多くのオペレーティングシステムを仮想マシンで実行できます。

NVMeを設定するには、仮想マシンを構築するときに新しいデバイスタイプを使用します。

NVMeはLinux仮想マシン専用で、もちろんNBDもサポートしています。

そして今、Macキーボードでは、Apple固有のキープレスが仮想Macによってキャプチャされます。

つまり、Globeキーは、言語の切り替えや仮想Macでのエモーティングなどの機能に使用できます。

では、ロゼッタ2について話しましょう。

Linux仮想マシンのRosetta 2は、macOSで使用されているのと同じ技術であり、macOS Sonomaでは、パフォーマンスの向上により、Rosetta 2は仮想Linux環境でさらに高速に動作します。

これがどのように可能かを掘り下げてみましょう。

Rosetta 2は実行可能なページをオンデマンドで変換し、x86_64アプリケーション全体を翻訳するのを待つよりもはるかに速く実行可能ファイルを起動できます。

しかし、これはまた、アプリケーションの実行中に、Rosetta 2が新しいコード領域を翻訳するために定期的に実行を停止しなければならないことを意味します。

このオーバーヘッドは、コードを初めて翻訳する必要があるため、アプリケーションが実行を開始したときに最も顕著になる可能性があります。

しかし、同じライブラリにリンクしたり、同じ実行可能ファイルを実行したりする別のアプリケーションを起動した場合、Rosetta 2は、そのコードがすでに翻訳されているにもかかわらず、すべての作業をやり直さなければなりません。

この問題はキャッシュで解決できます。

ライブラリまたは実行可能バイナリが翻訳されるたびに、Rosetta 2は結果をディスク上のキャッシュに保存し、それを必要とする他のアプリケーションと共有し、不必要な再翻訳のオーバーヘッドを回避します。

macOS Sonomaでは、仮想化フレームワークは、新しいランタイムデーモンを使用してLinux仮想マシンにこの最適化をもたらします。

これを設定するには、2つのステップが必要です。

まず、Rosetta 2ランタイムと新しいキャッシュデーモン間の通信チャネルを設定するための新しいAPIがあります。

そして、仮想マシンでデーモンを起動する必要があります。

ロゼッタ2ランタイムと新しいデーモンは、仮想マシンで互いに一緒に実行されます。

2つのプログラムは、接続を確立するために仮想化フレームワークと通信します。

動的リンカリクエストは、とりわけ、キャッシュを管理するデーモンに転送され、Rosetta 2ランタイムは事前に翻訳されたバイナリをデーモンから直接取得し、再翻訳のオーバーヘッドを排除します。

コンパイルやパッケージのインストールなど、エグゼクティブの重いタスクに最大の影響が見られます。

仮想化フレームワークを使用すると、アプリケーションに非常に多くの優れたオプションをもたらすことができます。

始める方法について話しましょう。 始める方法について話しましょう。

仮想MacとLinux仮想マシンの両方にサイズ変更可能なディスプレイを使用することを検討してください。

1行のコードでユーザーエクスペリエンスを大幅に向上させます。

Macキーボードは、最新の仮想Macとシームレスに動作するように特別に設計されており、このデバイスで仮想Macを設定することは、ユーザーエクスペリエンスを向上させる簡単な方法です。

これらの機能のいくつかは、強力な体験を構築するために使用できるビルディングブロックです。

仮想マシンを保存する機能はその一例です。

巻き戻しまたは保存の進行状況がアプリケーションにどのように適合するかを調査し始めます。

そして、NBDが提供する柔軟性は信じられないほどです。

NBDは、カスタムIOを必要とするアプリケーションに多くの可能性を解き放つことができます。

これは、仮想マシンがmacOS Sonomaでできることの始まりにすぎません。

ありがとうございます。

仮想化チームは、あなたが構築するものを見るのが待ちきれません。

♪ ♪