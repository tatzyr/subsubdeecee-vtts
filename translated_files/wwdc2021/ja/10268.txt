10268

こんにちは、Xcode Cloudワークフローに関するこのセッションへようこそ。

私の名前はJustinで、TestFlightチームのエンジニアで、同僚のWesleyとKevinと一緒に、Xcode Cloudでワークフローを作成する際のインとアウトを紹介するためにここにいます。

ワークフローはXcode Cloudの中心であり、あなたとあなたのチームがアプリやフレームワークの構築、分析、テスト、アーカイブ、配布を自動化できる継続的な統合を推進します。

それらは柔軟で拡張性があるので、チームの既存の開発および配布プロセスに関するワークフローをカスタマイズできます。

また、Xcode Cloudを使用すると、ワークフロー管理は、すでに使用しているApple開発者ツールであるXcodeとApp Store Connectに統合されます。

このセッションでは、ワークフローを特定のコンポーネントに分解しましょう。

まず、ワークフローを自動的に実行する条件を設定する方法を説明します。

次に、環境を設定するためのオプションについて説明します。

また、ビルドに関する通知を送信したり、それらのビルドをTestFlightに自動的にデプロイしたりするなど、後で実行するアクションとともに、自動化したいタスクに対して複数のアクションを作成する方法も紹介します。

最後に、チームのコラボレーションと生産性を高めるために有用で非常に便利だと思うかもしれないさまざまなワークフローのためのいくつかの戦略があります。

カバーすることがたくさんあるので、始めましょう。

ウェズリーに渡しましょう。

ありがとう、ジャスティン!

私は開発者チームのメンバーとFrutaというアプリで協力しています。

すでにXcode Cloudで稼働しています。

「Meet Xcode Cloud」のセッションをまだ見ていない場合は、最初のワークフローの設定について学ぶために必ずチェックしてください。

ここでは、Xcodeのレポートナビゲーターに統合されており、新しいクラウドタブがあり、チームからのワークフローとビルドを見ることができます。

Frutaアプリをオンボーディングすると、メインブランチを構築するデフォルトのワークフローが作成されました。

このワークフローは私たちにとってうまく機能していますが、プルリクエストも使用するチームであるため、チームが活用できるプルリクエスト固有のワークフローを作成したいと思います。

チームの誰かがプルリクエストを作成するたびに実行し、アプリを分析、テスト、アーカイブし、プルリクエストのビルドが終了したらチームに通知し、アプリのバージョンをチームのメンバーに配信して、主要な統合ブランチにマージされる前に機能をテストできるようにしたいと思います。

ワークフローの作成は簡単です。

[製品] メニューで、[ワークフローの管理] に移動し、[プラス] をクリックし、アプリを選択できます。

これにより、新しいワークフローエディタが追跡されます。

ワークフローは、いくつかの設定可能なコンポーネントで構成されています。

これが私のワークフローに名前を付けることができる一般的なセクションです。

私はこれを「プルリクエスト」と名付けます。

少数の個人だけがワークフローの変更を担当するチームにいたら、チームに影響を与える可能性のある意図しない更新を防ぐために編集を制限することを選択できます。

デフォルトでは、Xcode Cloudはローカル設定の知識でプライマリリポジトリとプロジェクト情報を設定しますが、プライマリリポジトリを移動したり、Xcodeプロジェクトからワークスペースに移行したりする場合は、ここでこれらの設定を変更できます。

次に、開始条件のセクションを見てみましょう。

これは、ワークフローをいつ実行したいかを定義できる場所です。

Xcode Cloudにはいくつかの条件タイプがあります。

このワークフローでは、メインブランチにマージするすべてのプルリクエストに対して実行するように開始条件を設定したいと思います。

これを行うには、タイプメニューから選択し、プルリクエストへのすべての変更を選択できます。

この条件タイプでは、ソースブランチとターゲットブランチを指定できます。

ソースブランチをAny Branch、ターゲットブランチをMainに設定します。

チームメンバーがメインに対してプルリクエストを作成して変更を加えるたびに、Xcode Cloudはこのワークフローを自動的に実行します。

プルリクエストを作成するとき、Xcode Cloudはソースブランチとターゲットブランチのマージを一緒に構築してテストするので、私のチームメンバーは自信を持って、チームの残りの部分との変更の本当の影響を知ることができます。

また、これらの条件を特定のファイルやフォルダに絞り込み、ワークフローの実行時に以前に実行中のビルドを自動キャンセルするかどうかを設定することもできます。

これは、あるコミットを別のコミットの上に連続してプッシュする場合に便利です。

プルリクエストへのすべての変更は、ワークフローに設定できる開始条件の1つに過ぎず、チームのニーズに応じて、それらのニーズを満たすように設定できる他の条件タイプがあります。

ブランチへのすべての変更は、常にソースブランチを構築し、プルリクエストの状態を無視します。

タグへのすべての変更は、新しいタグが作成されるたびに構築されます。

スケジュールでは、選択できる定期的なスケジュールで選択したブランチが構築されます。

時折実行したい長時間のテストがある場合、これは素晴らしいことです。

このワークフローがいつ実行されるかを決定する開始条件を設定したので、ワークフローの実行方法を決定する環境セクションを設定しましょう。

Xcode CloudはAppleのクラウドインフラストラクチャ上で動作し、さまざまなmacOSとXcodeバージョンを利用できます。

XcodeとmacOSのバージョンを選択するには、メニューから選択するだけです。

また、最新のリリースまたはベータ版を指すようにワークフローを設定することもできるので、いつでも最新のソフトウェアでビルドまたはテストできます。

開発者として、私たちは皆、生産性を深く気にかけており、その大部分は使用するツールのパフォーマンスです。

あなたの多くは、多くのファイルを持つ大規模なプロジェクトに取り組み、潜在的に長いビルド時間に対処します。

Xcode内のローカルと同様に、変更されたファイルを構築するだけで、変更を段階的に構築するオプションがあります。

Xcode Cloudにもこのオプションがあります。

これは通常、より高速なビルドにつながります。

しかし、代わりにクリーンなビルドを実行したい場合があります。

これは、最終ビルドですべてが機能していることを確認するために重要であり、TestFlightを使用して外部ベータテスターにデプロイできるビルドを作成したり、App Storeに提出したりすることも必要です。

環境セクションでは、クリーンを選択するオプションがあります。

これはプルリクエストのワークフローなので、パフォーマンスのメリットを活用できるように、チェックを外しておきます。

すべてのチームは独自の方法で作業し、チームは彼らが望むように働くことができる柔軟性を持つために彼らのツールを必要とします。

Xcode Cloudは、最も一般的な開発タスクを箱から出して実行できるオプションを提供します。

ただし、拡張性のためのさまざまなオプションも提供します。

この拡張性により、Xcode Cloudをチームが作業を完了するために使用する他のツールやシステムと接続できます。

Xcode Cloudは、データにアクセスし、ワークフローを設定し、ビルドを開始するための包括的なAPIを提供します。

Xcodeが提供する既存のスクリプトオプションに加えて、Xcodeはビルドとテストを実行しているデバイスで実行されるカスタムスクリプトを作成する機能を追加します。

環境セクションでは、Xcode Cloudがカスタムスクリプトで利用できるようにする環境変数を指定できます。

これは、ソースコードリポジトリにチェックインしたくない設定や秘密に役立ちます。

また、環境変数を秘密としてマークして、余分なレベルの保護を提供することもできます。

これに関する詳細については、「高度なXcodeクラウドワークフローのカスタマイズ」セッションまたはドキュメントを参照してください。

これまでのところ、ワークフローがいつ実行され、いつ実行されるかを設定する方法を示しました。

彼らはどんな環境で走るべきですか?

次に、行動について話しましょう。

アクションは、ワークフローが実行されるたびに、ワークフローがあなたとあなたのチームのために行う作業を定義します。

Xcodeにローカルで実行するように依頼できる重要なアクションは、ビルド、静的分析の実行、テスト、アーカイブなど、Xcode Cloud内ですべて利用可能になりました。

設定したいアクションは、アーカイブ、テスト、分析のアクションです。

アクションでプラスアイコンをクリックし、アーカイブを選択して、アーカイブアクションを追加することから始めましょう。

アーカイブを作成するプラットフォームとスキームを選択する必要があります。

それはすでにiOSプラットフォームとiOSスキームを事前に選択しており、これはまさに私が望んでいたものです。

また、TestFlightに登録するか、App Storeの配布の準備をするオプションもありますが、これについては後で詳しく説明します。

プロビジョニングプロファイルやコード署名IDを管理する必要がなかったことに気付くかもしれません。

Xcode Cloudはこれを自動的に処理します。

これの詳細については、「クラウド署名でXcodeでアプリを配布する」セッションをチェックしてください。

アーカイブアクションが設定されたので、テストアクションに注目しましょう。

アプリのテストは、開発プロセスの非常に重要な部分です。

ユーザーがより少ないバグを経験することを保証するのに役立つだけでなく、あなたが行っている変更に自信を与えることで、開発プロセスをスピードアップすることができます。

しかし、ローカルでテストを実行するのが面倒で遅い場合もあれば、忘れてしまうこともあります。

Xcode Cloudでのテストでワークフローを設定することで、テストは安定した信頼性が高く、再現可能な環境で実行されます。

あなたが他の仕事をしている間、彼らはバックグラウンドで実行され、ローカル環境を解放し、自動的に実行され、手動で実行することを覚えておく必要がないように解放されます。

テストアクションを追加するには、プラスボタンをクリックしてテストを選択するだけです。

テストアクションでは、合格する必要があるかどうかを選択できます。

アクションを必要に応じてマークすることは、このテストアクションが失敗した場合、全体的なビルドが失敗することを意味します。

テストスイートを構築している場合は、全体的なビルド状態に影響を与えないように、これを「合格不要」に設定することを選択できます。

実行するテストの選択に関しては、いくつかの選択肢があります。

「スキーム設定を使用」を選択して、Fruta iOSスキームの設定を参照するか、特定のテストセットに磨きをかけたい場合は、特定のテストプランを選択できます。

そのセットができたら、あとはテストを実行したいシミュレーターを選択するだけです。

Xcode Cloudは、さまざまな画面サイズのシミュレータのコレクションである推奨オプションを提供します。

推奨されるオプションは、常に環境セクションで選択されたXcodeに対してテストされますが、特定のシミュレータを選択すると、古いOSバージョンのリストから選択することもできます。

私が実行したい最後のアクションは、分析アクションです。

コンパイラは、多くのクラスのバグを自動的に見つけ、それらについて警告することができます。

これらに気配って修正することで、実行時にこれらの問題を追跡することと比較して、開発時間を大幅に節約でき、ユーザーに私たちのアプリでより安定したバグのない体験を提供します。

しかし、静的分析の実行は、典型的なローカル反復開発ワークフローの一部ではないため、私たちの多くはそれを実行するのを忘れ、時間の経過とともにチーム全体で問題が増加するのを見るだけです。

Xcode Cloudを使用すると、コードを変更するたびに静的分析が実行されることを確認できます。

分析アクションを追加するには、プラスボタンをクリックし、分析を選択します。

テストと同様に、静的分析の問題を合格が必要かどうかとしてマークするオプションがあります。

今のところ、静的分析の結果を監視したいだけなので、合格に必要としてマークしません。

最後のアクションはビルドアクションです。

場合によっては、簡単なXcodeビルドアクションを実行する必要があるかもしれません。

これは、特定のセカンダリビルド構成またはスキームがまだコンパイルされていることを確認したり、アプリの一部であるフレームワークを独自に構築できるようにしたりするのに役立つかもしれません。

プルリクエストワークフローのアーカイブ、テスト、分析アクションを設定したので、このワークフローにポストアクションを追加するためにケビンに渡します。

ありがとう、ウェズリー。

Xcode Cloudワークフローを使用すると、ポストアクションを設定できます。

ポストアクションは、すべてのビルド、分析、テスト、およびアーカイブアクションが完了した後に実行されます。

Xcode Cloudで設定できるポストアクションは、通知を送信し、TestFlightで展開しています。

まずは通知について話しましょう。

送信できる通知イベントには2種類あります。

1つ目は、ビルドが成功するときです。

すべてのビルド成功の通知を送信するオプションがあります。ブランチまたはプルリクエストビルドが失敗から通過に移行するときの修正のみ。または通知しないでください。

もう1つの通知イベントは、ビルドが失敗したときのものです。

すべてのビルドの失敗に対して通知を送信できます。ブランチまたはプルリクエストビルドがパスから失敗に移行するときは、ブレークのみです。または通知しないでください。

このワークフローでは、プルリクエストのビルドが終了したらチームに通知したい。

アクションセクションの下には、ポストアクションがあります。

通知アクションを追加するには、[プラス]ボタンをクリックして[通知]を選択します。

私はビルドの成功とビルドの失敗のためにすべてを残します。

通知イベントの下には、通知を送信する場所に関するいくつかのオプションがあります。

Xcode Cloudは、人気のあるコラボレーションツールSlackと統合されています。

Slackアカウントが承認されたら、プラスボタンをクリックしてチャンネルのリストを表示できます。

「ci-builds」チャンネルを選択し、[OK]をクリックします。

メールアドレスを追加するオプションもあります。

デフォルトでは、すべてのユーザーが開始したビルドの通知を自動的に受け取るので、このリストに追加する必要はありません。

ただし、グループメールがある場合、または開始していないビルドを受け取りたいユーザーがいる場合は、ここにメールを追加できます。

最後に、Xcode Cloud Workflowsの私のお気に入りの機能の1つである、TestFlightで自動的にデプロイする機能を共有したいと思います。

そして今、MacのTestFlightを使用すると、Appleが提供するすべてのプラットフォームに展開できます。

Xcode Cloudには2つのTestFlight展開オプションがあります。

内部テスターへの展開が強化され、開発チームのメンバーにビルドをすばやく送信できます。

彼らはあなたのチームのメンバーであるため、クリーンを選択せずにプルリクエストとビルドから生成されたビルドを受け取ることができます。

今日TestFlightを使用している場合、外部テストとApp Storeは、あなたがすでに知っていることと同等です。

候補者とリリースブランチに推奨され、ベータアプリのレビューを条件として、外部テスターとApp Storeに配布することができます。

TestFlightは、チームメイトや組織外のベータテスターのデバイスにアプリのビルドを取得するのに最適な方法です。

ワークフローを設定して、ビルドを任意のTestFlightグループに自動的にデプロイできます。

TestFlightグループを、App Store ConnectのTestFlightタブで、今日と同じように管理します。

ここでは、複数の内部グループと外部グループがあり、それぞれが私のワークフローで利用できます。

内部TestFlightグループで自動的にデプロイするには、3つのことを行う必要があります。

まず、アーカイブアクションを追加する必要があります。

次に、アーカイブの展開オプションを内部テストに設定する必要があります。

最後に、TestFlight内部テストのポストアクションを追加する必要があります。

まさにそれを行うようにワークフローを設定しましょう。

このワークフローをQAチームに自動的に展開したい。

これを行うには、まず、iOSのアーカイブアクションをクリックし、TestFlight内部テストのみを選択します。

これを行うことは、私のビルドがTestFlightで利用可能になることを意味します。

ビルドを自動的に誰にも送信したくないが、App Store ConnectのTestFlightセクションから後でそれを行うオプションを保持している場合、これは素晴らしいことです。

このアプリでは、ビルドが生成されるたびに自動的に同僚にデプロイしたい。

これを行うには、TestFlightのポストアクションを追加する必要があります。

ポストアクションの横にあるプラスボタンをクリックして、TestFlight内部テストを追加します。

アーカイブiOSアーティファクトは事前に選択されており、それが私の望みです。

プラスボタンを押して内部グループを追加します。

最後に、QAチームを選択します。

今、私のQAチームのメンバーは、メインブランチにマージされる前に、すべての機能を検証してテストすることができます。

TestFlight外部テストを使用して組織外のテスターにビルドを送信することは、App Storeに提出する前にアプリとその機能に関するフィードバックを得るのに最適な方法です。

このようにして、より幅広いユーザーから変更に自信を持ち、App Storeにリリースされる前に変更を加え、問題を修正できる可能性があります。

TestFlight外部テストで展開するには、さらにいくつかの条件を設定する必要があります。

開始条件で1つのブランチを選択します。

これにより、外部ベータテスターに送信するビルドの一貫性が保証されます。

次に、「環境」セクションで「クリーン」を選択します。

これにより、派生データを使用せずに、コードがゼロから構築されることを保証します。

最後に、アーカイブアクションの展開設定をTestFlightとApp Storeに設定します。

結局のところ、TestFlight外部テストの実行後の設定は、TestFlight内部テストの設定に似ています。

TestFlightで作成された外部グループを追加するだけです。

TestFlight外部テストには、個々のテスターに展開する機能が追加されています。

Xcodeでプルリクエストワークフローを作成しましたが、App Store Connectでワークフローを作成、編集、管理することもできます。

Xcodeから離れていて、ワークフローを変更する必要がある場合は、素晴らしい選択肢です。

ジャスティンに戻って、チームのために作成できるワークフローの種類についていくつかの推奨事項を作成します。

ジャスティン？

ありがとう、ケビン。

Fruta QAチームは、プルリクエストワークフローでビルドにすばやくアクセスすることを気に入っていると思います。

ご覧のとおり、ワークフローには、チームの働き方をモデル化するための多くの力と柔軟性があります。

作業を完了するために必要なだけ多くのワークフローを作成できます。

私は私たちのチームがいくつかを作成することを知っています。

ケビンはプルリクエストのワークフローを紹介しましたが、あなたとあなたのチームが試すことができるより多くのワークフローのためのいくつかのアイデアがあります。

開発チーム以外のユーザーにアプリを表示するには、外部のTestFlightグループに配布するか、App Storeにアプリを提出することができます。

ここでのアイデアは、私のアプリのユーザーが素晴らしい体験をできるように、高品質を強制したいということです。

リリース用に指定されたブランチでワークフローを実行する必要があります。

包括的なテストを実行し、ビルドをアーカイブし、最後に外部のTestFlightグループに展開し、ユーザーの手に展開する必要があります。

よりよく説明するために、私のリリースワークフローをお見せしましょう。

ワークフローが将来のすべてのリリースも確実に構築されるように、リリースブランチのブランチに開始条件を「すべての変更」に設定しました。

徹底的に、このワークフローのすべてのビルドをゼロから生成したいので、「環境」セクションで「クリーン」をチェックしました。

そうすることで、すべてが再びコンパイルされるため、通常ビルド時間が長くなりますが、キャッシュによって引き起こされる問題がないという自信が得られます。

このワークフローには、XcodeとmacOSの特定のバージョンも選択したことに注意してください。

ツールをピン留めすることは、リリースの収束と最終化の重要な部分です。

私たちのアプリがユーザーのiPhoneとiPadの範囲で動作することを確認するために、私はテストセクションでさまざまなシミュレータでテストを実行します。

TestFlight経由でアプリのビルドを配布するために、アーカイブアクションを含め、展開準備をTestFlightとApp Storeに設定しました。

ベータテスターが常に最新のビルドを確実に得るために、外部のTestFlightグループに展開するためのポストアクションを設定しました。

新しいコードがリリースブランチにマージされると、自動的にビルドされ、テストされ、ベータテスターにデプロイされます。

これで、品質が依然として高いという自信を維持しながら、変更に関するフィードバックを迅速に得ることができます。

これは、毎晩より深いテストを実行する、あなたが作成したいかもしれない別のワークフローです。

私のオーバーナイトテストワークフローは定期的に実行され、必要なだけ多くのプラットフォームをカバーするために複数のシミュレータに対してテストします。

テストの失敗はQAチームに報告され、完全にテストに焦点を当てているため、ビルドをどこにも展開する必要はありません。

毎週の頻度で開始条件タイプとして「ブランチのスケジュール」を選択して、毎週平日の夜にこのワークフローを実行するように開始条件を設定しました。

その後、私は月曜日から金曜日の午前1時に私の日を選択しました。

環境セクションでは、新しいツールがリリースされたときにアプリが正常にビルドされるように、最新のXcodeバージョンを選択しました。

アプリを徹底的にテストしたいので、合格するために必要ないくつかのテストプランとシミュレータを選択しました。

静的分析も実行したいので、分析アクションを追加し、合格する必要があります。

以前のテストのいずれかが失敗した場合、QAチームは通知ポストアクションで見つけます。

Build SuccessをDon't Not Notifyに設定し、Build Failure to Allに設定しました。

私のQAチームは独自のSlackチャンネルを持っていますが、メールアドレスを指定することもできます。

いずれにせよ、QAチームは翌朝までにビルドの失敗について知るでしょう。

このようなワークフローを実行することは、あなたとあなたのチームが日中開発を続け、夜にアプリを徹底的にテストするためにXcode Cloudを離れることができるので、時間を節約するための素晴らしい方法です。

そして最後に、Xcodeの製品メニューの下にはワークフローの管理があり、チームが使用するすべてのワークフローを見ることができます。

先ほど作成したオーバーナイトテストのワークフローと、ウェズリーとケビンが以前に作成したワークフローが見えます。

プロジェクトが成長するにつれて、チームのニーズに合わせてワークフローを追加、編集、または削除することができます。

そして、それは私たちのチームのワークフローのためにそれです。

プルリクエストのワークフローを作成する方法、さまざまなプラットフォーム用のアクションを設定する方法、TestFlightユーザーにリリースを配布する方法、夜間テストを設定する方法を示しました。

しかし、ワークフローでできることはもっとたくさんあります。

さらに、App Store Connectからこれらのワークフローを作成および管理することもできます。

ワークフローの詳細については、「高度なXcodeクラウドワークフローのカスタマイズ」をご覧ください。

まだチャンスがない場合は、「Meet Xcode Cloud」を見て、プロジェクトをオンボーディングする方法を学んでください。

クラウド署名とXcodeのプルリクエストの新しいサポートを深く掘り下げる他の素晴らしいセッションもあります。

Xcode Cloudは、あなたのチームに、作業方法に適応し、チームが一貫して開発慣行に従うのに役立つ、柔軟で拡張可能なワークフローを作成する能力を提供します。

このセッションが、あなたとあなたのチームが開発を反復し、高品質のアプリを提供する際に活用するためのワークフローを作成するのに役立つことを願っています。

見てくれてありがとう、そしてWWDCの残りの部分を楽しんでください。

[音楽]。