10137

♪ ♪

こんにちは、WWDCへようこそ。

私はオースティンで、Apps and Books Management APIに取り組んでいます。

新しいAPIバージョンにもたらした改善点を共有し、MDMソリューションがアプリや書籍をこれまで以上に迅速かつスケーラブルな方法で管理できるようにします。

すでにApps and Books Management APIを使用して、製品を使用している組織が所有するアプリや書籍を管理できるようにしている可能性があります。

組織は、Apple School ManagerまたはApple Business Managerを通じてこれらの資産を取得した可能性があります。

また、APIを使用すると、これらの所有するアプリや書籍を組織の管理対象ユーザーやデバイスに割り当てることができます。

今年は、新しいApps and Books APIに多くの変更を導入しました。

このセッションでは、これらの多くをカバーしますが、ワークフローを最も改善する2つの機能強化、リアルタイム通知と非同期処理に焦点を当てます。

その他の変更点の詳細については、developer.apple.comのデバイス管理セクション内の新しい開発者ドキュメントと、このセッションの参考文献を参照してください。

リアルタイム通知から始めましょう。

現在、割り当て、資産、および登録ユーザーに対する状態変更のリアルタイム通知をサポートしています。

これらの通知をオプトインする必要があり、クライアント設定で購読しているタイプの通知のみを受け取ります。

リアルタイムの通知により、状態を継続的に同期する必要がなくなります。

通知の種類についてもう少し詳しく話し合いましょう。

最初の通知タイプは割り当て用です。

割り当てとは、組織が管理するユーザーまたはデバイスに資産が割り当てられることです。

割り当てのグループ全体が正常に実行されたことを確認するのを待たなければならない場合、ユーザーが必要とするコンテンツのインストールが遅れます。

これで、割り当て通知を使用すると、どの割り当てが正常に実行され、どのデバイスに実行されたかをリアルタイムで正確に知ることができます。

これらを受け取るには、クライアント設定で資産管理通知タイプを購読します。

その後、Appleは、アソシエイト、デアソシエイト解除、またはアセットイベントのいずれかによって割り当て状態が変更された場合に通知します。

これで、これらの通知を使用して、ユーザーとデバイスが割り当てられたコンテンツにすばやくアクセスできるようになります。

この通知の例を見てみましょう。 

割り当てが発生すると、この通知が届きます。

この例は、アソシエイトアセットコールによってトリガーされました。

Appleは、クライアント設定であなたが提供した承認ヘッダーに共有秘密でこれらの通知を投稿します。

通知には、特定の通知タイプに固有のペイロードが含まれています。

タイプはここに示され、この通知は資産管理です。

通知ペイロードでは、状態を変更しようとした割り当て、イベントID、このMDMがトリガーした非同期イベントの一意の識別子を見ることができます。

新しいAPIの非同期性については、もう少し詳しく説明します。

これは、成功したか失敗したかにかかわらず、状態変更の結果です。

そして、割り当て状態への変更の種類は、ここではアソシエイトです。

次の通知タイプはアセットです。

アセットは、組織がApple School ManagerまたはApple Business Managerのいずれかで購入したアプリや書籍です。

その組織は、MDMがコンテンツを所有していることを知るまで、資産を管理および割り当てることはできません。

資産通知を使用すると、購入、転送、または払い戻しから資産の変更が発生するとリアルタイムで通知され、MDMは各資産の現在の利用可能な数を常に知ることができます。

これらを受け取るには、クライアント設定でアセットカウント通知タイプを購読します。

その後、購入、譲渡、または払い戻しのイベントにより資産の状態が変更された場合、Appleはお客様に通知します。

これらの通知により、最近購入した資産をユーザーにすばやく提供できます。

また、資産の状態が以前どのように見えたかの文脈で、この通知の例を見てみましょう。

資産の現在の状態を取得するには、「資産を取得」エンドポイントと呼びます。

これは新しいアセット同期エンドポイントで、GETの適切なHTTPリクエストメソッドとバージョン管理されたURIの両方でメモできます。

ここでは、単一の資産の状態を受け取るために、adamIdと pricingParamのクエリパラメータを照会しています。

現在、サーバートークンまたはsTokenは、このベアラートークン形式のすべての新しいAPIリクエストの承認ヘッダーで提供されることを要求しています。

私たちが興味を持っている資産に対するこの応答の資産配列には、割り当てに利用可能な10,000と合計15,000があります。

購入が発生すると、この通知が届きます。

ペイロードには、購入した資産のadamIdが見えます。

次に、デルタは、この場合は正の整数です。

これは、購入または転送のいずれかを示すことができます。

このデルタを使用して、アセット同期エンドポイントに別の呼び出しを行うことなく、カウントを更新します。

最後の通知タイプは登録ユーザー向けです。

ほとんどの展開はデバイスベースの割り当てに依存していますが、ユーザーにコンテンツを割り当てる必要がある場合は、登録ユーザーを作成することが最初のステップです。

これらのユーザーを個人または管理対象のApple IDに関連付けることは、展開に必要です。

ユーザーの個人用Apple IDを特定のsTokenの登録ユーザーに関連付けるには、ユーザーはApple IDを関連付けるための招待を受け入れる必要があります。

これで、登録されたユーザー通知により、最初の作成とその後の招待の受け入れの両方で、ユーザーの最新の状態がリアルタイムで更新されます。

これらを受け取るには、クライアント設定でユーザー管理とユーザー関連の通知タイプを購読します。

その後、ユーザーイベントの作成、関連付け、更新、または廃止によってユーザーの状態が変更されると、Appleが通知します。

ユーザーが関連付けた通知は、ユーザーがApple IDを関連付けるための招待を受け入れたときに、より適切に追跡できるようにします。

以前のユーザーの状態のコンテキストで、これらの通知の例を見てみましょう。

ユーザーの現在の状態を取得するために、get users エンドポイントと呼びます。

これは新規ユーザー同期エンドポイントです。

ここでは、clientUserIdクエリパラメータによって関心のあるユーザーに対してのみフィルタリングします。

これにより、応答サイズは1人のユーザーに制限されます。

ここでは、同期API全体でいくつかの一般的なページネーションフィールドがあり、現在のページインデックス、サイズ、またはこのコンテキストでは、現在のページ内のユーザーオブジェクトの数、および提供されたクエリの合計ページを示します。

ユーザー配列では、この場合、関連付けられているのとは対照的に、登録ステータスと招待コードで、関心のある唯一のユーザーを見ることができます。

このユーザーは明らかにまだApple IDに関連付けられていない。

すべての同期APIにはバージョン識別子も含まれており、基礎となるデータへの書き込みが発生するたびに変更されます。

これは、以前のページのデータがいつ変更されたかを示すために、大きな応答を横断するときに非常に便利です。

新しい更新ユーザーエンドポイントを使用して、管理対象のApple IDを登録ユーザーに関連付けることができます。

これにより、ここで見られるように、登録ユーザー通知が表示されます。

通知ペイロードでは、状態を変更しようとしたユーザー、このMDMトリガー非同期イベントの一意の識別子、状態変更の結果、成功したか失敗したか、ユーザー状態への変更の種類が表示されます。

ユーザー配列を見ると、関心のあるユーザーの状態のclientUserIdが表示され、idHashと関連付けられたステータスが含まれており、管理対象のApple IDの関連付けが成功したと結論付けます。

これを使用して、ユーザー同期エンドポイントに別の呼び出しを行うことなく、このユーザーの状態を更新します。

関連付ける代わりに、自分のApple IDを登録ユーザーに関連付けるための招待リンクをユーザーに提供することが可能です。

ここでは、関連するユーザー通知を見ています。

通知ペイロードには、clientUserId、関連付けられたApple IDを示すidHash、受け入れた招待コード、および関連付けられたステータスを含むがこれらに限定されない、関連付けられたユーザーに関する情報を含むユーザーオブジェクトが表示されます。

これを使用して、ユーザー同期エンドポイントに別の呼び出しを行うことなく、このユーザーの状態を更新します。

これらの通知を受け取るために登録する方法について話しましょう。

管理する各sTokenのクライアント設定でオプトインする必要があります。

notificationAuthTokenとこれらを投稿するためのnotificationUrlで認証するための共有秘密を提供します。

トークンは、これらの通知が実際にAppleから来ていることを確認するために使用され、これはクライアント設定を介していつでも更新できます。

通知を受け取ったときにHTTP 200レベルの応答を提供し、正常に配信されたことをAppleに知らせます。

200以外の応答が返された場合、またはタイムアウトが発生した場合、Appleは通知を再試行しようとします。

Appleはベストエフォートデリバリーを提供します。

この連絡の試みは、通知を破棄する前に数回行われます。

つまり、一定期間通知を受信できない場合は、最新の状態をポーリングする必要があります。

通知を逃した結果、潜在的に古い状態にあるとわかっているものに対してのみ同期します。

この新しいAPIにもたらされた2番目の大きな機能強化は、非同期処理です。

APIの初期バージョンでは、すべての管理が同期的に実行されました。

一部の資産の管理をリクエストすると、同期応答を待つ間、Appleが管理を実行します。

これは、あなたが並列処理したことを意味しますが、非同期処理はApple側でサーバー強制並列処理を可能にします。

これにより、処理が最適化され、より大きな要求がより迅速に処理されます。

注文処理により、特定のリクエストパターンにより、断続的な障害とその後の再試行の量が減少します。

そして、これは最終的にストレスのない大規模な展開につながり、教育のために、より簡単な新学期シーズンにつながります。

Appleはすでに、Apple School ManagerとApple Business Managerの両方でアプリや書籍、購入、転送の非同期処理の恩恵を受けており、組織は数時間ではなく数分で手持ちの在庫を見ることができます。

素晴らしい新しいアプリと書籍の管理体験を作るために、これらすべてがどのように組み合わされるかを見てみましょう。

10,000人のユーザーで管理する組織があり、それぞれが独自のデバイスを持っているとします。

そして、日常業務に不可欠な25のアプリを各デバイスに割り当てるよう求められます。

あなたは25万の課題を実行することを検討しています。

あなたが以前にこれをどのようにやったかを見てみましょう。

あなたのサーバーは、ライセンスを管理するようにAppleに要求します。

Appleは同期的にあなたに応答を返します。

この応答には、要求されたデバイスに割り当てられたライセンスが含まれます。

この単一のリクエストは、最大10台のデバイスまで1つのアプリのみを管理し、その結果、割り当ては10個のみになります。

これには、250,000の割り当てを実行するために最低25,000のリクエストが必要です。

新しいAPIでは、この25,000の最小リクエストはわずか10リクエストになり、非同期処理に移行することですべて可能です。

これを達成する方法を見てみましょう。 

左側に、通知サーバーが追加されました。

プロセスは、資産管理をAppleに要求することから始まります。

リクエストでは、承認ヘッダーにsTokenを入力します。

1つのリクエストで複数の資産を提供できるようになりました。現在、最大25までです。

この動的制限はサービス設定で公開され、割り当てを実行するために最大1,000台のデバイスを提供し、別の動的制限もサービス設定で公開されます。

Appleはあなたに同期的に応答を返します。

この応答には、この新しいAPIにとって重要なHTTPステータスコードがあります。

エラーに対して適切な非200ステータスコードを返すので、続行する前に、最初に応答を尋問して200であることを確認する必要があります。

次に、最も重要なことは、この非同期イベントの一意の識別子があり、そのステータスは、新しいイベントステータスエンドポイントを呼び出すか、一致する割り当て通知を待つことによって取得できます。

割り当てが完了すると、あなたが購読していると仮定すると、Appleはあなたに通知を投稿します。

これらの通知のそれぞれには、通知ペイロードにリストされている要求された割り当てのサブセット、割り当てに関するメタデータ、成功か失敗か、タイプ、および対応するイベントIDを示します。

これらの成功した割り当て通知を待ってから、リストされているデバイスへのインストールコマンドの送信を続行する必要があります。

新しい管理エンドポイントのもう1つの利点は、注文です。

あるユーザーグループから別のユーザーグループにいくつかのアセットを再割り当てするリクエストを受け取ったとします。

これは、アソシエイトに続いてアソシエイトを順次発射することで達成できます。

まず、解除リクエストを投稿します。

その後、Appleは解除者のイベントIDで応答します。

次に、後続のアソシエイトリクエストを投稿します。

Appleは別のイベントIDで応答しますが、今回はアソシエイトのために応答します。

あなたが購読していると仮定すると、Appleは解離が完了するとあなたに通知を投稿します。

その後、関連付けが完了すると、Appleはあなたに通知を投稿します。

通知などのAPIの大きな変更により、状態をAppleと同期に保つことができ、最新の状態であることを確認するために継続的に要求する必要がなくなります。

非同期処理により、従業員や学生が必要なコンテンツへのアクセス、大規模な展開を迅速に実行するIT管理者、組織の資産を効果的に管理するなど、誰もがより良い体験をすることができます。

レガシーAPIは、現時点では引き続きサポートされます。

新しいAPIバージョンとレガシーAPIバージョンを同じトークンと組み合わせて使用することは、正式にはサポートされないことに注意してください。

この新しいAPIは、アプリと書籍管理の今後の道であり、今日利用可能です。

できるだけ早くこの新しいAPIをテストして統合し、可能な限り最高のアプリと書籍管理体験をユーザーに提供することを楽しみにしています。

詳細については、更新された開発者ドキュメントをご覧ください。

お時間をいただきありがとうございます。WWDCの残りの部分をお楽しみください。

[エーテルパーカッション音楽]。