10092

♪ベース音楽の演奏♪

♪

エドワード:こんにちは、WWDCへようこそ!

私はウォレットチームのエンジニアであるエドワードで、後で同僚のラスが加わります。

私たちは今日ここにいて、WalletとApple Payの新機能についてお話しできることをとても楽しみにしています。

今日は3つの主要な分野について話したいと思います。

まず、ウォレットの最新情報を共有し、昨年のエキサイティングなロールアウトについてお話ししたいと思います。

第二に、Apple Payに多くのエキサイティングなアップデートを行いました。

また、いくつかの新機能を追加し、支払いをさらに使いやすくしました。

第三に、私たちが行ったいくつかの新しいAPI強化をしたいと思います。

では、ウォレットのアップデートから始めましょう。

基調講演で聞いたことがあるかもしれませんが、私たちはApple WalletにIDカードを導入しています。

米国では、いくつかの州で、運転免許証や州IDをスキャンしてセルフィーを撮ることができます。

あなたのIDはセキュアエレメントによって保護されています。

TSAは、デジタルIDを使用できる最初の場所として、空港のセキュリティチェックポイントを有効にするために取り組んでいます。

これの詳細については、このセッションに関連するリンクを確認してください。

また、iOS 15では、HomeKitに接続されたロックのサポートが追加されたので、ユーザーはタップしてホームキーパスでドアのロックを解除できるようになりました。

パスの追加に関しては、多くのユーザーがウェブから直接インストールすることを知っています。

たとえば、iOS 14では、映画のチケットを4枚追加したい場合は、個別に追加します。

今年新しく、Safariからマルチパスダウンロードを追加しました。

簡単な変更で、パスをバンドルして、ユーザーの体験をスムーズにすることができます。

これを行うには、3つのことを行う必要があります。

まず、PkPassファイルを一緒に圧縮します。

次に、ファイル拡張子を.pkpassesに設定します。

そして最後に、正しいマイムタイプを使用してください。

これで、バンドル内のすべてのパスが1回のダウンロードでWalletによってダウンロードされ、処理されます。

そして、これらすべてのパスでは、それらをすべて追跡するのが面倒な場合があります。

また、多くの人が古いパスを削除するのが好きではなく、代わりに記念品として持っていることを好むことを知っていますが、それは財布を雑然とさせる可能性があります。

iOS 15では、Walletは期限切れのパスを自動的に非表示にし、パスを整理して見つけやすくするようになりました。

これを利用する方法の例をお見せしましょう。

ここでは、サンプルパスからいくつかのJSONを参照してください。

ウォレットは3つのフィールドを見て、パスを自動的に非表示にする必要があるかどうかを判断します。

第一に、パスの有効期限は現在の日付より古いです。

2、関連する日付は1日より古いです。

または3つ、パスは無効になっています。

ユーザーにとって素晴らしい体験を確実にするために、これらのフィールドがパスに正しく設定されていることを確認する必要があります。

さて、Apple Payのアップデートについてお話ししましょう。

Apple Payは、iPhone、iPad、Apple Watch、Macで支払いを行う最も簡単な方法であり続けています。

これにより、ユーザーはアプリやウェブ上で支払いを行うことができます。

Apple Payは、iMessageとビジネスチャット、および合理化された瞬間的な体験のためのApp Clipsでもサポートされています。

世界中のApple Payの使用量は増加し続けています。

今年はメキシコ、イスラエル、南アフリカでサポートを追加しました。つまり、Apple Payは現在、世界中の55の国と地域で利用可能です。

より多くの場所でエクスプレス・トランジットのサポートを追加しました。

また、ブラジルなどの場所では、クレジットカードとデビットカードの組み合わせのサポートも含まれています。

さて、素晴らしい支払い体験を生み出すために、アプリやウェブサイトに加えることができるいくつかの変更をお見せしたいと思います。

昨年、Apple PayでレンタルやApple Payでチャージするなど、より多くのボタンタイプのサポートを追加しました。

今日はもう1つ紹介します：Apple Payを続けてください。

他のボタンと一緒にカートでApple Payを提供する場合は、このボタンを使用する必要があります。

アクションの呼び出しとしてContinueを使用できます。

また、Apple Payボタンの新しいJavaScript実装も導入しています。

この新しいボタンは、現在のすべてのボタンの種類とスタイルをサポートしています。

実装が簡単で、サイトのデザインに合わせてカスタマイズできます。

以下は実装の例です。

ご覧のとおり、ボタンのサイズとスタイルは簡単に設定できます。

スタイルには「apple-pay」という接頭辞が付いていることに注意してください。

これの詳細については、Apple Developer Portalのドキュメントをご覧ください。

次に、iPhoneとiPadのApple Payに加えた大きな変更をお見せしたいと思います。

iOS 15では、まったく新しいApple Pay体験で支払いをさらに良くすることに興奮しています。

まったく新しいデザインでSwiftUIでApple Payシートを一から再構築しました。

それは素晴らしい新しい外観で、ユーザーにさらに明確でスムーズな支払い体験を提供します。

また、コンバージョンを改善するためにいくつかの新機能を実装しました。

Apple Payを初めて使用するユーザーのために、支払いシートからカードと住所を追加するフローを簡素化しました。

既存のユーザーは、Apple Payエクスペリエンスを離れることなく、別のカードを追加できます。

また、問題が発生したときにより明確にするために、エラー処理を再設計しました。

ユーザーが新しい支払い方法の追加を完了すると、シームレスに取引を再開します。

また、支払い項目、割引、小計など、より詳細な情報を表示する新しいサマリービューを追加しました。

iOS 15の新機能では、サマリービューにアプリのアイコンも表示されます。

ウェブでの支払いについては、支払いの概要ビューにウェブクリップアイコンが表示されています。

Apple Payでは、これは以前はMacからハンドオフを使用して取引を完了する場合にのみ表示されていました。

今、あなたのウェブサイトのアイコンは、支払いが正しい場所に行くことをユーザーに視覚的に安心させるために、Apple Payトランザクション内で表示できます。

ウェブ上でApple Payを受け入れ、ウェブクリップのアイコンをまだ設定していない場合は、アイコンをユーザーに表示することを強くお勧めします。

これを行うには、ルートドキュメントフォルダに表示されているサイズで2xと3xのアイコンを指定する必要があります。

その後、Apple Payは自動的にこのアイコンを取得し、支払い要求とともに表示します。

この実装に関する詳細情報は、Apple Developerサイトのヒューマンインターフェースガイドラインセクションに記載されています。

アイコンサイズをテーマにしていますが、PKPassの新しいアイコンサイズの要件を思い出させてください。

iOS 15の通知では、より大きなアイコンが表示されるようになったため、アイコンがぼやけることなく表示されるように、PKPassアイコンを1倍で最低38x38に更新する必要があります。

また、トータルラインにより多くの柔軟性を導入できることを嬉しく思います。

これにより、支払いが後で発生した場合に日付を追加できます。たとえば、予約注文を受ける場合や定期的な支払いの頻度を追加する場合などです。

私たちが今観察した新機能の多くは、いくつかの簡単な変更でアプリに追加できます。

それでは、iOS 15で導入するAPIの機能強化を詳しく見ていきます。

出荷日の範囲のサポートを追加させていただきます。

これで、Apple Pay内で関連する配送または集荷時間をユーザーに提示できます。

これらは、店舗でのピックアップの推定出荷日または配達日または時間枠を設定するために使用できます。

この追加情報は、メインのApple Payビューに表示されます。

新しい出荷日APIには、カレンダーとタイムゾーンのサポートが組み込まれています。

これにより、アプリでの出荷日や集荷時間の処理が簡単になり、関連情報がユーザーに明確に表示されます。

次に、これがどのように機能するかを簡単にお見せします。

私たちは、以前と同じPKShippingMethodを使用して通常の配送方法を定義することから始めます。

次に、カレンダーを選択します。

この例では、ユーザーの現在のカレンダーを使用します。

私たちは今日を参考にして、この日から3日から7日の間に到着を推定します。

次に、カレンダーを使用して日付範囲の開始日と終了日を決定します。

最後に、日付を適切な日付コンポーネントに変換し、配送方法に追加します。

単純な日付ではなく日付コンポーネントを使用しているため、iOSに組み込まれている豊富なカレンダーとタイムゾーンのサポートを利用できます。

これにより、他の方法では不可能なユースケースが可能になります。

たとえば、ユーザーの現在のタイムゾーンに関係なく、ピックアップ時間に正しいタイムゾーンを指定できます。

このレベルの詳細により、特定のピックアップ時間を表示するなど、ユーザーに最も適した日付と時刻情報を表示することもできます。

ウェブ上にApple Payに相当するJavaScriptを含めました。

日付コンポーネントの範囲は、Swiftとは少し異なる方法で指定されていることがわかります。

日付コンポーネントは、サポートされているピックアップタイプと組み合わせて使用できます。

たとえば、アプリでピックアップ時間を表示できます。

日付範囲に加えて、読み取り専用の配送先住所を宣言できるようになりました。

これを使用して、特定のピックアップ場所をユーザーに通知できます。

これを有効にするには、PKContactのインスタンスとして住所の詳細を入力する必要があります。

この例では、必要なすべてのアドレスコンポーネントを設定できるように、郵便住所をCNMutablePostalAddressとして作成しました。

配送先の連絡先を支払いリクエストに追加できるようになりました。

最後に、編集モードを宣言し、必要な出荷フィールドを指定します。

PKContactに含まれるアドレスフィールドは、読み取り専用としてユーザーに表示されます。

この例では、ユーザーが編集できない集荷先住所を提供しました。

そして、これはウェブ上のApple PayのJavaScriptに相当するものです。

shippingContact辞書を設定し、shippingType、shippingContactEditingMode、およびrequiredShippingContactFieldsを設定し、JavaScript支払い要求の他のフィールドを含めます。

詳細については、開発者ポータルのApple Payセクションにあるドキュメントをご覧ください。

iOS 15のもう1つの素晴らしい新機能は、クーポンコードのサポートです。

これで、ユーザーは支払いを開始すると、プロモーションコードを入力できます。

これは、ユーザーが割引コードを適用するのを忘れた場合、Apple Payの取引をキャンセルする必要がないようにするためのものです。

また、ユーザーが製品ページまたはショッピングカートからチェックアウトできるエクスプレス購入フローがありますが、クーポン入力フィールドはチェックアウト時にのみ表示されます。

支払い要求を更新する方法を提供しているので、必要に応じて割引コードを検証したり、エラーメッセージを返すことができます。

飛び込んでコードを見てみましょう。 

クーポンコードがユーザーによって変更されるたびに更新を実行するデリゲートメソッドを使用して変更を加えることができます。

たとえば、これを使用してコードを検証し、支払い合計を更新できます。

また、この方法を使用して、カスタマイズされたエラーを返したり、支払いの概要アイテムと配送方法を更新したりすることもできます。

ラスはまもなくこの例を詳しく紹介します。

可能な限りコードを事前に入力し、無効なコードに関連するエラーメッセージを表示することをお勧めします。

iOS 15用のこれらのエキサイティングなAPI機能強化を楽しんだことを願っています。

理論的にこれについてすべて話したので、デモのためにラスにあなたを引き渡すので、これらすべての素晴らしい新機能を実装する方法を見ることができます。

ラス・フェネンガ:ありがとう、エドワード。みなさん、こんにちは。

私の名前はラスで、ウォレットチームのソフトウェアエンジニアです。

そして、iOS 15で支払いシートに追加した素晴らしい新機能のいくつかと、それらをアプリに統合する方法をあなたに示すことができることに興奮しています。

では、始めましょう!

ここに私が計画しているフードフェスティバルのチケット購入アプリがあります。

私のアプリは、Apple Payの支払いシートを利用するために、PKPaymentAuthorization ControllerDelegateの既存のプロトコル方法をすでに実装しています。

iOS 15では、支払いシートは追加の作業なしで自動的に新しい外観に更新されます。

iOS 15へのアップデートで、フェスティバルの参加者が最終的に複数の方法でチケットをリクエストできるようにしたいと決めました。

これを行うには、複数の配送方法のサポートを追加する必要があるので、飛び込みましょう!

PaymentHandlerクラスに向かい、PKPaymentRequestを構築し、複数のPKShippingMethodsのサポートを追加し始めます。

最初に追加するのは、ユーザーが利用できるさまざまなオプションを表すPKShippingMethodsの配列を返すヘルパー関数です。

私が作成した最初のPKShippingMethodは、標準的な配送方法であり、フェスティバルでチケットを受け取ることができることをユーザーに知らせます。

iOS 15の新機能で、チケットが出荷されるまでにかかる推定範囲をユーザーに提供したい。

これを行うには、日付とカレンダーオブジェクトを作成し、今から3〜5日後に出荷開始日と出荷終了日を定義します。

その後、支払いシートでユーザーに表示する日付コンポーネントを指定できます。

次に、PKShippingMethodを構築し、新しいプロパティdateComponentsRangeを設定し、2つの配送方法の配列を返します。

最後に必要なのは、PKPaymentRequestに配送方法を設定することです。

これらの簡単な変更で、私はアプリを構築し、支払いシートで新しい配送方法をチェックすることができます。

配送方法を示す新しい行が支払いシートに自動的に追加されました。

行をタップすると、日付範囲をサポートするものを含め、追加されたばかりの両方の配送方法が表示されます。

また、今年のフェスティバルでは、すべての参加者にクーポンコードを送信し、アプリの支払いシートから直接引き換える機能を追加したいと決めました。

これを行うには、私が行う必要がある2つの主な変更があります。

コードに戻りましょう。

1つ目は、PKPaymentRequestを構築するときです。

trueに設定する必要がある新しいブール値、supportsCouponCodeがあります。

また、PKPaymentRequestで設定して、すでに有効なクーポンコードの1つをクーポンフィールドに事前に入力できるように、新しいオプションのプロパティ、クーポンコードもあります。

次に、PKPaymentAuthorization ControllerDelegateに準拠したクラス拡張機能にジャンプし、新しいプロトコルメソッドpaymentAuthorizationController didChangeCouponCodeを実装します。ここでは、要約アイテムの更新を処理し、クーポンコードが入力されたときにクーポンコードエントリに関連するエラーを表示できます。

最初に必要なのは、有効なクーポンコードが入力された場合にPKPaymentSummaryItemsを更新するヘルパー機能です。

私は、私たちの小計項目である最初の要約項目への参照をつかみます。

そこから、ユーザーが適用された割引を確認できる新しいPKPaymentSummaryItemを作成します。

次に、税金と合計の新しい要約項目を作成し、それらの配列を返します。

割引アプリケーションロジックが書かれたので、クーポンコードの検証ロジックを書くことができます。

最初に、ユーザーが入力したクーポンコードが空であるかどうかを確認し、空の場合は、変更されていない支払い要約項目で完了パスを呼び出すだけです。

入力されたクーポンコードが有効なクーポンコードと一致する場合は、作成したばかりのapplyDiscount関数を使用して、更新された要約アイテムをCouponCodeUpdateオブジェクトに返します。

アプリの場合、この時点でサーバーから有効なクーポンコードを取得する必要がある可能性が最も高いです。

最後に、入力されたクーポンコードが無効な場合は、新しいPKPaymentRequestコンビニエンティニシャイザー、paymentCouponCodeInvalidErrorを使用し、支払いシートに直接表示する説明を入力します。

また、期限切れのクーポンコードの2番目の便利な初期化子もあります：paymentCouponCodeExpired ErrorWithLocalizedDescription。

次に、このエラーをクーポンコード更新初期化子と元のSummaryItemsに渡します。

そのように、私はアプリ内にクーポンコードのサポートを追加しました。

調べてみましょう。

クーポンコードを入力するには、サマリービューをタップして、クーポンコードのテキストフィールドにクーポンコードを入力するだけです。

最初に無効なクーポンコードFestを入力すると、入力したエラーメッセージがテキストフィールドのすぐ下に表示されます。

有効なクーポンコード「FESTIVAL」を入力すると、支払いの概要項目がすぐに更新されます。

その後、配送先と配送先住所を選択するだけで、支払いリクエストの準備が整いました。

これらの簡単な変更により、Apple Payサンドボックス環境のデバイスで支払いシートの更新をテストする準備が整いました。

さて、エドワードに戻ります。

エドワード:ありがとう、ラス。

ラスは、複数の配送方法、新しい日付範囲、クーポンコードAPIを実装するのがいかに簡単かを示しました。

今年は、ホームキーパス、身分証明書、期限切れのパスの非表示、複数のパスの取り込みなど、ウォレットにいくつかのエキサイティングな新しいアップデートを提供しました。

ウェブ上のApple Payの新しいJavaScript支払いボタンと、iOSの新しいApple Pay体験を導入しました。

日付範囲と読み取り専用アドレスのサポート、クーポンコード、およびこれらを自分のアプリに実装する方法など、新しい出荷APIについて学びました。

詳細については、開発者ポータルのApple Payセクションをご覧ください。

これには、アプリやウェブサイトからの支払い要求をテストするためのApple Payサンドボックスが含まれます。

ご覧いただきありがとうございます。

♪