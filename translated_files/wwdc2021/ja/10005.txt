10005

こんにちは。

私の名前はヤンです。BluetoothデバイスをApple Watchに接続する新しい方法についてお話ししたいと思います。

まず、Core BluetoothがwatchOS 7でどのように機能するかを確認します。

次に、watchOS 8のエキサイティングな新機能について話します。

そして、Apple Watchで動作するようにアクセサリーとアプリをデザインする最良の方法について説明します。

今日のCore Bluetoothの仕組みから始めましょう。

アプリがフォアグラウンドにある間、またはバックグラウンドセッション中にのみ、Bluetoothデバイスに接続できます。

これは、人が自分のアクセサリーから情報を得るためにあなたのアプリに集中したいときに最適です。

しかし、アクセサリーからの情報を複雑にしたい場合はどうなりますか?

現在、人がアプリを開かない限り、コンプリケーションは更新できません。

watchOS 8では、バックグラウンドアプリの更新中にBluetoothアクセサリを接続できます。

これにより、アクセサリの情報でコンプリケーションを更新したり、バッテリー残量が少なくなった場合にローカル通知を送信したりできます。

私の例の温度センサーで、コンプリケーションで温度を更新できるので、時計をちらっと見るたびに見ることができます。

私たちの例では温度センサーを使用していますが、誰かが一目で情報を見たいと思うアクセサリーかもしれません。

バックグラウンドアプリの更新中にBluetoothの使用を開始するには、Info.plistのUIBackgroundModesにbluetooth-centralを追加するだけです。

これは、「必要なバックグラウンドモード」と「アプリはCoreBluetoothを使用して通信する」と表示されることもあります。

これは、プラットフォーム間の違いを示す表です。

これらは、Bluetooth Low Energyで現在サポートされている構成です。

アクセサリがApple Watchとどのように通信するかを掘り下げてみましょう。

ユーザーがすでにあなたのアクセサリーとペアリングしていて、あなたのWatchアプリを開いたとしましょう。

アプリはアクセサリに接続しようとし、広告が表示されるとすぐにBluetooth LE接続が確立されます。

ユーザーがwatchOSアプリを終了すると、Bluetooth接続が終了します。

Bluetooth接続は、次回watchOSアプリのランタイムが利用可能になるまで利用できません。

watchOS 8の次のバックグラウンドアプリの更新中に何が起こるかを分析しましょう。

アプリは既知の周辺機器への接続を開始し、次回広告を受信すると、Apple Watchがアクセサリに接続します。

データの取得が完了するとすぐに、Bluetooth接続を終了し、データを処理できます。

バックグラウンドアプリの更新はいつでも発生する可能性があるため、Apple Watchに表示する重要なアップデートがある場合は、アクセサリをできるだけ頻繁に宣伝する必要があります。

さて、あなたのアクセサリーが電力を節約するためにめったに宣伝しないとしましょう。

バックグラウンドアプリの更新中に広告が受信され、接続が発生しない可能性があります。

バックグラウンドアプリの更新は特定の時間に行われることは保証されていないため、重要なアップデートがあるときはいつでも、アクセサリを頻繁に宣伝する必要があります。

考えられる戦略の1つは、アクセサリのセンサーデータをバッファリングすることです。

バッファ制限に近づいたら、広告率を上げて、Apple Watchに再接続する可能性を高めます。

ガイドとして、理想的なRF条件で少なくとも2秒ごとに宣伝する必要があります。

デバイスがより困難なRF状態で動作することを期待する場合は、再接続の可能性を高めるために、アクセサリをより頻繁に宣伝する必要があります。

アプリがCore Bluetoothとどのように相互作用するか、watchOSがBluetoothアクセサリとどのように相互作用するかを見てみましょう。

これはタイムダイアグラムフローです。

時間は上から下へと進みます。

アプリがフォアグラウンドにあるときに何が起こるかから始めましょう。

あなたのアクセサリーは広告です。

新しいデバイスをスキャンして、Bluetoothアクセサリを検出できます。

デバイスが発見されたら、それへの接続を開始できます。

Apple Watchが広告を受け取るとすぐに接続されます。

Bluetooth接続が完了したら、cancelPeripheralConnectionを呼び出すと、Bluetoothデバイスが切断されます。

その後、後でApple Watchの画面がオフになると、watchOSアプリは一時停止されます。

では、次のバックグラウンドアプリの更新で何が起こるかを見てみましょう。

経過時間はスケールではないことに注意してください。

アプリがBluetoothアクセサリに再接続する必要がある場合は、接続を開始できます。

ここで接続が確立されます。

前述のように、必要な時間だけアクセサリーに接続することを強くお勧めします。

必要なデータを取得し、バックグラウンドアプリの更新中に切断をリクエストする必要があります。

この場合、データ転送が完了し、アプリは周辺接続をキャンセルします。

別の潜在的なユーザーフローを見てみましょう。

この1つでは、BluetoothアクセサリはApple Watchの近くにないか、バックグラウンドアプリの更新中に広告を掲載しません。

バックグラウンドアプリの更新期間中にこれを管理する方法は次のとおりです。

まず、周辺機器に接続しますが、広告はありません。

有効期限ハンドラが呼び出されたら、接続をキャンセルするように依頼する必要があります。

このようにして、あなたはきれいなスレートを持ち、次のバックグラウンドアプリのリフレッシュの開始時に再接続を依頼することができます。

バッテリーを節約するために、有効期限ハンドラが呼び出される前に接続をキャンセルすることも良い習慣です。

次のバックグラウンドアプリの更新で再接続する必要がある場合は、connectPeripheralを再度発行できます。

Apple Watchが広告を見るとすぐに、あなたのアクセサリーに接続します。

この時点で、必要なすべてのデータを取得してダウンロードできます。

その後、接続が完了したらすぐに切断できます。

最後のフローを見て、バックグラウンドアプリの更新中に切断しないとどうなるかを見てみましょう。

接続を開始します。

Apple Watchが広告を見るとすぐに、接続を確立します。

ここでは、バックグラウンドアプリの更新が期限切れになる前に、アプリがすべてのデータを取得する時間がなかったとしましょう。

この場合、Core Bluetoothは、次のバックグラウンドアプリの更新の終了時に自動的に接続を終了します。

次のバックグラウンドアプリの更新で、アプリはdiddleDisconnectPeripheralイベントを取得します。

この時点で、アプリが必要な場合は、Bluetooth接続を開始するか、次のバックグラウンドアプリの更新まで待つことができます。

必要な時間だけアクセサリーに接続することを強くお勧めします。

アプリは、バックグラウンドアプリの更新中に切断を要求する必要があります。

これを実装するためのコードを詳しく見てみましょう。

誰かがフォアグラウンドでアプリを起動すると、周辺機器を検出して接続できます。

didDiscoverPeripheralデリゲートメソッドは、広告が検出されたときに呼び出されます。

過去にCoreBluetoothを使用したことがあれば、これはよく知られています。

では、バックグラウンドアプリの更新中に何が起こるかを見てみましょう。

handleBackgroundTasksデリゲートメソッドが呼び出されます。

バックグラウンドワークのいずれかを開始できます。私たちの場合は、Bluetooth周辺機器に接続したいと考えています。

バックグラウンドアプリの更新中、終了直前に、バックグラウンドアプリの更新が終了しようとしているという通知も届きます。

これはwatchOS 8の新しいAPIです。

これを使用して、既存の作業をキャンセルし、アプリケーションを一時停止モードにする準備をすることができます。

次に、タスクを完了として設定します。

また、バックグラウンドランタイムを取得するときは、Bluetoothデバイスが切断されたときの動作を決定する必要があります。

コールバックdidDisconnectPeripheralは、フォアグラウンドまたはバックグラウンドアプリの更新中に発生する可能性があり、すべてのプラットフォームで発生することを忘れないでください。

ここで、didDisconnectPeripheralがある場合、WatchKit Extensionデリゲートに存在するdidCompleteDisconnectionという関数を呼び出します。

このようにして、この機能の動作はwatchOSに固有のものです。

didCompleteDisconnection関数が行うことは、バックグラウンドアプリの更新にあることを確認し、もしそうなら、タスクが完了したことを示します。

これにより、バックグラウンドアプリの更新が終了します。

Apple WatchでCore Bluetoothを使用するためのベストプラクティスについて話しましょう。

初めてのデバイス設定では、アプリがフォアグラウンドで実行されている必要があります。つまり、ユーザーはWatchアプリを積極的に使用しています。

この時点で新しい周辺機器をスキャンします。

アプリが周辺機器を発見したら、最初のBluetooth接続を設定できます。

必要に応じて、デバイスとペアリングすることもできます。

アプリがフォアグラウンドを終了すると、新しい周辺機器をスキャンすることはできません。

代わりに、以前に発見された周辺機器への接続を要求する必要があります。

接続したら、必要なデータを取得します。

データの取得が完了したら、アプリはバッテリーを節約するために周辺機器から切断する必要があります。

バックグラウンドアプリの更新が終了する前にアプリが切断されない場合、Core Bluetoothは自動的にアクセサリから切断されます。

アプリにランタイムがある場合にのみ再接続できます。

Core Bluetoothについて質問がある場合は、今週私たちのラボに参加することをお勧めします。

ありがとう。

[音楽]。