10069

♪ベース音楽の演奏♪

♪

エリック・ホーンバーガー:研究とケアアプリのコードアロングへようこそ!

これは、あなたと私が友人のジェイミーのために理学療法アプリを構築する3部構成のシリーズのパート2です。

フォローしたい場合は、セッションリソースで私たちのプロジェクトを見つけることができます。

先に進んで、ここにログインします。

セッション1に参加した場合は、オンボーディングと同意を終えたばかりであることを思い出すでしょう。

このセッションでは、ああ、ちょっと待って。

ジェイミーからメッセージを受け取ったようです。

「アプリの新しいアイデアがいくつかある。」

「私の最後のメールを見ましたか？」

追加のアプリ要件。

ジェイミーは、ノート文書の共同作業にあなたを招待しました。

さて、今回は何をするか見てみよう！！ よし！

フォームの表示、一部のデータの保持、動的スケジュール、可動域。わかりました。

だから、ジェイミーは、彼らがどれだけの睡眠をとったか、彼らがどれだけの痛みを経験しているかについて参加者に尋ねる毎日のチェックイン調査を設定することを望んでいるようです。

ResearchKitのフォームアイテムを使用して、1つのページに複数の質問を置く方法を紹介します。

次に、ResearchKit調査の結果を解析し、CareKitに保持する必要があります。

これにより、完了リングがいっぱいになり、タスクカードのUIが更新されます。

また、CareKitでより高度なスケジュールを作成する方法について詳しく説明し、ResearchKitと一緒にこれらのスケジュールの1つを使用して、参加者に膝の可動域を測定するよう促します。

ここではカバーすることがたくさんあるので、飛び込みましょう！

毎日のチェックイン調査から始めます。

オンボーディングタスクで行ったように、スケジュールとCareKitタスクを定義することから始めます。

毎日のチェックインのはずなので、毎朝午前8時にスケジュールしましょう。例えば、午前8時にしましょう。

一意の識別子と先ほど定義したスケジュールを使用して、チェックインタスクを作成します。

そしてもちろん、私たちはここ私たちの店でそれを維持する必要があります。

これはすべて、オンボーディングタスクで行ったのとまったく同じです。

うまくいけば、それはあなたに馴染みを感じ始めています!

そして、オンボーディングタスクと同様に、次のステップはCareFeedViewControllerにジャンプして、このタスクを表示する方法をCareKitに伝えることです。

今回は、私たちの解決策をもう少し一般的なものにしましょう。

現在の日付のすべてのタスクを取得します。 

次に、タスクごとにビューコントローラーを作成し、そのビューコントローラーをリストに追加します。

これは、タスクを追加するにつれて、もう少しうまく拡張されるはずです。

現在、このfetchTasksメソッドまたはこのviewControllerメソッドを実際に定義していません。

ファイルをもう少し下にドロップダウンして、それらを書き出す必要があります。

これが私たちのfetchTasksメソッドです。

まず、特定の日付のタスククエリを作成し、スケジュールされたイベントがないタスクを除外することを指定します。

これは、毎日起こらないタスクがあるときに機能します。

例えば、毎週月曜日に薬を服用するための処方箋を与えられたとしましょう。

火曜日と水曜日には、その処方箋はまだあなたに割り当てられていますが、服用する薬はありません。

このプロパティは、そのようなタスクがクエリから返されないことを保証します。

クエリが戻ってきたら、フェッチしたタスクを完了ハンドラに渡します。

また、タスクを受け取り、ビューコントローラーを返すメソッドに記入する必要があります。

タスクのIDを検査し、チェックインタスクの場合は、パート1で導入した新しいSurveyTaskViewControllerを使用します。

以前と同様に、タスク、eventQuery、およびstoreManagerへの参照を提供します。

また、ResearchKitの調査と、ResearchKitの結果をCareKitの結果値の配列に変換する機能に合格する必要があります。

これら2つの方法をすぐに書きますが、まず、アプリ、ResearchKit、CareKitがどのように連携するかを見てみましょう。

私たちのアプリはResearchKit調査を作成します。

ResearchKitが引き継ぎ、調査フローを通じて参加者を案内します。

ORKTaskResultが生成され、アプリに返されます。

その後、私たちのアプリはResearchKitの結果をCareKitの結果値に変換し、CareKitのストアで維持します。

新しい結果を保存すると、完了リングがいっぱいになり、タスクカードのUIが更新されます。

では、この2つの方法に取り組みましょう。

Surveys.swiftでそれらを定義します。

以下で使用する識別子をいくつか用意しました。"

ResearchKit調査を作成する方法と、結果をCareKitの結果値に変換する方法が必要です。

参加者が得る睡眠の量と彼らが経験する痛みの量との間に関連性があるかどうかを発見したいので、2つの質問を含むフォームを作成します。

formStepには、一意の識別子、タイトル、およびいくつかのテキストが必要です。

また、フォームをスキップ可能にしたくないので、非オプションとしてマークします。

次に、2つのアイテムを作成しましょう。

最初は痛みについて尋ね、私たちはそれを非オプションの質問にします。

つまり、フォーム自体をスキップすることはできず、この特定の質問に対する回答なしにフォームを提出することもできないということです。

回答形式も提供する必要があることがわかります。

回答形式は、どのような回答を期待し、どのようにユーザーに入力を促すかをResearchKitに伝えます。

彼らは重みを入力していますか、画像を選択していますか、それとも声を録音していますか?

この場合、UISliderを作成するORKScaleAnswerFormatを使用することを選択します。

スライダーは、iOSユーザーにとって使い慣れたインターフェースです。直感的で、紙の調査で円を埋めるよりもはるかに優れた体験を提供します。

最大ペインスコア10、最小値1を指定し、ラウンドナンバーのみが許可されるようにステップサイズを1に設定し、最小値と最大値の説明を提供します。

さて、もう少し下にドロップして、もう1つのアイテムを作成しましょう：sleepItem。

これはpainItemとほぼ同じで、ほぼ同じ回答形式も使用します。

唯一の違いは識別子であり、最低睡眠時間を0時間、最大睡眠時間を12時間に変更したことです。

次に、これら2つのアイテムをフォームアイテムに渡し、単一のフォームステップでORKOrderedTaskを作成するだけです。

2番目の関数は、ResearchKitタスクの結果を取り、持続するCareKit値の配列を作成することになっています。

しかし、このコードを書く前に、ResearchKitのタスク結果の構造を見て、それを解析する方法をよりよく理解しましょう。

ORKTaskResultsはネストされたタイプであることを理解することが重要です。

チェックイン調査のルート結果から始めて、checkin.formまでドリルダウンしたいと思います。

Checkin.formには2人の子供がいて、それぞれを掘り下げる必要があります。

まず、ペインアイテム識別子に与えられた答えを見つけ、次にスリープアイテム識別子の答えを見つけたいです。

私たちはそれらが両方ともスケールの質問の結果であることを知っており、それらからスケールの答えを得ることができます。

この例では、4と11です。

だから、それは視覚的に見えるものであり、これはコードで同じプロセスがどのように見えるかです。

ルート結果から始めて、フォーム識別子でマークされた最初の子を見つけます。

その結果、独自の子を持ち、ORKScaleQuestionResultタイプですべての子を抽出することができ、そのうちの2つがあることがわかっています。

痛みの答えは痛みの識別子でマークされた最初のもので、睡眠の答えは睡眠識別子でマークされた最初のものです。

両方ともscaleAnswerプロパティを持ちます。

答えが手に入ったら、それらをCareKitの結果値に変換する必要があります。1つは睡眠用、もう1つは痛み用です。

ここでの種類のプロパティはオプションです。

設定する必要はありませんが、後で値を調べたい場合に役立ちます。 後で値を調べることができます。

パート3でこれが役に立つ理由がわかります!

最後にすべきことは、この関数から2つの値を返すことです。

そのすべてが整っているので、私たちの毎日のチェックインは行くのに良いはずです!

アプリを実行して、私たちがどのようにやっているか見てみましょう。

パート1ではすでにオンボーディングを完了しているので、同意フローを再度通過する必要はありません。

これは私たちのアプリの真のコンテンツであり、私たちが作成したばかりのCareKitチェックインタスクは、私たちが期待する場所です。

カードをタップすると、ResearchKitの調査に行くことができます。

私たちは先に進んで、ここでいくつかの答えを与えます。

痛みのために4のように、8時間の睡眠で行きましょう。

ケアフィードに戻ると、上部の完了リングがいっぱいになり、ResearchKitからの回答がCareKitに正常に解析されたことがわかります。

これは本当に良さそうです。

そこで、マルチ質問フォームでチェックイン調査を完了し、データが私たちが望むようにCareKitに保持されていることを確認しました。

それは私たちがそこの半分くらいにいることを意味します!

CareKitの高度なスケジュールに移り、後でモーションタスクの範囲に適用します。

チェックインタスクやその前のオンボーディングタスクと同様に、最初のステップはスケジュールを定義することです。

しかし、私たちはこれのためにもう少し関与する何かをするつもりです。

ジェイミーは、時間が経つにつれて参加者に可動域を測定するように依頼する頻度を減らすよう求めました。

具体的には、参加者に最初の週は毎日可動域を測定するように促すスケジュールを設定したいと考えていますが、その後、月末まで週に1回だけ、その後は二度と測定しません。

だから、最初の週は1日1回、残りの月は週に1回。

いくつかの重要な日付を定義することから始めましょう：thisMorning、nextWeek、nextMonth。

さて、CareKitでより微妙なスケジュールを作成したい場合は、OCKScheduleElementが仕事のためのツールです。

スケジュール要素には、開始日、終了日があり、その期間中に一定間隔で繰り返されます。

ここのdailyElementは今朝始まり、来週に終わり、毎日繰り返されます。

2番目の要素はweeklyElementです。

それは来週始まり、来月に終わり、毎週繰り返されます。

2つの要素がわかったので、それらを一緒に構成して複合スケジュールを作成し、そのスケジュールを使用して新しい範囲のモーションタスクを作成できます。

もちろん、私たちの店にも追加する必要があります。 それも必要です。

他のタスクと同様に、次のステップはCareFeedに戻り、CareKitにこのタスクを表示する方法を指定することです。

もう一度、SurveyTaskViewControllerを使用し、回答を抽出するための調査と機能を提供する必要があります。

Surveys.swiftに戻り、始める前に少し構造を提供するためにそれらをスタブしましょう。

さて、モーションタスクの範囲は実際にはかなり簡単です。

実際のところ、それは事前定義されたタスクとしてResearchKitに組み込まれています。

識別子を与えて、どの膝を測定するかを指定するだけです。

現在、事前定義されたタスクには完了ステップが組み込まれており、表示されるメッセージは合理的なデフォルトですが、ユースケースに合わせたカスタムメッセージを表示したいと思います。

そこで、標準の完了ステップを省略するようにResearchKitに伝えます。

次に、私たちは自分自身を定義し、特に理学療法に関連する励ましのメッセージを与えます。

それが最初の機能です。

2つ目は、ResearchKitの結果からCareKitの結果値に変換する場所です。

うまくいけば、これは今身近に感じ始めています。

これを行う方法はたくさんありますが、今日は最初の運動範囲の結果にたどり着くまで掘り下げます。

そして、私たちは1つしかないことを知っています。

運動結果の範囲は、実際には多くの有用な特性を持っていますが、ユースケースに最も興味を持っているのは範囲であり、参加者が膝をどこまで曲げることができたかを測定します。

キーパスと一緒に種類フィールドを使用して、後でこの値を簡単に検索できます。

ところで、それはパート3の予兆です。

さて、それは結果値を抽出するための私たちの機能をまとめます。

いいね！私たちはすべて準備が整っていると思います。

私たちのアプリを実行して、それがどのように機能するかをお見せします。

最初に確認したいのは、私たちのスケジュールが意図した通りに機能していることです。

モーション範囲タスクは、最初の週に毎日表示されるはずです。

8日、9日、10日をページスルーすると、モーションタスクの範囲が毎日表示されます。

しかし、私が来週に出るとき、それはここで月曜日を除いて表示されなくなります。これは、私たちがまだ表示したい週の1日です。

ここでは、まだ週に1回しか表示されません。

しかし、私たちがさらに未来に出て行くと、来月までずっと、それはもうまったく現れません。

CareKitのスケジュールは、このようなレジメンを事前にプログラムするのに最適な方法です。

今日に戻って、これを試してみましょう。

開始をタップすると、指示のステップは何をすべきかを理解するのに役立ちます。

私が始めると、Siriは私に音声ガイダンスをくれるので、私は彼女の指示に従うつもりです。

Siri: デバイスを左膝の上に置きます。

画面をタップして、左膝をできるだけ伸ばします。

続けるにはどこでもタッチしてください。

終わったら、左膝をスタート位置に戻し、どこでもタップします。

エリック：いいね。

それはかなりきちんとしていますよね?

通常、あなたは医者のオフィスを訪問する必要がありますし、セラピストはあなたがこのような測定を行うのを手伝いますが、ResearchKitは参加者が自分の家で測定を行うのを助けることができます。

ジェイミーは私たちの進歩に本当に感銘を受けると思います。

この直後に彼にFaceTimeして、TestFlightで私たちのアプリの最新バージョンを彼に送ります。

ジェイミーに進捗状況をスピードアップさせていますが、researchandcare.orgでフレームワークに関する詳細情報を見つけるか、GitHubのソースコードを読むことができます。

セッション1では、オンボーディングを設定しました。

このセッションでは、2つのタスクをスケジュールしました。

3回目と最後のセッションに再び参加して、ResearchKitとCareKitがアプリを完成させるのにどのように役立つかを確認してください。

また近いうちに会いましょう!

♪