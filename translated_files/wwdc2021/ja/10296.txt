10296

こんにちは、WWDC 2021へようこそ。

私はスージーで、XcodeでXCTestに取り組んでいます。

このセッションでは、テストを繰り返すツールであるテストの繰り返しで信頼性の低いコードを診断する方法について学びます。

アプリを行使するテストを実行する過程で、信頼性の低いコードを実行すると、テストが失敗することがあります。

競争条件、環境の仮定、グローバル状態、または外部サービスとの通信に対処する際に、この種の矛盾に遭遇する可能性があります。

これらは再現が難しいため、追跡するのが難しいバグです。

これらのタイプの障害を診断する1つの方法は、テストを繰り返し実行することです。

Xcode 13で追加されたテストの繰り返しでは、停止条件で指定された数の反復までテストを繰り返すことができます。

Xcodeは3つのテスト繰り返しモードをサポートしています。

最初のモードは固定反復です。

固定反復は、ステータスに関係なく、テストを一定回数繰り返します。

固定反復は、テストスイートの信頼性を理解し、新しいテストが時間の経過とともに導入されるにつれて信頼性を維持するのに役立ちます。

2つ目は失敗までです。

失敗するまで、失敗するまでテストを繰り返し続けます。

私はこのツールを使用して、デバッガでそれをキャッチするために非決定的なテストの失敗を再現するのが大好きです。

最後に、失敗時に再試行します。

失敗時に再試行すると、指定された最大値まで成功するまでテストが再試行されます。

これは、最初は失敗するが、最終的には再試行で成功する信頼性の低いテストを特定するのに役立ちます。

CIのテストでこの動作を示している場合は、テストプランで失敗時に再試行を一時的に有効にし、問題を解決するために追加のデータを収集することができます。

再試行の失敗は、実際の製品の問題を隠すことができることを覚えておくことが重要です。

一部の機能は、最終的に成功する前に最初に失敗するので、障害を診断するために一時的にこのモードを使用するのが最善です。

これが実際にどのように機能するかをよりよく理解しましょう。

アイスクリームトラックが私の家のそばを運転するまでの時間を教えてくれるIceCreamTruckCountdownというアプリを作成しました。

私はトラックにクッキーとクリームがあるのが大好きなので、トラックにすべての味があることを確認するためにtestFlavorsというテストを書きました。

testFlavorsは、私がトラックデポから得るトラックを持っています。

私はprepareFlavorsと呼び、最後に、トラックには33種類のフレーバーがすべて揃っていると主張します。

最近、testFlavorsがXcode Cloudのメインブランチで失敗することがあることに気づきました。

より多くの情報を収集するために、テスト計画を一時的に設定し、テスト繰り返しモードを有効にして失敗時に再試行しました。

レポートナビゲーターを見て、クラウドレポートを確認しましょう。

私のテストは一貫して失敗していないので、この最後のテストで詳細を確認しましょう。

最初のデバイスを開くと、ここに反復ラベルがあり、このテストの最初の反復であることを知らせます。

はぁ。そして、他のすべての行を展開すると、アサーションの失敗はすべて同じで、この最後のテストに合格しました。

1つのデバイスだけでなく、すべてのテストが一貫して合格することを期待していました。

この失敗をローカルで再現してみます。

testFlavorsがあるファイルに行きましょう。

テスト用のテストダイヤモンドをControlキーを押しながらクリックします。

メニューで、「testFlavors（）」を繰り返し実行」を選択して、テストの繰り返しダイアログを表示します。

ここでは、繰り返しの停止条件、最大繰り返しの設定、および失敗の一時停止などの他のオプションを選択できます。

クラウドレポートで発生した問題を再現したいので、停止条件を設定して、最大繰り返しを100に保つようにしています。

今からテストを実行します。

ああ、イェーイ！テストはローカルで失敗しました。

失敗注釈をクリックすると、Xcode Cloudで発生したのと同じエラーが表示され、100回中4回失敗しました。

すごい！これでこの問題をデバッグできます。

testFlavorsのテストダイヤモンドをControlキーを押しながらもう一度クリックし、「testFlavors（）」を繰り返し実行を選択します...しかし、今回は、問題が発生したときにデバッグできるように、失敗時に停止を使用します。

ありがたいことに、Xcodeは自動的に失敗の一時停止を選択するので、デバッガでエラーをキャッチできます。

さて、私たちはその問題を捕まえました。

そして、私たちはトラックの味との矛盾を見ていることを知っているので、デバッガで私たちのトラックオブジェクトを見てみます。

私たちはすでにprepareFlavorsと呼んだので、33であるべきときにフレーバーが0であることは奇妙に思えます。

この完成ハンドラーの中にたどり着いたのだろうか。

ブレークポイントを追加して[続行]をクリックします。

うーん、それは間違っているようです。

ああ、フルフィルメントは、内側の準備フレーバー完了ハンドラーではなく、外側の完了ハンドラーで呼ばれます。

これは、複数の完了ハンドラーを持つ非同期イベントと、正しい場所で期待が満たされていないことによって引き起こされるかなり単純なバグです。

Swift 5.5のasync/awaitに対するXCTestのサポートにより、このテストを簡素化して、二度と起こらないようにします。

このテストをasync/awaitを使用するように変換するには、メソッドヘッダーに「async throws」を追加します。

truckDepotからiceCreamTruckを入手する「await」バージョンを使用します。

prepareFlavorsの「await」バージョンを使用します。

私は同じ主張を維持しますが、トラックはもはやオプションではありません。

このテストをもう一度実行して、修正されていることを確認しましょう。

Controlキーを押しながらクリックして「testFlavors（）」を繰り返し実行し、もう一度停止条件として最大繰り返しを選択します。

イェーイ！テストは100回合格した。

私は今、これが修正されたと確信しており、テスト計画から失敗した再試行を削除し、変更をコミットする準備ができています。

そのため、デスクでこれを使用する方法と、テスト計画で設定することで、CIでテストを繰り返し実行する方法をよりよく理解しました。

CLIを使用して、デモのように繰り返しテストを実行する別の方法について話しましょう。

Xcodebuildを直接実行する場合、テストプランの設定を上書きするxcodebuildフラグを追加できます。

番号で-test-iterationsに合格して、テストを一定回数実行するか、-retry-tests-on-failureまたは-run-tests-until-failureと組み合わせて、他の停止条件の1つで使用します。

Xcodebuildでデモと同じようにテストを実行するには、テストを実行するために使用されるbase xcodebuildコマンドから始めて、フラグ-test-iterationsを100に設定し、-run-tests-until-failureを追加します。

要約すると、信頼性の低いコードを診断するのに役立つツールとしてテストの繰り返しを使用してください。

一貫性のないテストの処理の詳細については、「XCTestで予想される障害を受け入れる」をご覧ください。

Swift asyncの詳細については、「Meet async/await in Swift」をチェックしてください。

見てくれてありがとう。

[パーカッシブミュージック]。