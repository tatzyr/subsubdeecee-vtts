10247

♪ ♪

Xin chào, tên tôi là Roy.

Tôi là một kỹ sư trong nhóm Phần mềm Máy ảnh.

Hôm nay tôi sẽ hướng dẫn bạn một số cải tiến chất lượng ảnh thú vị mà chúng tôi đã thực hiện với các định dạng video phổ biến nhất của mình và cách các ứng dụng của bạn có thể sử dụng chúng để mang lại trải nghiệm tốt hơn nữa.

iPhone là máy ảnh phổ biến nhất trên thế giới và trong nhiều năm, các nhà phát triển đã tận dụng các hệ thống máy ảnh mạnh mẽ của mình để cung cấp một loạt các trải nghiệm đẳng cấp thế giới, từ các ứng dụng chụp ảnh chuyên nghiệp đến các công cụ phát trực tuyến video.

Các kịch bản khác nhau yêu cầu các mức chất lượng ảnh khác nhau.

Ví dụ, các ứng dụng dành riêng cho việc chụp ảnh tĩnh sẽ yêu cầu chất lượng tuyệt đối tốt nhất mà máy ảnh có thể cung cấp.

Mặt khác, một ứng dụng xã hội có thể cần áp dụng lớp phủ hiệu ứng khuôn mặt lên trên các khung hình video đang được phát trực tuyến.

Và kết xuất tùy chỉnh này có thể tốn kém về mặt tính toán.

Để tránh giảm khung hình, nhà phát triển có thể thích các khung hình có độ phân giải thấp hơn để có ít điểm ảnh hơn để xử lý trên mỗi khung hình.

Sự đa dạng trong các trường hợp sử dụng này đòi hỏi một cách dễ dàng để xác định nơi bạn muốn đạt được quy mô chất lượng so với hiệu suất.

Tuy nhiên, trước khi chúng ta đi sâu vào chất lượng ảnh, chúng ta hãy làm mới ngắn gọn về cách chụp ảnh trên iOS nói chung.

Chúng ta sẽ bắt đầu với một đối tượng AVCaptureSession, xung quanh đó chúng ta có thể xây dựng biểu đồ đối tượng của mình.

Vì chúng tôi đang chụp ảnh, chúng tôi sẽ sử dụng máy ảnh làm thiết bị AVCapture của mình.

Sau đó, một AVCaptureDeviceInput được khởi tạo dựa trên thiết bị đó và nó sẽ cung cấp dữ liệu đầu vào cho phiên.

Một AVCapturePhotoOutput sau đó sẽ được thêm vào biểu đồ với tư cách là người nhận ảnh.

Và tất cả các yếu tố này sau đó được kết nối với nhau bằng cách sử dụng AVCaptureConnection.

Sau khi phiên bắt đầu chạy, chúng ta có thể chụp ảnh bằng cách gọi phương thức capturePhoto trên phiên bản AVCapturePhotoOutput.

Tùy chỉnh thêm có thể được thực hiện bằng cách sử dụng đối tượng AVCapturePhotoSettings được chuyển đến phương thức capturePhoto.

Ảnh được chụp sẽ được thể hiện dưới dạng đối tượng AVCapturePhoto mà bạn sẽ nhận được trong phương thức đại diện của mình.

Chúng tôi đã có một cuộc thảo luận rất chi tiết về các API này trong phiên 2016, Những tiến bộ trong Nhiếp ảnh iOS.

Vui lòng kiểm tra nó nếu bạn chưa có.

Bây giờ chúng ta đã biết cách chụp ảnh trên iOS nói chung, hãy xem những bức ảnh chất lượng cao có thể được chụp như thế nào.

Trong lịch sử, nếu bạn muốn chụp ảnh với chất lượng tốt nhất có thể, bạn sẽ đặt thuộc tính isAutoStillImageStabilization Enabled trên AVCapturePhotoSettings của bạn thành true, và đó là vì ổn định hình ảnh tĩnh là phương pháp chính để có được những bức ảnh chất lượng cao hơn.

Nhưng trong những năm qua, chúng tôi đã liên tục phát triển các thuật toán nâng cao chất lượng ảnh của mình.

Ngoài tính năng ổn định hình ảnh tĩnh, giờ đây chúng tôi có một bộ kỹ thuật phong phú hơn nhiều để rút ra, chẳng hạn như nhiều công nghệ hợp nhất đa hình ảnh, bao gồm HDR thông minh và Deep Fusion.

Do đó, cái tên làAutoStillImageStabilization Enabled đã trở nên khá lỗi thời như một đại diện cho chất lượng ảnh cao.

Để giải quyết vấn đề này, trong iOS 13, chúng tôi đã giới thiệu AVCapturePhotoOutput.QualityPrio ritization.

Đó là một cách rất dễ dàng để nói với AVCapturePhotoOutput cách ưu tiên chất lượng trong việc chụp ảnh của bạn.

Chúng tôi chưa có cơ hội nói về API quan trọng này tại các WWDC trước đây, vì vậy bây giờ chúng ta hãy dành một chút thời gian để xem nó hoạt động như thế nào.

Có ba cấp độ ưu tiên chất lượng để lựa chọn: tốc độ, cân bằng và chất lượng.

Với tốc độ, bạn đang nói với khuôn khổ rằng tốc độ chụp là điều bạn quan tâm nhất, ngay cả khi phải trả giá bằng chất lượng ảnh.

Nếu cần cân bằng giữa chất lượng ảnh và tốc độ giao hàng, nên sử dụng cân bằng.

Chất lượng trái ngược với tốc độ.

Nó nói rằng chất lượng hình ảnh nên được ưu tiên đầu tiên và quan trọng nhất, trong khi khả năng chậm chạp của quá trình chụp có thể được dung thứ.

Xin lưu ý rằng ưu tiên chất lượng được chỉ định chỉ đóng vai trò là gợi ý cho AVCapturePhotoOutput và nó không ra lệnh sử dụng thuật toán nào.

Cuối cùng, AVCapturePhotoOutput sẽ xem xét nhiều ràng buộc khác nhau và chọn thuật toán phù hợp nhất cho cảnh hiện tại.

Ví dụ, nó có thể chọn một phương pháp khác cho tình huống ánh sáng yếu so với trong không gian đủ ánh sáng.

Điều đó đang được nói, chúng tôi hiểu rằng dựa trên các khoảng thời gian chụp khác nhau, bạn có thể muốn lập kế hoạch trải nghiệm người dùng của mình theo cách khác.

Vì vậy, trên đối tượng AVCaptureResolvedPhotoSettings được chuyển đến một số phương thức AVCapturePhotoOutputDelegate, chúng tôi cung cấp cho bạn một thuộc tính được gọi là photoProcessingTimeRange cho biết sẽ mất bao lâu để gửi ảnh cho đại diện của bạn.

Ví dụ, điều này có thể giúp bạn quyết định xem bạn có muốn đưa ra một con quay hay không nếu việc chụp sẽ mất một lúc.

Hãy xem nó hoạt động như thế nào trong mã.

Khi bạn đang thiết lập AVCapturePhotoOutput của mình, bạn có thể chỉ định mức độ ưu tiên chất lượng tối đa mà phiên chụp cụ thể sẽ yêu cầu.

Nếu bạn chọn không làm như vậy, giá trị mặc định sẽ được cân bằng.

Điều này chỉ phải được thiết lập một lần.

Tầm quan trọng của việc làm như vậy là tùy thuộc vào các cài đặt khác nhau, chúng tôi sẽ định cấu hình các đường ống chụp của mình theo cách khác nhau.

Ví dụ, nếu chúng tôi biết bạn sẽ không vượt quá mức ưu tiên tốc độ, chúng tôi có thể xây dựng một đường ống chụp tiêu thụ ít bộ nhớ và năng lượng hơn nhiều so với quy trình ưu tiên cân bằng.

Vì vậy, chúng tôi khuyến khích bạn lựa chọn có trách nhiệm và chỉ lấy những gì bạn cần.

Trước khi bạn gọi phương thức capturePhoto, bạn có thể tùy chỉnh ưu tiên chất lượng cho ảnh chụp cụ thể này bằng cách đặt thuộc tính photoQualityPrioritization trên đối tượng AVCapturePhotoSettings của bạn.

Giá trị mặc định được cân bằng.

Như đã được chứng minh ở đây, chúng tôi đang sử dụng hai cấp độ khác nhau trong hai tình huống khác nhau.

Xin lưu ý rằng việc ưu tiên chất lượng cho mỗi lần chụp không thể vượt quá mức ưu tiên chất lượng tối đa của AVCapturePhotoOutput, nếu không bạn sẽ nhận được một ngoại lệ.

Các đặc điểm hiệu suất của ba cấp độ được xác định bởi các thuật toán cơ bản mà chúng tôi sử dụng.

Các ánh xạ khác nhau dựa trên các loại định dạng bạn sử dụng và chúng ta sẽ nói thêm về sự khác biệt giữa định dạng ảnh và video trong giây lát.

Với các định dạng ảnh, Speed sẽ giúp bạn có được những bức ảnh WYSIWYG - đó là những gì bạn thấy là những gì bạn nhận được - chỉ được xử lý nhẹ với một số áp dụng giảm nhiễu.

Nếu Balanced được chỉ định, chúng tôi sẽ chọn từ một bộ sưu tập các thuật toán nhiệt hạch nhanh tạo ra chất lượng ảnh tốt hơn nhiều so với ảnh WYSIWYG với tốc độ chụp chậm hơn một chút.

Đối với Chất lượng, tùy thuộc vào thiết bị hiện tại và mức độ lux, khung sẽ sử dụng một số máy móc hạng nặng như Deep Fusion để cung cấp chất lượng ảnh tốt nhất có thể.

Những bức ảnh sẽ trông rất tuyệt, nhưng không có bữa trưa miễn phí.

Bạn trả tiền cho nó bằng cách sử dụng nhiều thời gian hơn.

Mặt khác, đối với các định dạng video, tất cả các cấp độ sẽ sử dụng xử lý nhẹ nhất để gửi ảnh nhanh nhất có thể.

Chúng tôi đã nói về các định dạng ảnh và video trong một thời gian.

Chúng ta hãy xem xét kỹ hơn sự khác biệt giữa chúng.

Bằng cách sử dụng các định dạng ảnh, bạn đang báo hiệu cho khuôn khổ rằng chụp ảnh tĩnh là điều bạn quan tâm nhất.

Ví dụ: nếu bạn đang sử dụng AVCaptureVideoDataOutput với định dạng ảnh, bộ đệm mẫu bạn nhận được theo mặc định sẽ chỉ có độ phân giải xem trước và đó là bởi vì biết rằng chụp ảnh là ưu tiên hàng đầu của bạn, chúng tôi có thể giả định rằng các khung hình này sẽ được sử dụng để xem trước thay vì quay video.

Một lý do chính đáng để chọn định dạng ảnh là một số tính năng lấy ảnh làm trung tâm chỉ dành riêng cho các định dạng ảnh, chẳng hạn như Live Photo và ProRAW, v.v.

Nếu đó là điều bạn muốn làm, thì định dạng ảnh là con đường để đi.

Các định dạng ảnh đi kèm với độ phân giải cao nhất hiện có, nhưng tốc độ khung hình được giới hạn ở 30 khung hình mỗi giây.

Để chọn định dạng ảnh, bạn có thể đặt cài đặt trước phiên của mình thành ảnh.

Hoặc bạn có thể chọn một định dạng trong đó HighestPhotoQualitySupported là đúng.

Mặt khác, việc sử dụng các định dạng video chỉ ra rằng những trải nghiệm bây giờ sẽ xoay quanh các video.

Bạn sẽ nhận được độ phân giải phù hợp hơn để ghi và phát trực tuyến, và bạn sẽ có thể sử dụng tốc độ khung hình cao như 60 khung hình / giây.

Nếu một định dạng không phải là định dạng ảnh, thì nó được coi là định dạng video.

Vì vậy, bạn có thể chọn một cái bằng cách sử dụng cài đặt trước phiên không có ảnh hoặc chọn định dạng trong đó HighestPhotoQualitySupported là sai.

Bạn có thể tự hỏi tại sao chúng tôi không áp dụng một số thuật toán mạnh mẽ cho các định dạng video.

Không phải vì chúng ta lười biếng.

Chúng tôi có những lý do chính đáng cho điều đó.

Nhiều ứng dụng chọn sử dụng các định dạng video vì chúng cần xử lý tùy chỉnh nhiều và các định dạng video rất phù hợp cho mục đích này vì chi phí thấp.

Nếu chúng tôi tận dụng một số kỹ thuật nâng cao ảnh nói trên, chúng tôi có thể giới thiệu sự xuống cấp trong trải nghiệm của các ứng dụng này.

Ví dụ, một ứng dụng AR có thể cho phép người dùng chụp ảnh cảnh 3D mà họ đang tương tác.

Chạy các thuật toán hợp nhất hiện có tại thời điểm này có khả năng tạo ra sự sụt giảm khung hình trong nguồn cấp dữ liệu máy ảnh của ứng dụng, làm gián đoạn tính năng cốt lõi của nó.

Vì vậy, chúng tôi đã rất ý thức về sự cân bằng tinh tế này giữa chất lượng và tốc độ, và chúng tôi đã thiết kế các định dạng video của mình để hoạt động đáp ứng ngay cả trong những điều kiện khắt khe nhất.

Nhưng những thỏa hiệp đó dừng lại hôm nay với iOS 15.

Chúng tôi đang có một bước nhảy vọt lớn về chất lượng ảnh với các định dạng video phổ biến nhất của chúng tôi.

Với một số thuật toán được cải tiến, giờ đây chúng tôi có thể cải thiện triệt để chất lượng ảnh mà không ảnh hưởng đến các khía cạnh khác trong trải nghiệm ứng dụng của bạn.

Với tính năng mới này, các ứng dụng của bạn giờ đây có thể chụp những bức ảnh tuyệt vời, trong khi vẫn giữ được sự linh hoạt tương tự để thực hiện tính toán tùy chỉnh tinh vi.

Vậy chúng ta đang nói về một bước nhảy vọt về chất lượng lớn như thế nào ở đây?

Chúng ta hãy xem xét một số so sánh trước và sau.

Sự cải thiện là khá đáng kể.

Khuôn mặt của cậu bé bên phải có ít tiếng ồn hơn, và do đó trông tự nhiên hơn nhiều.

Và chúng ta có thể cảm nhận rõ hơn ánh sáng phát ra từ tóc anh ấy.

Ánh sáng bắt mắt đối tượng của bạn chỉ đơn giản là sống động và sống động hơn.

Trong tình huống thiếu ánh sáng ngoài trời này, có tiếng ồn vượt trội trên khuôn mặt và quần áo của cô ấy.

Cuối cùng, môi trường cũng trông đẹp hơn.

Kết cấu da trên ghế được bảo quản tốt hơn nhiều.

Bây giờ bạn đã bị lôi cuốn, chúng ta hãy xem ánh xạ thuật toán cho các định dạng video được hỗ trợ.

Tốc độ vẫn sẽ giúp bạn có được những bức ảnh WYSIWYG được xử lý nhẹ.

Chúng vẫn là cách nhanh nhất để chụp ảnh và vì tốc độ hiện là ưu tiên hàng đầu của bạn, điều này hoàn toàn phù hợp với hóa đơn, vì vậy chúng tôi đã không thay đổi nó.

Bạn sẽ không nhận được bất kỳ sự sụt giảm khung hình nào trong các bản ghi video của mình hoặc bất kỳ sự gián đoạn nào trong nguồn cấp dữ liệu xem trước của bạn.

Tuy nhiên, với Balanced, giờ đây bạn đang nhận được sự gia tăng đáng kể về chất lượng, trong khi chỉ nhận được sự gia tăng rất nhẹ trong thời gian xử lý ảnh.

Và cũng giống như trong Speed, việc quay video của bạn sẽ không có bất kỳ sự sụt giảm khung hình nào.

Nguồn cấp dữ liệu xem trước của bạn sẽ không bị gián đoạn, ngay cả khi những bức ảnh đẹp đó được chụp và xử lý.

Cuối cùng, đối với Chất lượng, chúng tôi đang chạy các thuật toán đắt tiền hơn để có được những phẩm chất tốt hơn nữa.

Điều này có thể làm giảm khung hình hoặc gây gián đoạn nguồn cấp dữ liệu xem trước, tùy thuộc vào mức độ gần đây của thiết bị của bạn.

Tính năng này sẽ có sẵn trên tất cả iPhone với sự hỗ trợ từ iPhone XS.

Các định dạng video đang được nâng cấp này là những định dạng phổ biến nhất: 1280x720 với sự hỗ trợ cho cả 30 và 60 khung hình mỗi giây.

1920x1080, cũng cho cả 30 và 60 khung hình / giây.

1920x1440, cho 30 khung hình / giây.

Và chúng tôi thậm chí còn thêm hỗ trợ cho 4K, với 30 khung hình / giây.

Vậy làm thế nào bạn có thể chắc chắn rằng bạn đang sử dụng đúng định dạng trong mã của mình?

Nó rất đơn giản.

Trong iOS 15, chúng tôi đang giới thiệu một thuộc tính mới được gọi là isHighPhotoQualitySupported trên loại AVCaptureDevice.Format.

Đối với các định dạng hỗ trợ tính năng này, thuộc tính này sẽ đúng.

Bất kỳ định dạng nào có thuộc tính này là đúng đều được đảm bảo là định dạng video, vì vậy bạn không phải lo lắng về việc vô tình chọn định dạng ảnh.

Giả sử bạn muốn có bất kỳ định dạng nào như vậy.

Bạn chỉ cần lấy các định dạng có sẵn trên phiên bản AVCaptureDevice của mình.

Sau đó, chỉ cần chọn cái có isHighPhotoQualitySupported là đúng.

Chúng tôi đã cập nhật mã mẫu AVCam của mình để sử dụng tính năng này.

Vui lòng kiểm tra nó nếu bạn muốn xem một ví dụ hoạt động.

Có thể nhầm lẫn thuộc tính mới làHighPhotoQualitySupported với thuộc tính hiện tại làHighestPhotoQualitySupported.

Như chúng tôi đã đề cập trước đó, định dạng sau cho bạn biết liệu định dạng có phải là định dạng ảnh hay không và nó không cho bạn biết liệu định dạng video có hỗ trợ chất lượng ảnh cao hay không.

Bây giờ, bạn có cần phải làm bất kỳ công việc nào để có được tính năng mới này không?

Câu trả lời là có thể.

Nếu bạn đã sử dụng AVCapturePhotoOutput và ưu tiên .balanced, thì xin chúc mừng, bạn sẽ tự động có được những bức ảnh đẹp hơn trên iOS 15.

Nếu ứng dụng của bạn đang sử dụng ưu tiên tốc độ, chỉ cần cập nhật nó thành cân bằng, bạn sẽ nhận được những bức ảnh đẹp hơn mà không phải lo lắng về bất kỳ sự sụt giảm khung hình nào.

Nếu bạn vẫn đang sử dụng AVCaptureStillImageOutput bị phản đối, thì hy vọng điều này sẽ cho bạn một động lực lớn để chuyển đổi.

Vì bây giờ việc sử dụng ưu tiên chất lượng có thể giới thiệu giảm khung hình trong video của bạn, chúng tôi không muốn áp đặt hành vi mới đó lên ứng dụng của bạn mà bạn không chọn tham gia.

Vì vậy, chúng tôi đã kiểm tra thời gian liên kết để đảm bảo rằng nếu ứng dụng của bạn đang sử dụng ưu tiên chất lượng với định dạng video và được biên dịch trước iOS 15, thì chúng tôi sẽ tự động thay đổi nó thành cân bằng.

Nếu bạn thực sự muốn có được chất lượng tốt nhất, tất cả những gì bạn cần làm là biên dịch lại ứng dụng của mình với iOS 15 SDK.

Có một vài lưu ý cần lưu ý.

Tính năng này hiện chỉ hoạt động với AVCaptureSession, chứ không phải với AVCaptureMultiCamSession.

AVCaptureStillImageOutput bị phản đối sẽ không hỗ trợ tính năng này.

Nếu bạn đang sử dụng ưu tiên .balanced hoặc .quality, một số thuật toán chúng tôi sử dụng có thể kết hợp một số hình ảnh được phơi sáng khác nhau để cải thiện dải động.

Ảnh sẽ có chất lượng tuyệt vời, nhưng chúng có thể trông khác với video được quay cùng một lúc.

Nếu bạn cần video và ảnh của mình trông giống hệt nhau, vui lòng sử dụng .speed để thay thế.

Cuối cùng, hãy tóm tắt những gì chúng ta vừa đề cập.

Khi thiết kế trải nghiệm ứng dụng của bạn, hãy lưu ý đến quyết định lựa chọn giữa chất lượng và tốc độ.

Khi bạn đã tìm ra vai trò của chất lượng ảnh trong các trường hợp sử dụng của mình, hãy sử dụng các mức độ ưu tiên thích hợp để thực hiện điều đó.

Và với số lượng công việc tối thiểu và đôi khi không có tác dụng nào cả, giờ đây bạn sẽ có được những bức ảnh tuyệt vời với định dạng video.

Cảm ơn bạn rất nhiều.

[Nhạc gõ].