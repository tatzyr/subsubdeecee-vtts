10005

Xin chào.

Tên tôi là Yann, và tôi muốn nói với bạn về một cách mới để kết nối các thiết bị Bluetooth của bạn với Apple Watch.

Đầu tiên, tôi sẽ xem xét cách hoạt động của Core Bluetooth trên watchOS 7.

Sau đó tôi sẽ nói về một tính năng mới thú vị trong watchOS 8.

Và tôi sẽ thảo luận về những cách tốt nhất để thiết kế phụ kiện và ứng dụng của bạn để hoạt động với Apple Watch.

Hãy bắt đầu với cách Core Bluetooth hoạt động ngay hôm nay.

Bạn chỉ có thể kết nối với các thiết bị Bluetooth trong khi ứng dụng của bạn ở phía trước hoặc trong phiên nền.

Điều này thật tuyệt vời khi một người muốn tập trung vào ứng dụng của bạn để lấy thông tin từ phụ kiện của họ.

Nhưng nếu bạn muốn có một sự phức tạp với thông tin từ phụ kiện của mình thì sao?

Hiện tại, sự phức tạp không thể được cập nhật trừ khi một người mở ứng dụng của bạn.

Bây giờ trong watchOS 8, bạn có thể kết nối phụ kiện Bluetooth của mình trong khi Làm mới ứng dụng nền.

Điều này cho phép bạn cập nhật các biến chứng của mình với thông tin từ phụ kiện của bạn hoặc gửi thông báo cục bộ nếu pin sắp hết.

Với cảm biến nhiệt độ ví dụ của tôi, bây giờ tôi có thể cập nhật nhiệt độ trong một biến chứng, vì vậy tôi có thể nhìn thấy nó bất cứ khi nào tôi liếc nhìn đồng hồ của mình.

Chúng tôi đang sử dụng cảm biến nhiệt độ trong ví dụ của mình, nhưng nó có thể là bất kỳ phụ kiện nào mà ai đó muốn xem nhanh thông tin.

Để bắt đầu sử dụng Bluetooth trong quá trình Làm mới ứng dụng nền, chỉ cần thêm bluetooth-central vào UIBackgroundModes trong Info.plist của bạn.

Điều này cũng có thể xuất hiện dưới dạng "Chế độ nền bắt buộc" và "Ứng dụng giao tiếp bằng CoreBluetooth."

Đây là bảng hiển thị sự khác biệt giữa các nền tảng.

Đây là những cấu hình được hỗ trợ hiện tại cho Bluetooth Low Energy.

Hãy đi sâu vào cách phụ kiện của bạn giao tiếp với Apple Watch.

Giả sử người dùng đã ghép nối với phụ kiện của bạn và họ mở ứng dụng Đồng hồ của bạn.

Ứng dụng của bạn cố gắng kết nối với phụ kiện của bạn và ngay khi thấy quảng cáo, kết nối Bluetooth LE sẽ được thiết lập.

Khi người dùng thoát khỏi ứng dụng watchOS của bạn, kết nối Bluetooth sẽ kết thúc.

Kết nối Bluetooth sẽ không khả dụng cho đến lần tiếp theo ứng dụng watchOS của bạn có sẵn thời gian chạy.

Hãy phân tích những gì xảy ra trong quá trình làm mới ứng dụng nền tiếp theo của bạn trên watchOS 8.

Ứng dụng của bạn bắt đầu kết nối với một thiết bị ngoại vi đã biết và lần sau khi nhận được quảng cáo, Apple Watch sẽ kết nối với phụ kiện của bạn.

Ngay sau khi bạn truy xuất xong dữ liệu, bạn có thể chấm dứt kết nối Bluetooth và xử lý dữ liệu.

Làm mới ứng dụng nền có thể xảy ra bất cứ lúc nào, vì vậy phụ kiện của bạn nên quảng cáo thường xuyên nhất có thể khi nó có bản cập nhật quan trọng để hiển thị trên Apple Watch.

Bây giờ, giả sử phụ kiện của bạn quảng cáo rất hiếm khi để tiết kiệm năng lượng.

Có thể sẽ không nhận được quảng cáo nào trong quá trình Làm mới ứng dụng nền và sẽ không có kết nối nào xảy ra.

Làm mới ứng dụng nền không được đảm bảo xảy ra vào một thời điểm cụ thể, vì vậy phụ kiện của bạn phải quảng cáo thường xuyên bất cứ khi nào nó có các bản cập nhật quan trọng.

Một chiến lược khả thi là đệm dữ liệu cảm biến trên phụ kiện của bạn.

Khi nó gần đến giới hạn bộ đệm, hãy tăng tỷ lệ quảng cáo của nó để tăng cơ hội kết nối lại với Apple Watch.

Như một hướng dẫn, bạn nên quảng cáo ít nhất hai giây một lần trong điều kiện RF lý tưởng.

Nếu bạn mong đợi thiết bị của mình hoạt động trong điều kiện RF khó khăn hơn, phụ kiện của bạn nên quảng cáo thường xuyên hơn để tăng cơ hội kết nối lại.

Hãy xem ứng dụng của bạn sẽ tương tác với Core Bluetooth như thế nào và watchOS sẽ tương tác với phụ kiện Bluetooth của bạn như thế nào.

Đây là một dòng chảy biểu đồ thời gian.

Thời gian trôi qua từ trên xuống dưới.

Hãy bắt đầu với những gì xảy ra khi ứng dụng của bạn ở phía trước.

Phụ kiện của bạn là quảng cáo.

Bạn có thể quét một thiết bị mới để phát hiện phụ kiện Bluetooth của mình.

Khi thiết bị của bạn đã được phát hiện, bạn có thể bắt đầu kết nối với nó.

Ngay khi Apple Watch nhận được quảng cáo, nó sẽ kết nối.

Khi bạn đã hoàn tất kết nối Bluetooth, bạn có thể gọi cancelPeripheralConnection, điều này sẽ ngắt kết nối thiết bị Bluetooth của bạn.

Sau đó, tại một thời điểm sau đó, khi màn hình Apple Watch tắt, ứng dụng watchOS của bạn sẽ bị tạm ngưng.

Bây giờ, chúng ta hãy xem điều gì sẽ xảy ra trong lần Làm mới ứng dụng nền tiếp theo.

Lưu ý rằng thời gian trôi qua không phải để mở rộng quy mô.

Nếu ứng dụng của bạn cần kết nối lại với phụ kiện Bluetooth, nó có thể bắt đầu kết nối.

Ở đây kết nối được thiết lập.

Như đã đề cập trước đây, chúng tôi thực sự khuyên bạn chỉ nên kết nối với phụ kiện của mình trong khoảng thời gian bạn cần.

Bạn nên truy xuất dữ liệu bạn cần và sau đó yêu cầu ngắt kết nối trong quá trình Làm mới ứng dụng nền.

Trong trường hợp này, việc truyền dữ liệu hoàn tất và ứng dụng hủy kết nối ngoại vi.

Hãy xem xét một luồng người dùng tiềm năng khác.

Trong cái này, Phụ kiện Bluetooth không ở gần Apple Watch hoặc không quảng cáo trong quá trình Làm mới ứng dụng nền.

Đây là cách bạn nên quản lý điều này trong giai đoạn Làm mới ứng dụng nền.

Đầu tiên, bạn sẽ kết nối với một thiết bị ngoại vi, nhưng không có quảng cáo.

Khi trình xử lý hết hạn được gọi, bạn nên yêu cầu hủy kết nối.

Bằng cách này, bạn sẽ có một bảng xếp hạng sạch sẽ và có thể yêu cầu kết nối lại khi bắt đầu Làm mới ứng dụng nền tiếp theo.

Bạn cũng nên hủy kết nối trước khi trình xử lý hết hạn được gọi để tiết kiệm pin.

Nếu bạn cần kết nối lại ở lần Làm mới ứng dụng nền tiếp theo, bạn có thể phát hành lại connectPeripheral.

Ngay khi Apple Watch nhìn thấy quảng cáo, nó sẽ kết nối với phụ kiện của bạn.

Tại thời điểm này, bạn có thể tìm nạp và tải xuống tất cả dữ liệu bạn cần.

Sau đó, bạn có thể ngắt kết nối ngay khi kết nối xong.

Hãy xem xét quy trình cuối cùng, nơi chúng tôi thấy điều gì sẽ xảy ra nếu bạn không ngắt kết nối trong quá trình Làm mới ứng dụng nền.

Bắt đầu một kết nối.

Ngay khi Apple Watch nhìn thấy quảng cáo, nó sẽ thiết lập kết nối.

Ở đây, giả sử ứng dụng của bạn không có thời gian để truy xuất tất cả dữ liệu trước khi Làm mới ứng dụng nền hết hạn.

Trong trường hợp này, Core Bluetooth sẽ tự động chấm dứt kết nối vào cuối lần Làm mới ứng dụng nền tiếp theo.

Tại lần Làm mới ứng dụng nền tiếp theo, ứng dụng của bạn sẽ nhận được sự kiện didDisconnectPeripheral.

Tại thời điểm này, nếu ứng dụng của bạn cần, nó có thể bắt đầu kết nối Bluetooth hoặc có thể đợi cho đến lần Làm mới ứng dụng nền tiếp theo.

Chúng tôi thực sự khuyên bạn chỉ nên kết nối với phụ kiện của mình trong khoảng thời gian cần thiết.

Ứng dụng của bạn sẽ yêu cầu ngắt kết nối trong quá trình Làm mới ứng dụng nền.

Chúng ta hãy xem xét kỹ hơn mã để thực hiện điều này.

Khi ai đó khởi chạy ứng dụng của bạn ở phía trước, nó có thể khám phá thiết bị ngoại vi và kết nối với họ.

Phương thức đại diện didDiscoverPeripheral được gọi khi phát hiện quảng cáo.

Nếu bạn đã từng sử dụng CoreBluetooth trong quá khứ, điều này thật quen thuộc.

Bây giờ hãy xem những gì xảy ra trong quá trình Làm mới ứng dụng nền.

Phương thức đại diện handleBackgroundTasks được gọi.

Bạn có thể bắt đầu bất kỳ công việc nền nào của mình và trong trường hợp của chúng tôi, chúng tôi muốn kết nối với thiết bị ngoại vi Bluetooth của mình.

Trong quá trình Làm mới ứng dụng nền, ngay trước khi chấm dứt, bạn cũng nhận được thông báo rằng Làm mới ứng dụng nền sắp kết thúc.

Đây là một API mới trong watchOS 8.

Bạn có thể sử dụng điều này để hủy bỏ bất kỳ công việc hiện có nào và chuẩn bị ứng dụng của mình chuyển sang chế độ tạm ngưng.

Sau đó đặt nhiệm vụ như đã hoàn thành.

Ngoài ra, khi có thời gian chạy nền, bạn cần xác định hành vi sẽ như thế nào khi thiết bị Bluetooth của bạn ngắt kết nối.

Hãy nhớ rằng cuộc gọi lại didDisconnectPeripheral có thể xảy ra khi ở phía trước hoặc trong Làm mới ứng dụng nền và xảy ra trên tất cả các nền tảng.

Ở đây, khi chúng tôi có didDisconnectPeripheral, chúng tôi gọi một hàm được gọi là didCompleteDisconnection nằm trong đại diện WatchKit Extension của bạn.

Bằng cách này, hành vi của hàm này dành riêng cho watchOS.

Chức năng mà CompleteDisconnection thực hiện là xác minh rằng chúng tôi đang ở trong Chế độ Làm mới Ứng dụng Nền và nếu có, chỉ ra rằng nhiệm vụ đã hoàn tất.

Điều này sẽ chấm dứt Làm mới Ứng dụng Nền.

Hãy nói về các phương pháp hay nhất để sử dụng Core Bluetooth trên Apple Watch.

Để thiết lập thiết bị lần đầu, ứng dụng của bạn phải chạy ở phía trước, có nghĩa là người dùng đang tích cực sử dụng ứng dụng Đồng hồ của bạn.

Quét các thiết bị ngoại vi mới tại thời điểm này.

Khi ứng dụng của bạn phát hiện ra thiết bị ngoại vi, nó có thể thiết lập kết nối Bluetooth ban đầu.

Nó cũng có thể ghép nối với thiết bị của bạn nếu cần.

Khi ứng dụng của bạn thoát khỏi tiền cảnh, nó không thể quét thiết bị ngoại vi mới.

Thay vào đó, nó nên yêu cầu kết nối với một thiết bị ngoại vi đã được phát hiện trước đó.

Sau khi kết nối, hãy truy xuất dữ liệu cần thiết.

Sau khi truy xuất xong dữ liệu, ứng dụng của bạn nên ngắt kết nối khỏi thiết bị ngoại vi để bảo quản pin.

Nếu ứng dụng của bạn không ngắt kết nối trước khi Làm mới ứng dụng nền kết thúc, Core Bluetooth sẽ tự động ngắt kết nối khỏi phụ kiện của bạn.

Bạn chỉ có thể kết nối lại khi ứng dụng của bạn có thời gian chạy.

Tôi khuyến khích bạn tham gia phòng thí nghiệm của chúng tôi trong tuần này nếu bạn có bất kỳ câu hỏi nào về Core Bluetooth.

Cảm ơn.

[Âm nhạc].