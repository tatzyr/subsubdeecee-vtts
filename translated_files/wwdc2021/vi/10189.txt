10189

♪ Nhạc bass đang phát ♪

♪

Jer Noble: Xin chào, tôi là Jer!

Và tôi làm việc để phát lại phương tiện trong WebKit và Safari ở đây tại Apple.

Mọi người thích xem các chương trình và bộ phim yêu thích của họ và nghe nhạc cùng nhau, cho dù đó là với những người trong cùng một phòng, bên cạnh hay ở phía bên kia thế giới.

Và bây giờ với GroupActivities, việc cung cấp trải nghiệm SharePlay cho người dùng của bạn trở nên dễ dàng hơn bao giờ hết, dù họ ở đâu.

Trong phiên này, chúng tôi sẽ đề cập đến bốn chủ đề.

Giới thiệu về phát lại phối hợp trong Safari; cách chuẩn bị ứng dụng iOS của bạn hoạt động với SharePlay trong Safari; cách áp dụng API Phiên Phương tiện trong trang web của ứng dụng của bạn; và API web mới để phối hợp phát lại trên nhiều thiết bị.

Vậy hãy bắt đầu bằng cách nói một chút về SharePlay và Safari.

Trong phiên trước, bạn đã học cách tạo trải nghiệm SharePlay tuyệt vời trong các ứng dụng iPhone và iPad của mình với GroupActivities.

Và trên macOS Monterey, bạn có thể mang lại trải nghiệm tương tự - cùng với các ứng dụng iPhone và iPad tuyệt vời của mình - cho Mac bằng Catalyst.

Và nếu ứng dụng của bạn có một trang web đồng hành, bạn có thể mang lại trải nghiệm SharePlay tuyệt vời tương tự cho người dùng Mac Safari 15 của mình mà không yêu cầu những người dùng đó tải xuống ứng dụng của bạn từ App Store.

Và đó là những gì tôi sẽ chỉ cho bạn cách làm trong phiên này.

Tôi đang làm việc trên một ứng dụng iPhone cho phép bạn xem đoạn giới thiệu phim.

Tôi đã thêm hỗ trợ cho GroupActivities vào ứng dụng của mình và điều đó cho phép bạn bè xem đoạn giới thiệu phim cùng nhau qua FaceTime.

Nhưng ứng dụng trailer phim của tôi cũng có một trang web.

Và đây là cách nó sẽ trông như thế nào khi tôi thêm hỗ trợ cho GroupActivities trong trang web đó.

Tôi đang thực hiện một cuộc gọi FaceTime với bạn tôi Sam.

Sam thích xem đoạn giới thiệu phim, vì vậy tôi đã nhờ họ giúp tôi thử nghiệm ứng dụng Đoạn giới thiệu phim mới này.

Khi họ bắt đầu phát đoạn giới thiệu mới trong ứng dụng đó trong cuộc gọi của chúng tôi, tôi sẽ được mời xem đoạn giới thiệu đó thông qua một thông báo.

Nó sẽ cho tôi tùy chọn tham gia phiên trong Safari.

Khi tôi nhấp vào thông báo đó, Safari sẽ được khởi chạy với URL cho nội dung được chia sẻ và khi Sam bắt đầu phát đoạn giới thiệu, nó sẽ phát ở đây trong Safari cùng một lúc.

Tôi có thể tạm dừng, phát và thậm chí tìm kiếm video ở đây trong Safari và mọi người khác trong phiên sẽ thấy những lệnh tương tự được phản ánh trong video cục bộ của họ cùng một lúc.

Nó sẽ thực sự tuyệt vời!

Vậy, cần những gì để thêm hỗ trợ GroupActivities vào trang web đoạn giới thiệu phim?

Trước khi chúng ta xem xét dưới mui xe của Safari - tại các API Web mới có sẵn trong Safari 15 - hãy nói về cách chuẩn bị ứng dụng của bạn để hoạt động với Safari thông qua GroupActivities.

Để tham gia phiên GroupActivities với Safari, người dùng với ứng dụng iPhone hoặc iPad của bạn sẽ cần tạo GroupSessionActivity với URL dự phòng trỏ đến trang web của bạn.

URL dự phòng phải xác định không chỉ trang web của bạn, mà cả nội dung cụ thể sẽ được phát.

Khi lời mời Watch Together được người dùng iPhone phát hành cho người dùng trên máy Mac, Safari sẽ được khởi chạy và yêu cầu tải URL mà bạn cung cấp trong GroupSessionActivity.

Khi fallbackURL được tải trong Safari, trang web của bạn sẽ cần triển khai một vài API Web đơn giản nhưng quan trọng.

Đầu tiên là Phiên Truyền thông.

Media Session là một API Web tiêu chuẩn cho phép trang web của bạn cho trình duyệt biết - Safari - nhiều hơn về trạng thái phát lại phương tiện hiện tại trong trang của bạn.

Trang web của bạn có thể cho trình duyệt biết trạng thái phát hiện tại, thời lượng nội dung của bạn.

Nó có thể cung cấp tác phẩm nghệ thuật cho mục phát lại hiện tại.

Nó thậm chí có thể cho trình duyệt biết rằng nội dung hiện tại là một quảng cáo có thể bỏ qua.

Khi Trình duyệt có sẵn tất cả siêu dữ liệu này, nó có thể cung cấp siêu dữ liệu đó cho phần còn lại của hệ điều hành và trình bày nó cho người dùng của bạn bên ngoài chính cửa sổ trình duyệt.

Một nơi mà hệ điều hành hiển thị dữ liệu nằm trong một thứ gọi là "Đang phát".

Now Playing là một cách tuyệt vời để người dùng nhanh chóng xem và kiểm soát phương tiện mà họ đang thưởng thức ngay bây giờ.

Trong iOS, người dùng có thể truy cập Đang phát từ Trung tâm điều khiển cũng như từ màn hình Khóa.

Và bây giờ trong macOS Monterey, người dùng có thể truy cập Đang phát trực tiếp từ thanh menu.

Và Safari sẽ sử dụng thông tin được cung cấp thông qua Media Session để điền Đang phát với tiêu đề, thời lượng, trạng thái phát, tác phẩm nghệ thuật của nội dung của bạn và hơn thế nữa.

Now Playing cũng cho phép người dùng kiểm soát phát lại những gì họ đang nghe, bằng cách hiển thị cho người dùng một bộ điều khiển phát lại đơn giản.

Trang web của bạn có thể đăng ký với Phiên phương tiện cho các hành động cụ thể để thực hiện khi người dùng tương tác với Đang phát, ví dụ: khi người dùng nhấn vào nút Phát trong Đang phát, Safari có thể chạy trình xử lý hành động của riêng bạn để bắt đầu phát lại.

Media Session cung cấp cho trang web của bạn toàn quyền kiểm soát siêu dữ liệu nào sẽ hiển thị cho trình duyệt, cũng như kiểm soát cách triển khai các lệnh phát lại.

Cần thực hiện một số thiết lập hoặc kiểm tra trước khi bắt đầu phát lại?

Không vấn đề gì.

Với trình xử lý hành động chơi của mediaSession, bây giờ bạn có thể.

Nếu trang web của bạn trước đây đã áp dụng Media Session, bạn đã hoàn thành được một nửa rồi.

Nhưng trang web giới thiệu phim vẫn chưa áp dụng Media Session, vì vậy hãy thêm hỗ trợ cho điều đó ngay bây giờ.

Trang web này sẽ muốn thêm các hành động để chơi, tạm dừng và tìm kiếm.

Để làm như vậy, chúng tôi sẽ sử dụng thuộc tính mediaSession của trình điều hướng.

Trước tiên hãy thêm một trình xử lý hành động để chơi.

Chúng tôi sẽ gọi mediaSession. setActionHandler(), chuyển trong chuỗi phát và một hàm nội tuyến chỉ gọi play() trên phần tử video của chúng tôi.

Sau đó, chúng tôi sẽ làm điều tương tự để tạm dừng và tìm kiếm.

Và để đảm bảo rằng chúng tôi đang thể hiện chính xác trạng thái phát lại cho trình duyệt, chúng tôi sẽ thêm trình nghe sự kiện vào phần tử video của mình và cập nhật mediaSession khi trạng thái đó thay đổi.

Đầu tiên, hãy thêm một hàm gọi là updateMediaSessionState().

Nó sẽ truy vấn phần tử video để tìm hiểu xem nó đang phát hay tạm dừng.

Sau đó, nó sẽ đặt thuộc tính playbackState của mediaSession thành chuỗi đang phát hoặc tạm dừng, tùy thuộc vào trạng thái phát lại của phần tử video.

Tiếp theo, nó sẽ truy vấn thời lượng, tốc độ phát lại và thời gian hiện tại của phần tử video.

Sau đó, sử dụng các giá trị đó, nó sẽ gọi hàm setPositionState() của mediaSession, truyền các giá trị đó vào tham số từ điển.

Sau đó, hãy thêm một trình nghe sự kiện để phát hiện khi nào các giá trị đó thay đổi và gọi updateMediaSessionState() để cập nhật mediaSession với các giá trị mới đó.

Chúng ta sẽ cần một trình nghe sự kiện để phát, tạm dừng, thay đổi thời lượng, thay đổi tốc độ và thay đổi thời gian.

Và cuối cùng, vì trang web đoạn giới thiệu phim có cả chuỗi tiêu đề và URL cho tác phẩm nghệ thuật tiêu đề, chúng tôi có thể đặt thuộc tính siêu dữ liệu của Media Session thành đối tượng MediaMetadata mới chứa các giá trị đó.

Vậy hãy thử nó!

Tôi sẽ tải lại trang của mình trong Safari, bắt đầu chơi, sau đó nhấp vào biểu tượng Đang phát trong menu hệ thống.

Và tôi thấy tiêu đề và tác phẩm nghệ thuật trong bảng Đang phát.

Và khi tôi nhấn vào nút Tạm dừng, trình xử lý hành động tạm dừng của chúng tôi được gọi và tạm dừng phát lại.

Media Session cung cấp các khối xây dựng cho trải nghiệm Watch Together trong một trang web, bằng cách cung cấp một cơ chế để trình duyệt thông báo cho trang rằng nó nên bắt đầu hoặc dừng phát lại.

Bây giờ chúng tôi đã sẵn sàng chuyển sang phần thứ hai của việc tạo trải nghiệm đồng xem trong trang web của chúng tôi: phối hợp phát lại trên mọi thiết bị trong phiên.

Để làm như vậy, chúng tôi đã mở rộng Phiên Truyền thông bằng cách thêm một thuộc tính mới vào đó có tên là "Điều phối viên".

Trang của bạn sẽ sử dụng Điều phối viên của Phiên Truyền thông để thông báo cho mọi người dùng khác trong phiên về ý định bắt đầu hoặc tạm dừng phát lại của trang, tìm đến một điểm cụ thể trong dòng thời gian của phương tiện hoặc chuyển sang mục tiếp theo trong danh sách phát.

Điều phối viên sẽ truyền đạt những ý định đó với tất cả các thiết bị khác trong phiên và lắng nghe các thay đổi đối với trạng thái phát của mọi thiết bị khác, giải quyết xung đột và chờ mọi người sẵn sàng bắt đầu phát lại.

Và khi mọi người đã sẵn sàng, Điều phối viên sẽ sử dụng trình xử lý hành động Phiên phương tiện mà chúng tôi đã thêm trước đó để bắt đầu phát lại cùng với tất cả những người dùng khác trong phiên.

Và nếu một người dùng khác tạm dừng phát lại vì bất kỳ lý do gì, Điều phối viên sẽ gọi trình xử lý hành động tạm dừng Phiên Truyền thông của bạn.

Điều đó nói rằng, tôi muốn chỉ ra một vài lưu ý.

Giao diện Điều phối viên là một API web thử nghiệm; nó vẫn chưa trải qua tiêu chuẩn hóa và trong khi quá trình đó có thể sẽ cải thiện API này, một số khía cạnh của API có thể thay đổi.

Để tìm hiểu thêm, vui lòng xem trang GitHub Phiên Truyền thông của W3C.

API này hiện chỉ được triển khai trong Safari, mặc dù khung GroupActivities, mà Safari sử dụng để triển khai Điều phối viên, có thể - và chúng tôi hy vọng sẽ - được các trình duyệt Mac khác áp dụng.

Và cảnh báo cuối cùng là trong khi người dùng của bạn có thể tham gia một phiên hiện có trong Safari, GroupSession hiện tại phải được khởi tạo từ ứng dụng iPhone, iPad hoặc macOS.

Vì vậy, hãy thêm hỗ trợ cho Điều phối viên ngay bây giờ.

Điều đầu tiên tôi muốn làm là tham gia phiên khi nó có sẵn.

Vì vậy, tôi sẽ thêm một người nghe sự kiện thay đổi điều phối viên vào mediaSession.

Trong trình xử lý, nếu có thuộc tính điều phối viên không phải null trên mediaSession, tôi sẽ gọi hàm join() của nó.

Tôi cũng muốn thêm một biểu tượng vào các điều khiển của mình để hiển thị rằng chúng tôi đang phát lại trong một phiên.

Vì vậy, trong trình xử lý, tôi sẽ hiển thị hoặc ẩn biểu tượng, dựa trên việc có thuộc tính điều phối viên trên mediaSession hay không.

Tôi cũng sẽ kết nối trình nghe sự kiện nhấp chuột với biểu tượng để gọi leave() trên điều phối viên.

Tiếp theo, tôi sẽ sửa đổi trình xử lý sự kiện cho các điều khiển tùy chỉnh của mình để kiểm tra sự hiện diện của điều phối viên và nếu chúng tôi có, hãy gọi chức năng điều phối viên thích hợp thay thế.

Tôi sẽ thêm một cái cho nút Phát của mình, và sau đó cho nút Tạm dừng của tôi, và cả cho thanh trượt dòng thời gian.

Và hãy xem nó hoạt động!

Tôi nhận được lời mời ở đây từ bạn tôi Sam, và tôi sẽ chấp nhận nó.

Trang của tôi tải cùng một nội dung mà Sam đang xem trên iPhone của họ.

Và khi tôi nhấp vào nút Phát, cả iPhone của Sam và trang web của tôi bắt đầu phát đồng thời.

Allie Fox: Cách chúng ta đến đó là một cuộc phiêu lưu.

Dina: Tôi sợ.

Allie: Nếu nó không cảm thấy như vậy, nó sẽ không phải là một cuộc phiêu lưu.

♪ < Điều đó thật tuyệt.

Bây giờ đoạn giới thiệu đã kết thúc, Sam sử dụng iPhone để quay trở lại từ đầu.

Chúng tôi nghĩ rằng người dùng sẽ thích xem hoặc nghe nội dung yêu thích của họ cùng nhau trong các ứng dụng của bạn, cho dù đó là trên iPhone, iPad, Apple TV hay trong Safari đang chạy trên máy Mac của họ.

Và chúng tôi hy vọng bây giờ bạn có thể mang lại trải nghiệm đó cho tất cả người dùng của mình, dù họ ở đâu.

Để biết thêm thông tin về GroupActivities APIs, hãy bắt đầu với các phiên "Phối hợp phát lại phương tiện với Hoạt động Nhóm" và "Thiết kế cho Hoạt động Nhóm".

Nếu bạn quan tâm đến các API web mới khác sẽ có sẵn trong Safari 15, hãy đảm bảo kiểm tra phiên, "Phát triển nội dung web nâng cao".

Cảm ơn vì đã đến và tận hưởng phần còn lại của WWDC21 của bạn.

♪