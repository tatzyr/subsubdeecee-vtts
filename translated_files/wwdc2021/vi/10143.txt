10143

♪ Nhạc bass đang phát ♪

Nishant Nelogal: Xin chào, và chào mừng đến với WWDC.

Tên tôi là Nishant, và tôi là một kỹ sư trong nhóm AVFoundation.

Hôm nay, chúng ta sẽ xem xét các biến thể HLS.

Đầu tiên, chúng tôi sẽ xem xét cách bạn có thể kiểm tra các biến thể HLS, sử dụng API AVFoundation và sau đó, chúng tôi sẽ xem cách chúng tôi có thể sử dụng các biến thể HLS khi tải xuống.

Vậy hãy bắt đầu với việc kiểm tra biến thể.

Tất cả các bạn phải quen thuộc với danh sách phát chính điển hình trông như thế nào.

Đây là một ví dụ.

Trong danh sách phát cụ thể này, chúng tôi có hai biến thể.

Một trong những biến thể là biến thể SDR với âm thanh nổi, và biến thể còn lại là biến thể Dolby Vision với âm thanh Dolby Atmos.

Nội dung đại diện cho danh sách phát cụ thể này có thể được trình bày một cái gì đó như thế này trong ứng dụng của bạn.

Nhìn kỹ, bạn thấy rằng tài sản có huy hiệu 4K, Dolby Vision và Dolby Atmos.

Trước đó, bạn phải lấy thông tin như vậy ra khỏi ban nhạc.

Bây giờ trong iOS 15, bạn có thể trực tiếp kiểm tra danh sách phát HLS để suy ra chúng.

Đối với điều đó, bạn bắt đầu với một AVURLAsset trỏ đến vị trí của danh sách phát chính của bạn.

Sau đó, bạn có thể lấy danh sách phát HLS thông qua thuộc tính của biến thể.

AVAssetVariant này, như chúng ta thấy ở đây, đại diện cho một biến thể HLS như từ danh sách phát chính.

Vì vậy, nó có nhiều thuộc tính đại diện cho các thuộc tính phương tiện khác nhau.

Một số thuộc tính, chẳng hạn như tốc độ bit phương tiện, có thể được truy cập trực tiếp.

Các thuộc tính khác, chẳng hạn như những thuộc tính liên quan đến kết xuất video và âm thanh, được nhóm lại với nhau trong các lớp con của riêng chúng.

Chúng được gọi lần lượt là Thuộc tính Video và Thuộc tính Âm thanh.

Như bạn thấy, mỗi người trong số họ có các thuộc tính có liên quan, mà bạn có thể sử dụng để hiểu tài sản của mình.

Bây giờ bạn đã biết cách kiểm tra các biến thể HLS trong AVFoundation.

Hãy xem cách chúng ta có thể sử dụng chúng với các bản tải xuống.

Tải xuống nội dung HLS để phát lại ngoại tuyến đã được hỗ trợ từ năm 2016.

Nếu bạn không quen thuộc với các API tải xuống HLS, tôi khuyên bạn nên xem bài nói chuyện trước đó của chúng tôi về chủ đề này từ WWDC 2020.

Trong iOS 15, chúng tôi đang sử dụng các API tải xuống HLS của mình và làm cho chúng trở nên mạnh mẽ hơn.

Thông thường, bạn muốn ảnh hưởng đến các biến thể HLS được chọn để tải xuống.

Điều này có thể là do các yêu cầu kinh doanh, hoặc bạn chỉ muốn cung cấp nhiều sự lựa chọn hơn cho người dùng của mình.

Trước đây, bạn có thể cung cấp đầu vào như vậy thông qua các tùy chọn downloadTask.

Chúng tôi đã có một tùy chọn cho HDR, một tùy chọn cho âm thanh không mất dữ liệu và một vài thuộc tính khác.

Trong iOS 15, chúng tôi đang mở rộng lựa chọn biến thể với việc sử dụng NSPredicates.

Bạn có thể đã quen với việc sử dụng các vị ngữ từ Core Data.

Nếu không, đừng lo lắng, bạn sẽ tìm hiểu về chúng ngay hôm nay.

Vì vậy, để bắt đầu, hãy để tôi giới thiệu giao diện vòng loại biến thể.

Giao diện này cho phép bạn chỉ định các tùy chọn biến thể của mình cho AVFoundation.

Và, như tôi đã nói, chúng có thể được xây dựng bằng NSPredicates.

Hãy hiểu bằng cách xem xét một vài ví dụ.

Ở đây, chúng tôi có một NSPredicate thể hiện tốc độ bit cực đại nhỏ hơn năm megabit.

Bạn sử dụng điều này để xây dựng vòng loại biến thể của mình, hướng dẫn AVFoundation thích các biến thể dưới năm megabit.

Đủ đơn giản, phải không?

Hãy xem xét một ví dụ khác.

Ở đây chúng tôi tạo ra một NSPredicate cho phạm vi video HDR.

Và tương tự như trước đây, bạn có thể xây dựng một vòng loại biến thể cho nó.

Bạn cũng có thể kết hợp nhiều vị ngữ để tạo ra một vị ngữ ghép và sử dụng chúng để tạo vòng loại biến thể của mình.

Bất kỳ thuộc tính nào trên biến thể đều có thể được sử dụng để tạo ra một vị ngữ chống lại.

Đối với các thuộc tính như số lượng kênh âm thanh, không thể dễ dàng thể hiện bằng cách sử dụng chuỗi định dạng vị ngữ, chúng tôi có các hàm tạo tùy chỉnh.

Bạn có thể tra cứu chúng trong tài liệu tiêu đề của chúng tôi để biết vòng loại biến thể.

Khi bạn có vòng loại biến thể của mình, bạn sử dụng nó để tạo ra thứ gọi là cấu hình nội dung.

Mỗi cấu hình nội dung đại diện cho một tập hợp các phiên bản video, âm thanh và phụ đề.

Được rồi, hãy hiểu bằng một ví dụ.

Đây là vòng loại biến thể kết hợp hai vị ngữ mà chúng ta đã thấy trước đó.

Eh, đây là sự kết hợp. Ha-ha.

Nó thông báo cho AVFoundation thích các biến thể HDR dưới năm megabit.

Chúng tôi cũng có một tập hợp các lựa chọn phương tiện đại diện cho âm thanh tiếng Anh và tiếng Pháp, và các phiên bản phụ đề tiếng Anh.

Cả hai thứ này đều có thể được sử dụng để tạo ra một đối tượng cấu hình nội dung.

Bạn có thể tạo nhiều cấu hình nội dung này và cung cấp nó cho downloadTask.

Nhiều cấu hình nội dung này được liên kết với nhau bởi giao diện cấu hình tải xuống.

Đây là gốc rễ giữ mọi thứ lại với nhau.

Nó được tạo bằng AVURLAsset và cần một tên tài sản, và tùy chọn, một hình ảnh.

Tên tài sản và hình ảnh được hiển thị trong ứng dụng Cài đặt.

Điều này cho phép người dùng của bạn quản lý tất cả các bản tải xuống của họ ở một nơi trong ứng dụng Cài đặt.

Và tất nhiên, downloadTask có thể được cấu hình với nhiều cấu hình nội dung.

Nhìn kỹ, một trong những cấu hình nội dung sẽ được chỉ định là chính và phần còn lại sẽ là phụ trợ.

Sự khác biệt giữa cả hai là bạn thường muốn tải xuống một bộ video, âm thanh và phụ đề chính và sau đó bổ sung chúng bằng các phiên bản âm thanh hoặc phụ đề bổ sung.

Bằng cách chỉ định các phiên bản bổ sung của bạn dưới dạng cấu hình nội dung phụ trợ, bạn hướng dẫn AVFoundation tối ưu hóa và tránh tải xuống nhiều bản hiển thị video.

Nó trở nên rõ ràng hơn khi chúng ta xem qua một ví dụ.

Đây là ví dụ đầy đủ.

Đầu tiên, chúng tôi bắt đầu bằng cách tạo một cấu hình tải xuống với AVURLAsset và một tiêu đề.

Cấu hình nội dung chính giống như cấu hình mà chúng ta đã thấy trước đó.

Nó được cấu hình để tải xuống các biến thể HDR dưới năm megabit, với âm thanh tiếng Anh và tiếng Pháp và các phiên bản phụ đề tiếng Anh.

Trong ví dụ cụ thể này, chúng tôi muốn bổ sung nó bằng cấu hình nội dung phụ trợ để tải xuống âm thanh tiếng Anh ở định dạng không mất dữ liệu.

Bây giờ chúng tôi có cả hai cấu hình nội dung mà chúng tôi muốn tải xuống.

Đảm bảo đặt optimizesAuxiliary ContentConfigurations thành true.

Nhân tiện, nó đúng theo mặc định và nó cho phép AVFoundation chọn biến thể không mất dữ liệu, sao cho việc hiển thị video của biến thể không mất dữ liệu giống như cấu hình nội dung chính.

Đặt nó thành sai có thể khiến biến thể không mất dữ liệu được đánh giá độc lập, điều này có thể khiến các bản trình diễn video trùng lặp được tải xuống.

Điều này có thể làm tăng kích thước tải xuống của bạn, điều mà chúng tôi không muốn.

Được rồi, một khi bạn có cấu hình tải xuống, bạn có thể sử dụng nó để tạo downloadTask.

Bạn tiếp tục tải xuống Nhiệm vụ để bắt đầu tải xuống.

Bắt đầu từ iOS 15, bạn cũng có thể quan sát tiến trình của downloadTask bằng giao diện NSProgress.

Đối tượng NSProgress có thể quan sát KVO và bạn có thể sử dụng nó để cập nhật giao diện người dùng của mình.

Tiếp tục.

Chúng tôi hiểu rằng một số bạn có thể có logic kinh doanh để chọn các biến thể, điều này có thể khó diễn đạt hơn thông qua các vị ngữ.

Đối với những trường hợp như vậy, bạn cũng có thể chọn chọn các biến thể bạn muốn tải xuống một cách rõ ràng.

Ở đây trong ví dụ này, chúng tôi đã chọn biến thể chính và phụ trợ của mình và các lựa chọn phương tiện đi kèm với nó.

Chúng tôi có thể hướng dẫn AVFoundation tải chúng xuống như hiện tại, bằng cách tạo vòng loại trực tiếp với biến thể.

Hãy cẩn thận chọn các biến thể để chúng có thể chơi được trên thiết bị nơi chúng được tải xuống.

Đó là tất cả những gì chúng ta có hôm nay, các bạn.

Để kết thúc, chúng tôi đã xem xét cách bạn có thể kiểm tra các biến thể HLS và sử dụng chúng để định cấu hình downloadTask.

Trên đường đi, chúng tôi đã gặp phải các giao diện khác nhau để cấu hình downloadTask.

Cái đầu tiên là vòng loại biến thể.

Điều này được sử dụng để thể hiện sở thích biến thể của bạn.

Sau đó chúng tôi thấy giao diện cấu hình nội dung.

Cấu hình nội dung liên kết các tùy chọn biến thể của bạn và các lựa chọn lựa chọn phương tiện của bạn.

Cuối cùng, chúng tôi đã thấy cấu hình tải xuống.

Cấu hình tải xuống là giao diện gốc liên kết mọi thứ lại với nhau.

Cuối cùng, nhưng không kém phần quan trọng, chúng tôi cũng đã học được rằng bạn có thể theo dõi downloadTask của mình bằng NSProgress.

Để biết thêm thông tin, hãy kiểm tra tài liệu tiêu đề của chúng tôi.

Họ được bình luận rất tốt.

Cảm ơn bạn đã xem và tạm biệt!

♪