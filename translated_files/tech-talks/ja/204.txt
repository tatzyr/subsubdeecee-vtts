204

アプリ開発者として、アプリがディスクに何を保存しているのか、すべてがどこに保存されているのか、なぜそれが必要なのかを正確に知ることが重要です。

これらの詳細を把握する最善の方法は、アプリが実際に保存しているものを棚卸しすることです。

開始するには、デバイスでアプリを構築して実行し、ディスクに物事を保存するすべての機能を行使します。

これを行うと、実際に何が保存され、どこで保存されているかを見る時が来ました。

Xcodeのデバイスとシミュレーターウィンドウを使用して、アプリのコンテナを抽出し、その中に何が入っているかを確認できます。

左側の列でデバイスを選択し、インストール済みアプリリストでアプリを選択します。

そして、歯車アイコンを使用して、ダウンロードコンテナを選択し、Macに保存します。

Finderで、ダウンロードしたxcappdataファイルをControlキーを押しながらクリックします。

「パッケージ内容を表示」を選択し、「App Data」フォルダに移動し、インベントリを開始します。

ディレクトリを見て、それぞれに何が保存されているかを確認してください。

各ファイルについて、それが何であるか、なぜそれが保存されているのかを特定できることを確認してください。

なぜ何かがあるのかわからない場合は、それを取り除くことができるかもしれません。

適切なディレクトリに正しいファイルを入れていることを確認し、そのファイルをiTunesとiCloudのバックアップに含めるかどうかも検討する必要があります。

アプリの機能に関係しているため、最初の2つの質問に答えることができるのはあなただけです。

最後の2つの質問に焦点を当て、ファイルを保存する場所から始めます。

iCloud Driveは、ユーザーのすべてのデバイスで使用可能になるため、ドキュメントを置くのに最適な場所です。

iCloud Drive上のアプリのフォルダの内容が表示されるため、人々が認識して直接アクセスするドキュメントのみを入れることが重要です。

アプリはコンテンツをローカルで読み書きし、ネットワークが利用可能になると、オペレーティングシステムは自動的にそれらのファイルをアップロードします。

複数のデバイスが同時にiCloud Driveのファイルにアクセスしている可能性があるため、競合を避けるためにファイル調整を使用する必要があります。

詳細については、必ずドキュメントをお読みください。

ローカルに保存されたファイルの場合、ドキュメントディレクトリはアプリのコンテナで使用できます。

iCloud Driveと同様に、ここにはユーザーに表示されるドキュメントのみを保存する必要があります。

ドキュメントディレクトリに公開する必要があるファイルのみが含まれていることを確認したら、ファイルアプリはOn My iPhoneまたはOn My iPadの場所に表示できます。

これを行うには、アプリはOpen in Placeをサポートし、ファイル共有が有効になっていることを示す必要があります。どちらもInfo.plistファイルで設定されています。

ファイルアプリで自分のファイルを見ることに加えて、人々はSpotlightやiPadで自分のファイルを他のアプリにドラッグアンドドロップすることができます。

ドキュメントディレクトリを公開するもう1つの大きな利点は、ストレージ設定UIでファイルを表示し、アイテムを個別に削除できることです。

これにより、ディスク容量の管理がはるかに簡単になり、容量が少ないときにアプリ全体が削除される可能性が低くなります。

しかし、ドキュメントディレクトリに入るべき唯一のものは、あなたのアプリを使用している人々にとって意味のあるファイルであることを覚えておいてください。

あなたが尋ねるべき重要な質問は、「私のユーザーはこのファイルを見ることができるべきですか？」です。

答えがイエスなら、それでいい。

しかし、答えが「いいえ」の場合は、ドキュメントディレクトリから次のいずれかの場所に移動します。

アプリケーションサポートディレクトリは、ドキュメントディレクトリにあるかもしれないが、ユーザーが見るべきではないファイルを保存するのに適した場所です。

たとえば、アプリが必要とするが、ユーザーが手動で開くことのないデータベース。

ファイルをトップレベルに保存することも、物事を整理するのに役立つ場合はディレクトリを作成することもできます。

ディレクトリは完全にあなたの管理下にあり、永続的です。

コンテンツはデフォルトでバックアップに含まれていますが、バックアップする必要がない場合は、ファイルをオプトアウトできます。

そして最後に、アプリケーションサポートディレクトリで使用されるディスク容量は、アプリのドキュメントとデータの合計の下のストレージ設定UIで報告されます。

アプリで利用可能な次の場所は、Cachesディレクトリです。

スペースが少ない場合に破棄できるファイルをここに保存できます。

これは、必要なときに再ダウンロードできるコンテンツに適した場所です。

キャッシュディレクトリの内容はバックアップに含まれていません。

デバイスのディスク容量が少ない場合、iOSはキャッシュをクリアすることで役立ちます。

アプリが実行されている場合、ファイルはキャッシュディレクトリから削除されることはなく、オペレーティングシステムはしばらく使用されていないアプリのキャッシュをクリアすることから始めます。

ボーナスとして、キャッシュディレクトリ内のファイルは、アプリのドキュメントとデータの合計の一部として報告されません。

それらはアプリが占める全体的なスペースに含まれていますが。

そして最後に、長期間必要ないファイルを一時ディレクトリに配置できます。

アプリが実行されていないとき、オペレーティングシステムはこれらのファイルを定期的に削除しますが、使い終わったら削除するのが最善です。

キャッシュディレクトリと同様に、一時ディレクトリはバックアップされず、アプリのドキュメントとデータの合計には報告されません。

これらはすべて、アプリがファイルを保存できる一般的な場所です。

ファイルアプリでアクセスできるファイルにはiCloud Driveとドキュメントディレクトリを使用しますが、アプリケーションサポート、キャッシュ、および一時ディレクトリはすべてアプリが個人的に使用できます。

物を保存する場所を必ず確認し、適切なディレクトリを使用してください。

最後に、いくつかのベストプラクティスのヒント。

iTunesやiCloudのバックアップに含める必要のないファイルがある場合は、NSFileManager APIを使用して「IsExcludedFromBackupKey」を設定してください。

また、古いバージョンのアプリから復元される可能性のあるファイルに対しても回復力があります。

たとえば、アプリの32ビットバージョンがあり、そのファイルがバックアップされている場合、アプリの64ビットバージョンでは、それらの古いファイルが復元される可能性があり、その状況を処理できる必要があります。

アプリの複数のバージョン間で堅牢な互換性を提供できるように、ファイルにバージョン管理スキームを使用するのが最善です。

そして、ファイルを1か所にしか保存していないことを確認してください。

たとえば、ファイルをローカルのドキュメントディレクトリに入れる場合は、iCloud Driveでファイルを複製しないでください。

1つの場所を選択し、それに固執します。

ユーザードキュメントについては、デバイスにローカルのみファイルを保存する特定の理由がない限り、クラウドストレージの場所を好むことをお勧めします。

そして最後に、iOS 11では、アプリがより多くのディスク容量を占有するのに良い時期かどうかを知るのに役立つ新しいボリューム容量の詳細がいくつか用意されています。

最初のキー「重要な使用のために利用可能な容量」は、ユーザーがアプリのUIで明示的に要求したものに利用できるスペースの量を示します。

例えば、彼らがビデオやゲームの新しいレベルをダウンロードすることを選択した場合。

必要なスペースが利用可能なスペースよりも大きい場合は、彼らの要求を満たすことができないことを彼らに知らせるべきです。

2番目のキー「Oportunistic Usageの利用可能な容量」は、ユーザーが望む可能性が高いが、明示的に要求していないものに利用可能なスペースの量を示します。

これは、彼らが見ている一連のビデオの次のエピソード、または彼らが開く可能性のあるサーバー上の最近更新されたドキュメントのようなものかもしれません。

これらのタイプのファイルについては、実際に使用されるまで最初にCachesディレクトリに保存し、その時点でアプリケーションサポートまたはドキュメントディレクトリに移動できます。

インベントリを取り、アプリが保存したものを特定した後、適切な場所にないものを見つけた場合は、コードを更新して適切なディレクトリに入れます。

また、ある場所から別の場所にファイルを移動するために必要な移行コードを追加することを忘れないでください。

これをしないと、誤って放棄されたファイルを置き去りにする可能性があります。

ディスク上のストレージをクリーンアップすることで、ドキュメントディレクトリをファイルアプリの人々に開くことができ、アプリで生産性をさらに高めることができます。

詳細については、developer.apple.comまたは開発者フォーラムをご覧ください。

見てくれてありがとう!