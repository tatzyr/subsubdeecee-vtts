702

こんにちは、私はNFCチームのローレンスです。

このCore NFCアップデートへようこそ。

今年はCore NFCの新機能があり、NFCエクスペリエンスを強化するだけでなく、アプリケーション内でNFCタグを処理するプロセスを大幅に簡素化します。

Core NFCを初めての場合は、昨年リリースされた「Introduction to Core NFC」ビデオを見ることをお勧めします。

新しいバックグラウンドタグ読み取り機能により、iPhoneは自動的にNFCタグを読み取り、適切なアプリに配信することができます。

このメカニズムは、必要なアプリの起動を実行したり、アプリケーションをフォアグラウンド状態にしたりすることができます。

私たちは、これがユーザーエクスペリエンスをさらに良くし、アプリがNFCタグを簡単に処理できるようにする方法を見て興奮しています。

このビデオでは、NFCタグのデータ要件、予想されるユーザーエクスペリエンス、バックグラウンドタグの読み取りがサポートされている場合、および開始するためのコードスニペットの例について説明します。

バックグラウンドタグの読み取りは、NFDEFメッセージにURLレコードが含まれているNDEF形式のタグで動作します。

NDEFメッセージで最初に検出されたURLレコードのみが処理されます。

メッセージをアプリケーションにルーティングするには、URLレコードに有効なAppleユニバーサルリンクURLが含まれている必要があります。

iOSは、Apple Universal Linkに登録されているアプリケーションにメッセージをルーティングします。

画面がオンになっている間、背景タグの読み取りは近くのNFCタグをスキャンします。

互換性のあるタグが正常に読み込まれると、通知センターからのポップアップがiPhoneの画面に表示されます。

通知をタップすると、Apple Universal Linkメカニズムを使用して、関連するアプリケーションへのNSUserActivityオブジェクトの配信がトリガーされます。

デフォルトでは、Safariは未登録のアプリケーションリンクをすべて処理し、URLペイロードのみを処理します。

デフォルトのiOSの動作を引き起こす他のURLスキームもありますが、これについては後で説明します。

未処理の通知は、今後の参照のために通知センターに保存されます。

ユーザーがNFCタグをタップすると次のようになります。

通知が表示され、通知をタップすると、登録されたアプリケーションが起動します。

アプリケーションが実行されると、NFCタグを再度タップすると、新しい通知がトリガーされます。

タグがロックされた状態で読み込まれると、タグデータを処理する前に、最初に電話のロックを解除するように求められます。

背景タグの読み取りは、iPhone XS、iPhone XS Max、iPhone XRでサポートされています。

バックグラウンドタグの読み取りが動作するためには、起動後、まず少なくとも1回はロックを解除する必要があります。

最初のロック解除後、デバイスは、次の条件を除いて、ロック状態に関係なく、ディスプレイがオンになっているたびにバックグラウンドでNFCタグをスキャンします。コアNFCリーダーセッションが進行中、ウォレットまたはApple Payが使用中、カメラが使用中、またはデバイスが機内モードです。

それでは、NFCタグの内容を受け取るために、アプリケーションに必要な実装手順を順を追って説明します。

これは3つの主要なステップに分かれています。

ユニバーサルリンクの要件に従って、アプリケーションに関連付けられたドメインを登録する必要があります。

次に、UIApplicationDelegateプロトコル、application(_:continue: restorationHandler:)機能を採用する必要があります。

最後に、NSUserActivityオブジェクトのndefMessagePayloadプロパティからNDEFメッセージを抽出する必要があります。

アプリにドメインを登録するには、Xcodeでプロジェクトを開き、関連するドメインセクションにサーバーホストドメインを入力します。

これは、UIKitアプリケーションでNSUserActivityオブジェクトを受け取る方法を示すコードスニペットです。

まず、コアNFCフレームワークをインポートします。

UIApplicationDelegateプロトコルメソッド、アプリケーション(_:continue: restorationHandler:)を実装します。

ハンドラでアクティビティタイプがNSUserActivityTypeBrowsingWebであることを検証します。

ndefMessagePayloadプロパティからNFCNDEFMessageを読み取ります。

これには、NFCタグから読み取られたNDEFメッセージ全体が含まれています。

メッセージには、NFC NDEFペイロードレコードの配列が含まれています。

各NDEFレコードには、typeNameFormat、Type、Identifier、およびデータペイロードが含まれています。

NFC NDEFペイロードの1つには、アプリケーションの起動をトリガーしたユニバーサルリンクのURLレコードが含まれます。

さまざまなレコードタイプの定義については、NFCフォーラムの仕様を参照してください。

受信したNSUserActivityオブジェクトがバックグラウンドタグの読み取りから発信されていない場合、結果のNFCNDEFMessageには、typeNameFormatプロパティがNFCTypeNameFormatEmptyに設定された正確に1つのNFC NDEFペイロードオブジェクトが含まれます。

URLレコードにユニバーサルリンクが含まれていない場合でも、iOSはHomeKit、SMS、GPSなどのQRコードスキャナと同じURIスキームの多くを処理できます。

以下は、サポートされているさまざまなスキームの例です。

Core NFCの詳細については、developer.apple.comをご覧ください。