110359

♪ Nhạc cụ hip hop êm dịu ♪

♪

Xin chào, tên tôi là Anders.

Trong video này, tôi sẽ chỉ cho bạn cách bắt đầu với các plugin gói Swift.

Các gói Swift đã được giới thiệu trong Xcode 11.

Họ cung cấp một cách tuyệt vời để phân phối thư viện dưới dạng mã nguồn.

Xcode 14 mở rộng cách tiếp cận này cho quy trình phát triển của bạn, cho phép bạn sử dụng các plugin để làm những việc như tạo mã nguồn trong quá trình xây dựng hoặc tự động hóa các tác vụ phát hành của mình.

Chúng ta sẽ bắt đầu bằng cách xem xét các plugin gói là gì và chúng hoạt động như thế nào, sau đó nói chi tiết hơn về hai loại plugin gói mà Xcode 14 hỗ trợ: plugin lệnh và plugin công cụ xây dựng.

Vậy trước hết, plugin là gì?

Plugin gói là một tập lệnh Swift có thể thực hiện các hành động trên gói Swift hoặc dự án Xcode.

Một plugin sử dụng API mà Xcode cung cấp đặc biệt cho mục đích này.

Các plugin gói được triển khai dưới dạng các gói Swift.

Một gói có thể cung cấp các plugin cùng với các thư viện và tệp thực thi, hoặc một gói chỉ có thể tập trung vào việc cung cấp các plugin.

Một plugin gói có thể được triển khai bằng cách sử dụng nhiều tệp nguồn và một gói Swift có thể xác định nhiều hơn một plugin.

Một plugin chuyên dụng cao có thể là riêng tư cho gói cung cấp nó và trong trường hợp đó, nó chỉ có sẵn trong gói đó.

Nhưng một plugin có mục đích chung có thể được cung cấp cho các gói khác bằng cách xác định nó là một sản phẩm gói.

Điều đó cũng cho phép các gói khác sử dụng nó, theo cách tương tự như cách một gói có thể sử dụng thư viện từ một gói khác.

Nhưng không giống như thư viện, sự phụ thuộc vào plugin không đưa nội dung thời gian chạy vào ứng dụng của bạn.

Thay vào đó, nó cho phép bạn truy cập các công cụ phát triển chạy trên máy của riêng bạn hoặc trong tự động hóa xây dựng của bạn.

Vậy một gói plugin có thể làm gì?

Chà, trong Xcode 14 có hai loại plugin gói: plugin lệnh và plugin công cụ xây dựng.

Các plugin lệnh thực hiện các hành động tùy chỉnh mà bạn có thể chạy bất cứ khi nào bạn muốn.

Họ có thể chạy các trình định dạng mã nguồn hoặc linters, hoặc họ có thể thực hiện các tác vụ khác như một phần của quy trình phát triển của bạn.

Điều đó có thể bao gồm cập nhật danh sách người đóng góp hoặc ngày bản quyền trong các tệp nguồn dựa trên lịch sử Git hoặc những thứ khác mà bạn có thể có các tập lệnh tùy ý để làm ngay hôm nay.

Nếu cần, một plugin lệnh có thể yêu cầu quyền sửa đổi các tệp trong một gói.

Và điều đó đặc biệt hữu ích cho việc định dạng mã.

Không phải tất cả các plugin lệnh đều cần quyền ghi.

Một số lệnh có thể tạo báo cáo hoặc tính toán số liệu về mã của bạn mà không cần thực hiện bất kỳ thay đổi nào.

Các plugin công cụ xây dựng mở rộng biểu đồ phụ thuộc của hệ thống xây dựng.

Chúng đặc biệt hữu ích cho việc tạo mã nguồn hoặc tài nguyên như một phần của bản dựng.

Không giống như các plugin lệnh, được gọi cho toàn bộ gói hoặc dự án tại một thời điểm, các plugin công cụ xây dựng được áp dụng cho từng mục tiêu cần chúng.

Hãy xem xét việc sử dụng một plugin lệnh trong Xcode.

Đây là một ứng dụng iOS nhỏ hiển thị nhiều loại hình dạng hình học khác nhau.

Nó bao gồm một dự án ứng dụng và một gói cục bộ.

Gói triển khai một thư viện cung cấp các loại dữ liệu cốt lõi và logic cho ứng dụng.

Tôi đang nghĩ đến việc tách gói thành kho lưu trữ riêng của nó để những người khác có thể sử dụng nó và như một phần của việc này, tôi muốn tạo một tệp đóng góp liệt kê tất cả những người đã cam kết mã của gói này.

Tôi có thể viết một kịch bản tùy chỉnh để làm điều này.

Nhưng tôi biết một gói cung cấp một số plugin hữu ích để làm việc với mã và tôi nghĩ nó có một plugin thực hiện chính xác những gì tôi muốn.

Để có quyền truy cập vào các plugin đó, tôi sẽ làm điều tương tự như thể tôi cần một thư viện từ một gói khác: Tôi sẽ thêm một phụ thuộc gói vào bản kê khai của gói cục bộ của mình.

Khi tôi lưu bản kê khai, Xcode tìm nạp gói từ xa và nó xuất hiện trong phần Phụ thuộc gói.

Tôi nhận thấy rằng Xcode cũng đã tìm nạp SwiftFormat, đây là một công cụ phổ biến để định dạng mã.

Điều này là do một trong những plugin lệnh trong gói tiện ích lần lượt phụ thuộc vào SwiftFormat.

Bây giờ tôi đã thêm sự phụ thuộc này, tôi có quyền truy cập vào bất kỳ lệnh plugin nào mà gói cung cấp.

Tôi sử dụng trình đơn ngữ cảnh trên gói mà tôi muốn áp dụng lệnh.

Bây giờ có ba lệnh mới trong menu; một là để định dạng lại mã nguồn bằng SwiftFormat và hai lệnh khác cung cấp các hành động chuyên biệt.

Một trong số họ tạo hoặc cập nhật danh sách người đóng góp dựa trên lịch sử cam kết trong Git và một người khác cập nhật ngày bản quyền trong các tệp nguồn của tôi.

Lệnh ở giữa đó thực hiện chính xác những gì tôi muốn.

Khi tôi gọi lệnh plugin trên gói của mình, Xcode cho phép tôi chọn mục tiêu nào của nó để chuyển đến plugin.

Trong trường hợp này, tôi sẽ gọi nó trên toàn bộ gói.

Và nếu plugin nhận các đối số tùy chỉnh, tôi cũng có thể chuyển chúng ở đây.

Tôi nhấp vào Chạy, và vì plugin sẽ sửa đổi hệ thống tệp, Xcode cảnh báo tôi về điều đó.

Tôi có thể thấy lý do đã nêu của tác giả plugin muốn sửa đổi mã của tôi, nhưng tôi cũng muốn xem qua việc triển khai plugin.

Vì vậy, tôi chọn Hiển thị lệnh và Xcode đưa tôi đến mã.

Những gì plugin này đang làm là an toàn, vì vậy tôi sẽ gọi lại lệnh và lần này, tôi sẽ chọn Chạy.

Tôi sẽ bảo Xcode nhớ lựa chọn của tôi cho plugin này.

Plugin cụ thể này sử dụng lịch sử Git để tạo danh sách tệp hiển thị tên của những người đóng góp, nhưng có rất nhiều sự linh hoạt trong những gì plugin lệnh có thể làm.

Bây giờ chúng ta đã sử dụng một plugin lệnh trong Xcode, chúng ta hãy xem xét kỹ hơn cách các plugin hoạt động dưới mui xe.

Các plugin gói là các tập lệnh Swift được biên dịch và chạy khi cần thiết.

Mỗi plugin chạy như một quy trình riêng biệt.

Các plugin có quyền truy cập vào biểu diễn chắt lọc của gói đầu vào, bao gồm các tệp nguồn của nó.

Một plugin cũng nhận được thông tin về bất kỳ sự phụ thuộc nào của gói.

Nhiều plugin gọi các công cụ dòng lệnh như một phần của công việc thực hiện công việc của họ.

Các plugin cũng có thể tạo các tệp và thư mục, và có thể thực hiện các hành động khác bằng cách sử dụng các thư viện tiêu chuẩn như Foundation.

Một plugin chạy trong hộp cát ngăn chặn truy cập mạng và chỉ cho phép ghi đến một vài nơi trong hệ thống tệp, chẳng hạn như thư mục đầu ra xây dựng.

Nhưng các plugin lệnh có thể yêu cầu quyền sửa đổi các tệp trong thư mục nguồn gói.

Nếu người dùng chấp thuận, hộp cát được cấu hình để cho phép ghi vào các vị trí đó.

Plugin cũng có thể gửi kết quả trở lại Xcode.

Nó có thể phát ra cảnh báo và lỗi, và các plugin công cụ xây dựng có thể xác định các lệnh gọi công cụ để Xcode chạy trong quá trình xây dựng.

Tất cả các plugin gói đều sử dụng API từ mô-đun PackagePlugin do Xcode cung cấp.

API này cho phép plugin truy cập gói đầu vào và nếu thích hợp, trả lại kết quả cho Xcode.

Tệp nguồn chính triển khai plugin cũng xác định điểm vào chính.

Đây phải là một lớp hoặc một cấu trúc phù hợp với giao thức phù hợp với loại plugin.

Chức năng điểm vào cụ thể mà Xcode gọi phụ thuộc vào loại plugin đó.

Bạn có thể tìm hiểu thêm về PackagePlugin API trong video "Tạo plugin Gói Swift".

Trước đó, chúng tôi đã sử dụng một plugin lệnh để thực hiện các thay đổi đối với gói của mình.

Hãy xem xét thêm một số chi tiết cụ thể của các plugin lệnh.

Các plugin lệnh mở rộng quy trình phát triển.

Chúng được áp dụng trực tiếp cho một gói, không phải trong quá trình xây dựng.

Không phải tất cả các plugin lệnh đều sửa đổi hệ thống tệp - có những hành động hữu ích không liên quan đến việc thay đổi bất kỳ tệp nào.

Nhưng nếu một lệnh muốn ghi vào hệ thống tệp, nó phải khai báo rằng trong bản kê khai của gói triển khai plugin.

Điều này khiến Xcode yêu cầu người dùng cho phép trước khi để plugin chạy.

Các plugin thường khá nhỏ và thường phụ thuộc vào các công cụ khác để thực hiện công việc thực tế.

Trước đó, chúng tôi đã thấy rằng một trong những plugin sử dụng SwiftFormat cho tất cả các công việc thực tế.

Sự phụ thuộc vào các gói công cụ có thể là mã nhị phân hoặc mã nguồn - Xcode sẽ xây dựng bất kỳ công cụ cần thiết nào từ nguồn trước khi lệnh được gọi.

Lưu ý rằng plugin có thể được cung cấp bởi một gói khác với công cụ mà nó dựa vào.

Trong việc triển khai các plugin lệnh, loại chính phù hợp với giao thức CommandPlugin và plugin triển khai điểm vào performCommand.

Điểm vào này có ngữ cảnh và bất kỳ đối số tùy chỉnh nào do người dùng cung cấp.

Hãy xem xét một cách khác để gọi các plugin lệnh.

Tôi sẽ sử dụng cùng một dự án như trước đây và vì tôi đã thêm sự phụ thuộc vào gói SourceCodeUtilities trước đó, tôi có thể gọi các plugin tương tự trong Terminal.

Đầu tiên tôi sẽ thay đổi thư mục thành gói CoreLibs, vì đó là gói mà tôi muốn áp dụng plugin lệnh cho.

Swift Package Manager 5.6 có một lệnh con mới cho các plugin.

Tôi sẽ gõ "plugin gói nhanh --Danh sách" để xem những plugin nào có sẵn.

Điều này hiển thị các plugin tương tự như trong menu trong Xcode.

Ở đây trên dòng lệnh, mỗi lệnh cũng hiển thị động từ nên được sử dụng để chạy nó.

Tôi sẽ sử dụng động từ để tái tạo danh sách người đóng góp, như tôi đã làm trong Xcode.

Plugin này muốn quyền ghi vào hệ thống tệp, vì nó sẽ tạo một tệp.

Tôi gõ "có" để cho phép điều này, và plugin có thể chạy và cập nhật danh sách người đóng góp.

Tôi cũng có thể đã sử dụng tùy chọn trình quản lý gói cho phép plugin ghi vào hệ thống tệp mà không cần hỏi.

Điều này đặc biệt hữu ích nếu bạn đang gọi nó từ hệ thống CI hoặc tự động hóa xây dựng khác.

Nhưng hãy chắc chắn rằng bạn biết plugin đang làm gì trước khi sử dụng tùy chọn đó.

Cũng giống như trong Xcode, tôi có thể chuyển các đối số dòng lệnh cho plugin.

Bất kỳ đối số nào sau động từ hành động của plugin sẽ được chuyển đến plugin.

Trong trường hợp này, tôi chuyển một lá cờ dài dòng để xem thêm đầu ra từ plugin khi nó chạy.

Mỗi plugin lệnh xác định những đối số mà nó hỗ trợ.

Cho đến bây giờ, chúng ta chủ yếu nói về các plugin lệnh.

Nhưng có một vài điều nữa để nói về các plugin công cụ xây dựng.

Không giống như plugin lệnh, plugin công cụ xây dựng không thực hiện công việc của nó ngay lập tức.

Thay vào đó, nó tạo và trả về các lệnh gọi công cụ xây dựng để Xcode chạy sau khi gói được xây dựng.

Mỗi lời gọi công cụ đó có một dòng lệnh để chạy, và nó cũng có đầu vào và đầu ra cho Xcode biết khi nào nên chạy nó.

Các plugin công cụ xây dựng có thể xác định các lệnh chạy trong quá trình xây dựng hoặc trước khi xây dựng.

Chúng ta sẽ xem xét sự khác biệt trong một phút nữa.

Các lệnh được trả về bởi các plugin công cụ xây dựng thường được cấu hình để ghi đầu ra của chúng vào thư mục xây dựng, vì vậy chúng tồn tại giữa các bản dựng gia tăng.

Và giống như bản thân các plugin, các lệnh được xác định bởi plugin công cụ xây dựng chạy trong hộp cát ngăn chặn truy cập mạng và bất kỳ thay đổi nào đối với gói.

Trong việc triển khai plugin công cụ xây dựng, loại chính phù hợp với giao thức BuildToolPlugin và plugin triển khai điểm vào createBuildCommands.

Điểm vào này lấy một ngữ cảnh và mục tiêu để tạo ra các lệnh xây dựng cho.

Nó trả về bất kỳ lệnh xây dựng tùy chỉnh nào sẽ chạy khi gói được xây dựng.

Có hai loại lệnh xây dựng cơ bản mà một plugin công cụ xây dựng có thể trả về.

Các lệnh xây dựng thông thường chỉ định đường dẫn đầu vào và đầu ra, và chỉ chạy khi đầu ra bị thiếu hoặc đầu vào đã thay đổi.

Các lệnh xây dựng trước chạy trước khi bắt đầu xây dựng và có thể được sử dụng khi tên của các đầu ra không được biết trước thời hạn.

Các lệnh xây dựng trước chạy trước mỗi bản dựng, vì vậy chúng nên đảm bảo thực hiện càng ít công việc càng tốt khi không có thay đổi.

Các lệnh xây dựng và các lệnh xây dựng trước rất tốt để tạo mã nguồn hoặc tài nguyên.

Vậy làm thế nào để Xcode biết plugin công cụ xây dựng nào để áp dụng cho mục tiêu gói?

Trong SwiftPM 5.6 trở lên, có một tham số plugin mới trong bản kê khai gói liệt kê các plugin công cụ xây dựng mà mục tiêu muốn.

Tham số này chỉ định bất kỳ plugin công cụ xây dựng nào cần thiết cho mục tiêu và cũng giống như với bất kỳ thư viện thời gian chạy nào mà nó phụ thuộc vào, những plugin đó có thể nằm trong cùng một gói hoặc trong một gói khác.

Hãy quay lại Xcode.

Tôi sẽ cấu hình ứng dụng hình học của mình để sử dụng plugin công cụ xây dựng.

Trong trường hợp cụ thể này, tôi có một công cụ dòng lệnh tùy chỉnh tạo mã Swift dựa trên một số tệp dữ liệu trong mục tiêu Thư viện cốt lõi của tôi.

Các chi tiết cụ thể không quan trọng, nhưng những gì tôi muốn kết thúc là các bộ truy cập Swift an toàn kiểu được tạo cho từng phần dữ liệu.

Ngoài các tệp dữ liệu của mình, tôi đã sử dụng một công cụ tùy chỉnh để tạo mã nguồn mà tôi đã kiểm tra vào kho lưu trữ của mình.

Tôi đã chạy thủ công công cụ này để tạo lại mã trình bao bọc Swift và cam kết các thay đổi bất cứ khi nào tệp dữ liệu của tôi thay đổi.

Nhưng với plugin công cụ xây dựng, tôi có thể làm tốt hơn.

Tôi có thể tạo mã trong quá trình xây dựng và tránh phải giữ mã đã tạo trong kho lưu trữ của mình.

Để có quyền truy cập vào plugin, tôi vào bản kê khai gói và thêm sự phụ thuộc vào gói cung cấp plugin trình tạo nguồn mà tôi muốn sử dụng.

Các mục tiêu trong gói của tôi hiện có quyền truy cập vào bất kỳ plugin công cụ xây dựng nào được xác định trong gói đó.

Bây giờ tôi đi đến mục tiêu cần sử dụng plugin và tôi thêm tham số plugin vào định nghĩa của nó.

Điều này cho Xcode biết rằng nó muốn áp dụng một công cụ xây dựng cụ thể từ gói đó cho mục tiêu của tôi.

Bây giờ tôi có thể đi và xóa các tệp nguồn được tạo đó khỏi kho lưu trữ của mình.

Chúng sẽ được tạo hoặc cập nhật khi cần thiết trong quá trình xây dựng.

Ở đó, nó sạch hơn nhiều.

Và bây giờ khi tôi xây dựng và chạy ứng dụng của mình, plugin công cụ xây dựng của tôi yêu cầu Xcode gọi công cụ tạo mã của tôi bất cứ khi nào tệp dữ liệu của tôi thay đổi.

Mã được tạo sẽ được lưu trữ cùng với các tệp xây dựng khác trong thư mục xây dựng của tôi, giữ cho kho lưu trữ của tôi sạch sẽ.

Trong video này, chúng ta đã nói về các plugin gói Swift là gì và chúng hoạt động như thế nào.

Chúng tôi đã thảo luận về một số điểm tương đồng và khác biệt giữa plugin lệnh và plugin công cụ xây dựng.

Cả hai loại plugin đều cho phép bạn thay thế nhiều tập lệnh ngẫu nhiên bằng một loại mở rộng có cấu trúc hơn trong các gói của bạn.

Các plugin công cụ xây dựng cho phép bạn mở rộng hệ thống xây dựng để tạo nguồn và tài nguyên hoặc thực hiện các công việc tùy chỉnh khác như một phần của bản dựng của bạn.

Các plugin lệnh cho phép bạn tự động hóa các tác vụ phát triển phổ biến với các hành động tùy chỉnh.

Chúng có thể được điều chỉnh cho phù hợp với một quy trình làm việc cụ thể hoặc có thể được viết để hữu ích trong nhiều trường hợp khác nhau.

Để tìm hiểu cách tạo plugin gói của riêng bạn, hãy nhớ xem video "Tạo plugin gói Swift".

Cảm ơn vì đã xem và tận hưởng phần còn lại của WWDC 2022.

♪