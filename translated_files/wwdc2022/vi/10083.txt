10083

♪ ♪

Vaibhav Gautam: Xin chào, tôi là Vaibhav Gautam, và tôi là một kỹ sư trong nhóm Software Power.

Các ứng dụng làm phong phú thêm cuộc sống của mọi người, vì chúng cung cấp các chức năng quan trọng khác nhau trong suốt một ngày sử dụng.

Nhưng việc sử dụng này có thể đi kèm với một chi phí: tiêu hao pin.

Do đó, điều quan trọng là bạn phải đặc biệt chú ý để cải thiện thời lượng pin của ứng dụng để người dùng của bạn có thể sử dụng thiết bị và ứng dụng của họ lâu hơn.

Chúng tôi nghiên cứu sâu các thành phần hệ thống khác nhau để hiểu mức tiêu thụ điện năng và trong phiên này, tôi sẽ xem xét bốn hành động chính mà chúng tôi đã xác định mà bạn có thể thực hiện để cải thiện đáng kể thời lượng pin của ứng dụng của mình.

Đây là Chế độ tối trong ứng dụng của bạn, kiểm tra tốc độ khung hình, giới hạn thời gian nền và trì hoãn công việc trong ứng dụng của bạn.

Đầu tiên, tôi sẽ nói về Chế độ tối.

Chế độ tối đã được giới thiệu trong iOS 13 và cho phép ai đó định cấu hình thiết bị của họ trong một bản trình bày tối hơn.

Bạn có thể quen thuộc với các lợi ích cá nhân hóa của Chế độ tối, nhưng nó cũng có thể ảnh hưởng đáng kể đến thời lượng pin.

Điều này là do trên các thiết bị có màn hình OLED, như iPhone 13 và 13 Pro, nội dung tối hơn tiêu thụ ít năng lượng hơn nội dung sáng hơn.

Trên màn hình OLED, mỗi điểm ảnh yêu cầu công suất riêng lẻ và đối với các màu tối hơn, cần ít năng lượng hơn để làm sáng các điểm ảnh.

Trong số tất cả các thành phần trong hệ thống, màn hình là một trong những nguồn tiêu thụ điện năng chính.

Trên thực tế, trong các trường hợp sử dụng điển hình, màn hình có thể là yếu tố hàng đầu dẫn đến việc tiêu hao pin.

Bạn có một cách để ảnh hưởng đến mức tiêu thụ điện năng của màn hình.

Và một cách là áp dụng Chế độ tối.

Tôi sẽ sử dụng ứng dụng Food Truck mà nhóm của tôi đang làm việc làm ví dụ.

Ứng dụng này có màu nền rất nổi bật chiếm phần lớn màn hình.

Khi trình bày ở Chế độ tối, màu nền này trở nên tối hơn nhiều so với phiên bản Chế độ sáng của nó, góp phần rất nhiều vào việc tiết kiệm pin.

Trên thực tế, đối với những trường hợp như thế này, kết quả là chúng tôi mong đợi tiết kiệm tới 70% năng lượng hiển thị.

Đây là một khoản tiết kiệm lớn!

Và khi độ sáng màn hình cao, mức tiết kiệm pin thậm chí còn cao hơn.

Đối với những người dùng thích Chế độ tối, đây là một cơ hội to lớn để tiết kiệm pin cho họ và nó cũng có thể giảm tải nhiệt.

Để áp dụng Chế độ tối, hãy bắt đầu bằng cách xem lại cách ứng dụng của bạn hiện đang xuất hiện khi Chế độ tối được bật.

Tìm ra những thành phần nào trong ứng dụng bạn nên cập nhật để phù hợp hơn với giao diện người dùng hệ thống.

Xcode giúp việc này trở nên dễ dàng bằng cách sử dụng tính năng giao diện khi xây dựng ứng dụng của bạn.

Ứng dụng của bạn có thể có màu được mã hóa cứng vì nó chỉ hỗ trợ Chế độ Ánh sáng.

Sử dụng màu động trong Xcode để hỗ trợ màu nền, hình ảnh và văn bản ở Chế độ Sáng và Tối.

Hệ thống sẽ tự động sử dụng các giá trị màu chính xác và sẽ cập nhật khi chế độ thay đổi.

Ứng dụng của bạn cũng nên hỗ trợ các hình ảnh thay thế cho Chế độ sáng và Chế độ tối.

Để tìm hiểu thêm về việc tùy chỉnh ứng dụng của bạn cho Chế độ tối, hãy xem "Thực hiện Chế độ tối trên iOS" từ WWDC 2019.

Bây giờ bạn đã biết cách áp dụng Chế độ tối trong ứng dụng của mình, bạn cũng nên suy nghĩ về cách áp dụng Chế độ tối cho nội dung web của mình.

Safari không tự động làm tối bất kỳ nội dung web nào, vì vậy hãy đảm bảo rằng bạn cũng áp dụng Chế độ tối cho nội dung web của mình.

Để làm như vậy, hãy triển khai thuộc tính sơ đồ màu trong biểu định kiểu trang web của bạn.

Điều này cho phép văn bản mặc định và màu nền của trang web phù hợp với giao diện hệ thống hiện tại, điều khiển biểu mẫu tiêu chuẩn và thanh cuộn.

Các màu hệ thống được đặt tên khác thay đổi giao diện của chúng, chuyển đổi giữa Chế độ Sáng và Tối.

Bắt đầu sử dụng các biến biểu định kiểu bất cứ nơi nào màu sắc được tham chiếu trong biểu định kiểu của bạn.

Điều này cho phép nội dung web của bạn cập nhật màu sắc khi thiết bị chuyển đổi giữa Sáng và Tối.

Áp dụng logic tương tự cho hình ảnh và các nội dung phương tiện khác trên các trang web của bạn, với các biến thể khác nhau cho các chế độ khác nhau.

Để tìm hiểu thêm về việc triển khai Chế độ tối cho nội dung web, hãy tham khảo "Hỗ trợ Chế độ tối trong nội dung web của bạn" từ WWDC 2019.

Một cách khác để giảm mức sử dụng năng lượng của ứng dụng là kiểm tra tốc độ khung hình của bạn.

Trên các thiết bị có màn hình ProMotion, tốc độ làm mới có thể ảnh hưởng đến mức tiêu thụ điện năng.

Tốc độ làm mới cao hơn sử dụng năng lượng cao hơn.

Tốc độ khung hình của hình ảnh động trong ứng dụng của bạn xác định tốc độ làm mới của màn hình.

Hãy quan tâm đến nội dung chính trong ứng dụng của bạn và tốc độ khung hình mà nó yêu cầu, vì không phải tất cả nội dung trong ứng dụng của bạn đều có thể yêu cầu tốc độ khung hình cao.

Tốc độ làm mới của màn hình được xác định bởi hình ảnh động có tốc độ khung hình cao nhất trong ứng dụng của bạn.

Ứng dụng của bạn có thể có các yếu tố thứ cấp làm mới với tốc độ cao hơn mức cần thiết, khiến toàn bộ ứng dụng tiêu thụ nhiều pin hơn dự kiến.

Ở đây chúng tôi có ứng dụng xe tải thực phẩm một lần nữa.

Cảnh xe tải chính ở trên cùng đang hiển thị ở tốc độ 30 khung hình mỗi giây.

Bên dưới xe tải, có một lớp phủ văn bản "Xe tải thực phẩm", đang cuộn theo chiều ngang.

Văn bản phụ này đang hiển thị ở tốc độ 60 khung hình mỗi giây.

Kết quả là, toàn bộ màn hình hiện đang hiển thị với tốc độ 60 khung hình mỗi giây.

Nếu chúng ta thay đổi hoạt ảnh văn bản thành 30 khung hình / giây, thì toàn bộ màn hình có thể hiển thị ở tốc độ 30 khung hình / giây và chúng ta có thể tiết kiệm tới 20% lượng pin.

Thật tuyệt vời!

Để gỡ lỗi và nhận thêm thông tin về tốc độ khung hình trong ứng dụng của bạn, hãy sử dụng Công cụ.

Sử dụng công cụ CoreAnimation FPS để xem dòng thời gian hiển thị tốc độ khung hình của ứng dụng của bạn theo thời gian.

Bắt đầu bằng cách kiểm tra các kịch bản người dùng chính.

Để xác định xem các khung hình có được hiển thị với tốc độ bạn mong đợi hay không, hãy xác định xem các yếu tố phụ trên màn hình có tốc độ khung hình cao hơn nội dung chính của bạn hay không.

Ứng dụng của bạn có thể đang sử dụng CADisplayLink do CoreAnimation cung cấp trên iOS để thúc đẩy hoạt ảnh tùy chỉnh và vòng lặp kết xuất tùy chỉnh.

CADisplayLink là bộ hẹn giờ được đồng bộ hóa với tốc độ làm mới màn hình.

Nó cung cấp thông tin thời gian cần thiết cho ứng dụng của bạn để bản vẽ tùy chỉnh của bạn có thể nhận thức được các sự kiện làm mới.

Ứng dụng của bạn có thể đưa ra gợi ý cho đối tượng CADisplayLink về tốc độ làm mới màn hình mong muốn.

Đặt phạm vi khung hình ưa thích của CADisplayLink và chỉ định tốc độ khung hình tối thiểu, tối đa và ưa thích của bạn.

Liên kết hiển thị sau đó sẽ chọn tốc độ khung hình khả dụng gần nhất với tốc độ ưa thích của bạn, dựa trên những gì hệ thống có thể xử lý.

Nếu nó không thể cung cấp tỷ lệ đó, nó sẽ cố gắng ở trong phạm vi được chỉ định của bạn.

Để cấu hình liên kết hiển thị của bạn, hãy khởi tạo nó với một mục tiêu và bộ chọn.

Bộ chọn được cung cấp được sử dụng để thực hiện hoạt ảnh tùy chỉnh và tính toán khung video nào sẽ hiển thị tiếp theo.

Khi liên kết hiển thị của bạn được khởi tạo, hãy đặt phạm vi tốc độ khung hình ưa thích.

Trong ví dụ này, tỷ lệ ưu tiên là 30, nhưng phạm vi có thể xử lý bất cứ thứ gì từ 10 đến 60.

Cuối cùng, thêm liên kết hiển thị vào vòng lặp chạy hiện tại.

Hãy ghi nhớ tốc độ làm mới khi nghĩ về mức tiêu thụ pin của ứng dụng của bạn.

Điều này đặc biệt quan trọng đối với các thiết bị có màn hình ProMotion hỗ trợ tốc độ làm mới rất động.

Theo dõi tốc độ khung hình ứng dụng của bạn với Instruments để khám phá các vấn đề trước khi bạn phát hành ứng dụng của mình.

Cuối cùng, cung cấp thông tin cho hệ thống, sử dụng CADisplayLink để giới hạn tốc độ làm mới cho nội dung ứng dụng của bạn.

Để tìm hiểu thêm về tối ưu hóa tốc độ khung hình, hãy tham khảo "Tối ưu hóa cho màn hình tốc độ làm mới thay đổi" từ WWDC 2021.

Bây giờ, hãy nói về cách bạn có thể tắt nguồn ứng dụng của mình khi nó đang chạy trong nền.

Khi ai đó chuyển từ ứng dụng của bạn sang một ứng dụng khác, ứng dụng của bạn có thể dựa vào API thực thi nền để tiếp tục chạy trong nền.

Trong khi chạy ở chế độ nền, ứng dụng của bạn có thể tiếp tục sử dụng các dịch vụ phổ biến như vị trí và âm thanh.

Chạy các dịch vụ này trong thời gian dài sẽ khiến pin cạn kiệt, vì vậy khi ứng dụng của bạn đang sử dụng các dịch vụ này trong nền, bạn cần đặc biệt cẩn thận!

Vì vậy, hãy nói về cách tránh thoát nước dư thừa khi sử dụng các chế độ này Dịch vụ định vị giữ cho thiết bị hoạt động để liên tục truyền vị trí.

Mặc dù ứng dụng không hiển hình đối với người dùng, nhưng nó có thể liên tục phát trực tuyến vị trí trong nền và gây ra sự tiêu hao pin dư thừa.

Điều quan trọng là phải đảm bảo rằng bạn đang ở trên đỉnh thời gian chạy phiên vị trí nền trong ứng dụng của mình.

Khi bạn không còn cần phiên nữa, hãy đảm bảo ứng dụng của bạn gọi stopUpdatingLocation() để dừng phiên.

Trong các giai đoạn phát triển ứng dụng khác nhau, bạn có thể sử dụng các công cụ khác nhau để tìm ra việc sử dụng vị trí nền, điều này có thể không được mong đợi.

Trong khi xây dựng và thử nghiệm ứng dụng, đồng hồ đo Xcode có thể được sử dụng để tìm ra mức sử dụng năng lượng của hệ thống, cũng như việc sử dụng vị trí nền.

Khi kiểm tra ứng dụng của bạn trước khi phát hành, bạn có thể sử dụng MetricKit để thu thập thông tin chẩn đoán trong một ngày sử dụng.

Điểm mới trong iOS 16 là việc sử dụng vị trí trong Trung tâm điều khiển.

Đồng hồ đo Xcode cung cấp thông tin về việc sử dụng hệ thống như CPU, Mạng và Sử dụng Vị trí.

Đồng hồ đo Xcode sẽ hiển thị dòng thời gian sử dụng vị trí và tác động năng lượng của ứng dụng của bạn.

Nhìn vào chế độ xem dòng thời gian này có thể là một cách tuyệt vời để xác minh rằng thời gian chạy vị trí của bạn dừng lại khi bạn mong đợi nó dừng lại.

Một công cụ khác là sử dụng Metric Kit khi kiểm tra ứng dụng của bạn.

Sử dụng thuộc tính cumulativeBackgroundLocationTime để tìm hiểu xem ứng dụng của bạn đã tích cực sử dụng các dịch vụ định vị trong nền trong bao lâu.

Mới trong iOS 16, người dùng có thể theo dõi các ứng dụng hiện đang sử dụng dịch vụ định vị bằng cách điều hướng đến Trung tâm điều khiển.

Họ có thể nhấn vào văn bản ở trên cùng để xem chi tiết các ứng dụng sử dụng vị trí.

Sử dụng cái này để có cái nhìn sâu sắc về thời gian chạy vị trí của bạn.

Nếu bạn thấy ứng dụng của mình ở đây và bạn không mong đợi, đó là một dấu hiệu cho thấy ứng dụng của bạn có phiên phát trực tuyến vị trí đang hoạt động.

Chúng ta có thể áp dụng các nguyên tắc tương tự cho các phiên âm thanh.

Giả sử chúng ta có một ứng dụng âm nhạc đang sử dụng trình phát âm thanh để phát lại một số tệp và người dùng dừng phát lại.

Ứng dụng không chỉ nên tạm dừng hoặc dừng âm thanh mà còn nên tạm dừng hoặc dừng Công cụ âm thanh để ngăn nó chạy không hoạt động.

Chúng tôi khuyên bạn nên sử dụng chế độ tự động tắt có thể được bật bằng cách đặt thuộc tính autoShutdownEnabled của lớp AVAudioEngine.

Trong chế độ này, công cụ âm thanh liên tục theo dõi và phát hiện xem nó có nhàn rỗi trong một khoảng thời gian nhất định hay không.

Khi không hoạt động, động cơ sẽ tắt phần cứng âm thanh.

Và sau đó, nếu bất kỳ nguồn nào hoạt động trở lại, nó sẽ khởi động phần cứng âm thanh một cách linh hoạt.

Và tất cả những điều này xảy ra dưới mui xe.

Trên chế độ tự động tắt watchOS là hành vi bắt buộc.

Đảm bảo dừng Công cụ Âm thanh khi không sử dụng để tiết kiệm năng lượng.

Chìa khóa để hạn chế thời gian chạy nền là nhớ thông báo cho hệ thống khi bạn hoàn tất.

Hành động cuối cùng bạn có thể thực hiện để cải thiện tuổi thọ pin là trì hoãn công việc.

Trong suốt cả ngày, ứng dụng của bạn có thể xử lý nhiều tác vụ và dữ liệu khác nhau.

Một số công việc này cần xảy ra ngay lập tức để phục vụ các hành động của người dùng, như hiển thị nội dung trên màn hình hoặc phát âm thanh hoặc video mà người dùng nhấn vào.

Các công việc khác như nhiệm vụ học máy, tải lên phân tích hoặc sao lưu không nhạy cảm về thời gian.

Nếu chúng ta trì hoãn công việc không nhạy cảm thời gian này sang thời điểm tốt hơn - khi thiết bị đang sạc - chúng ta có thể tiết kiệm pin và tránh tranh chấp với công việc tương tác và bắt đầu của người dùng.

Hãy nói về ba API bạn có thể sử dụng để thực hiện điều này.

BGProcessingTask là một lựa chọn tốt để trì hoãn các nhiệm vụ chạy trong thời gian dài.

URLSession tùy ý là sự lựa chọn hoàn hảo để lên lịch kết nối mạng có thể trì hoãn.

Và tận dụng mức độ ưu tiên đẩy phù hợp có thể giúp các máy chủ cung cấp các lần đẩy vào đúng thời điểm.

Hãy đi vào chi tiết cho từng cái.

Đầu tiên là BGProcessingTask.

BGProcessingTask cho phép bạn trì hoãn các tác vụ xử lý lâu dài đến thời điểm tốt hơn, chẳng hạn như khi thiết bị đang sạc.

Thật tuyệt vời cho các tác vụ như dọn dẹp cơ sở dữ liệu, tạo bản sao lưu và chạy đào tạo học máy.

Để sử dụng nó, bạn chỉ cần tạo một yêu cầu bằng cách sử dụng BGProcessingTaskRequest API và cung cấp mã định danh ứng dụng.

Sau đó cung cấp thêm thông tin, chẳng hạn như nếu nhiệm vụ của bạn cần nguồn điện hoặc mạng bên ngoài.

Cung cấp thêm thông tin sẽ giúp hệ thống lên lịch công việc ở khung thời gian tốt hơn.

Hệ thống sau đó sẽ khởi chạy ứng dụng của bạn trong nền vào thời điểm thích hợp và cấp vài phút thời gian chạy để hoàn thành công việc có thể trì hoãn.

Tiếp theo là URLSession tùy ý.

Ứng dụng của bạn có thể đã sử dụng Background URLSessions cho mạng chung.

URLSessions nền thậm chí còn tốt hơn khi bạn sử dụng cờ tùy ý.

URLSessions với cờ tùy ý là các giao dịch mạng được tải xuống hệ thống để thực hiện kết nối mạng vào thời điểm tối ưu hơn, chẳng hạn như khi thiết bị được cắm và kết nối với Wi-Fi.

Cờ tùy ý rất phù hợp cho mạng dài hạn do người dùng khởi xướng, chẳng hạn như thu thập đo từ xa hoặc tải xuống tập tiếp theo của chương trình truyền hình.

Và bởi vì mạng đã được giảm tải, điều đó có nghĩa là ứng dụng của bạn không cần phải chạy trong khi giao dịch mạng hoàn tất.

Để sử dụng các phiên URL tùy ý, bạn chỉ cần thiết lập một phiên URL nền và đặt isDiscretionary thành true.

Bạn có thể cung cấp thêm thông tin để giúp hệ thống lên lịch tải xuống vào đúng thời điểm.

Vượt qua các khoảng thời gian chờ để hệ thống không cố gắng tải xuống mãi mãi, khiến pin cạn kiệt.

Nếu bạn không muốn tải lên hoặc tải xuống dữ liệu cho đến một thời điểm nào đó sau đó trong tương lai, hãy vượt qua ngày bắt đầu sớm nhất.

Cuối cùng, vượt qua kích thước khối lượng công việc dự kiến để hệ thống có thể cân bằng tải một cách thông minh giữa các tác vụ tải xuống khác nhau của bạn.

Tương tự như cách bạn có thể kiểm soát tính tức thời của một số hoạt động nhất định với BGProcessingTask và các phiên URL tùy ý, bạn có thể ảnh hưởng đến tính tức thời của phân phối đẩy bằng cách sử dụng các ưu tiên đẩy khác nhau.

Mức độ ưu tiên đẩy xác định mức độ khẩn cấp của lực đẩy cần được chuyển đến thiết bị.

Để đẩy ưu tiên cao, máy chủ sẽ gửi đẩy ngay lập tức đến thiết bị, có khả năng đánh thức thiết bị và khiến pin cạn kiệt.

Đối với các lần đẩy ưu tiên thấp, máy chủ sẽ trì hoãn việc gửi lần đẩy cho đến một thời điểm thích hợp, chẳng hạn như khi thiết bị thức hoặc một lần đẩy ưu tiên cao đi qua.

Đẩy ưu tiên cao rất tốt cho các tin nhắn khẩn cấp như cảnh báo thời tiết khắc nghiệt.

Đẩy ưu tiên thấp rất tốt cho các thông báo thụ động hơn mà không khẩn cấp và có thể bị trì hoãn.

Tận dụng mức độ ưu tiên thấp để trì hoãn việc gửi các tin nhắn có thể trì hoãn sẽ tiết kiệm pin vì thiết bị sẽ không phải thức dậy thường xuyên sau khi ngủ.

Để định cấu hình đẩy ưu tiên thấp, chỉ cần đặt apns-priority thành 5 trong tải trọng đẩy.

Máy chủ sẽ lo phần còn lại và người dùng của bạn sẽ đánh giá cao việc tiết kiệm pin.

Vì vậy, hãy kết thúc nó với một số suy nghĩ cuối cùng và các bước tiếp theo.

Cung cấp tùy chọn Chế độ tối trong ứng dụng của bạn.

Nếu người dùng chọn Chế độ tối, việc tôn trọng ý định của họ có thể tiết kiệm pin.

Xem lại hình ảnh động của bạn và tìm kiếm cơ hội để giảm tốc độ khung hình xuống mức cần thiết.

Một hình ảnh động nhỏ có thể có tác động lớn.

Theo dõi chặt chẽ thời gian chạy nền của bạn bằng cách cho hệ thống biết khi nào bạn hoàn thành.

Cuối cùng, hãy cân nhắc trì hoãn công việc nền lâu dài đến thời điểm tốt hơn, chẳng hạn như khi thiết bị được kết nối với bộ sạc.

Nếu bạn làm tất cả những điều này, thì bạn sẽ thực sự tắt ứng dụng của mình.

Cảm ơn bạn rất nhiều.