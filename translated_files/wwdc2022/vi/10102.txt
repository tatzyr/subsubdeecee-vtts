10102

♪ ♪

Xin chào và chào mừng.

Tôi là Galo Avila, quản lý kỹ thuật trong Phần mềm GPU.

Trong phiên này, Eylon và tôi rất vui mừng được chia sẻ cách bạn có thể cải thiện thế hệ nhị phân GPU của ứng dụng với Metal 3.

Đầu tiên, tôi sẽ mô tả cách biên dịch ngoại tuyến có thể giúp bạn giảm tình trạng nói lắp ứng dụng, lần khởi chạy đầu tiên và thời gian tải cấp độ mới.

Sau đó, Eylon sẽ giải thích cách bạn có thể sử dụng tùy chọn tối ưu hóa cho trình biên dịch kích thước, để điều chỉnh các phép biến đổi mở rộng mã và cải thiện thời gian biên dịch của bạn.

Biên dịch ngoại tuyến cho phép bạn chuyển thế hệ nhị phân GPU sang thời gian xây dựng dự án.

Để hiểu đầy đủ về những lợi ích mà việc áp dụng có thể mang lại cho ứng dụng Metal của bạn, tôi sẽ bắt đầu bằng cách xem xét các cách mà bạn đã có thể tạo ra một tệp nhị phân GPU.

Trong ứng dụng Metal của bạn, việc tạo nhị phân GPU xảy ra cả ở thời điểm xây dựng và thời gian chạy.

Ví dụ, giả sử bạn khởi tạo một thư viện kim loại từ nguồn.

Điều này tạo ra tại thời gian chạy ứng dụng Đại diện Trung gian của Apple, còn được gọi là AIR.

Đây có thể là một hoạt động chuyên sâu về CPU, bạn có thể chuyển sang thời gian xây dựng ứng dụng bằng cách biên dịch trước nguồn của mình vào thư viện Metal và thay vào đó khởi tạo từ một tệp.

Khi thư viện Metal của bạn nằm trong bộ nhớ, việc tạo Bộ mô tả trạng thái đường ống chứa trạng thái và các chức năng là một thao tác nhẹ.

Cho đến khi bạn tạo đối tượng trạng thái đường ống của mình, đây có thể là một hoạt động chuyên sâu khác của CPU, nơi diễn ra việc tạo nhị phân GPU đúng lúc.

Vì thế hệ nhị phân GPU trong thời gian chạy có thể là một hoạt động chuyên sâu về CPU, Metal giúp bạn tăng tốc độ tạo đối tượng trạng thái đường ống.

Khi bạn khởi tạo một PSO, Metal sẽ lưu trữ các tệp nhị phân GPU của bạn trong bộ nhớ cache hệ thống tệp của nó.

Và mỗi khi một PSO mới được tạo ra, bất kỳ chức năng mới được tạo nào cũng được thêm vào.

Vì vậy, bất kỳ tệp nhị phân nào được tạo trước đó được tham chiếu sẽ được tải từ bộ nhớ cache.

Metal cũng cho phép bạn kiểm soát rõ ràng khi nào và ở đâu các tệp nhị phân GPU được lưu trong bộ nhớ cache bằng Kho lưu trữ nhị phân.

Chỉ cần sử dụng bộ mô tả PSO để lưu trữ tệp nhị phân GPU trong kho lưu trữ, bao nhiêu lần bạn cần.

Sau đó, việc tạo PSO của bạn trở thành một hoạt động nhẹ.

Kho lưu trữ nhị phân cho phép bộ nhớ đệm linh hoạt hơn, nhưng chúng vẫn phải được tạo trong thời gian chạy.

Trong nhiều trường hợp, điều bạn thực sự muốn là tạo ra những kho lưu trữ đó tại thời điểm xây dựng, và bây giờ cuối cùng bạn cũng có thể.

Với thế hệ nhị phân ngoại tuyến, bạn chỉ định một tạo tác mới tại thời điểm xây dựng dự án được gọi là tập lệnh đường ống kim loại, cùng với nguồn Metal hoặc thư viện Metal.

Tập lệnh đường ống là chuỗi công cụ biên dịch của bạn tương đương với một tập hợp các bộ mô tả đường ống trong API.

Đầu ra của quá trình biên dịch của bạn là một kho lưu trữ nhị phân.

Không có thêm việc tạo mã GPU nào diễn ra trong thời gian chạy ứng dụng.

Chỉ tải kho lưu trữ nhị phân của bạn được xây dựng ngoại tuyến để tăng tốc độ tạo PSO của bạn.

Biên dịch ngoại tuyến mang lại lợi ích cho ứng dụng của bạn bằng cách giảm chi phí CPU thời gian chạy, đó là cốt lõi của những gì làm cho Metal trở thành một API cấp thấp.

Hơn nữa, việc áp dụng có thể cải thiện trải nghiệm ứng dụng của bạn theo hai cách đáng chú ý.

Lần ra mắt đầu tiên và thời gian tải cấp độ mới có thể trở nên nhanh hơn đáng kể, có khả năng dẫn đến sự tương tác và tương tác lớn hơn.

Stutters hoặc giảm tốc độ khung hình, do quá trình biên dịch thời gian chạy cuối cùng có thể được gỡ bỏ, mà không có chi phí bộ nhớ hoặc CPU của các khung trước khi làm nóng.

Tôi sẽ khám phá những lợi ích này chi tiết hơn tiếp theo.

Ở đây bạn có thế hệ nhị phân thời gian chạy ứng dụng truyền thống của mình.

Trong ví dụ này, ứng dụng của bạn dành khoảng 2/3 thời gian để biên dịch các tệp nhị phân GPU phía sau màn hình tải, trước khi bạn có thể bắt đầu tương tác với nó.

Nhưng với việc biên dịch ngoại tuyến, thế hệ đổ bóng thời gian chạy của bạn chuyển sang thời gian xây dựng ứng dụng, việc tạo PSO diễn ra trong một phần nhỏ thời gian và bạn có thể tương tác với ứng dụng của mình sớm hơn thay vì chạy không tải ở màn hình tải.

Biên dịch ngoại tuyến cũng giúp giảm nói lắp.

Với việc tạo nhị phân thời gian chạy truyền thống, bạn có thể có quá nhiều trạng thái đường ống để tạo tại thời điểm tải, vì vậy thay vào đó bạn có thể đang tạo một số trạng thái đúng lúc.

Và khi điều đó xảy ra, bạn có thể gặp phải tình trạng giảm khung hình do việc biên dịch tạm thời làm gián đoạn mã hóa lệnh của bạn.

Biên dịch ngoại tuyến loại bỏ những bong bóng phiền phức đó, bởi vì bạn có thể biên dịch nhiều đổ bóng hơn tại thời điểm xây dựng ứng dụng.

Tiếp theo, tôi sẽ chia sẻ quy trình làm việc mới của nhà phát triển để giúp bạn khai thác những lợi ích của việc biên dịch ngoại tuyến.

Trong quy trình làm việc sau đây, bạn sẽ học cách sử dụng các tính năng chuỗi công cụ mới để xây dựng các tệp nhị phân GPU ngoại tuyến.

Tôi sẽ chỉ cho bạn cách tạo tạo tạo tác nhập tập lệnh đường ống mới của bạn.

Sau đó, cách gọi chuỗi công cụ để tạo tệp nhị phân GPU.

Tạo tác tập lệnh đường ống là mô tả được định dạng JSON của một hoặc nhiều bộ mô tả trạng thái đường ống API và có thể được tạo theo nhiều cách.

Ví dụ: tác giả chúng trong trình chỉnh sửa JSON yêu thích của bạn hoặc Thu thập chúng từ các kho lưu trữ nhị phân được tuần tự hóa trong quá trình phát triển và thử nghiệm.

Ở đây bạn có một đoạn mã Metal tạo ra một bộ mô tả đường ống kết xuất với trạng thái và chức năng và biểu diễn JSON tương đương của nó.

Đầu tiên, tệp thư viện kim loại API của bạn được chỉ định là thuộc tính đường dẫn thư viện.

Sau đó, tên hàm mô tả kết xuất API của bạn dưới dạng thuộc tính đường ống kết xuất.

Cuối cùng, trạng thái đường ống khác, như định dạng raster_sample_count hoặc pixel, cũng được ghi lại dưới dạng thuộc tính tập lệnh.

Tìm kiếm thêm chi tiết lược đồ JSON trong tài liệu dành cho nhà phát triển của Metal.

Bạn cũng có thể muốn bắt đầu tạo tập lệnh JSON và sử dụng thời gian chạy Metal có thể hữu ích.

Chỉ cần tạo kho lưu trữ nhị phân của bạn trong thời gian chạy và tuần tự hóa chúng trong quá trình phát triển và thử nghiệm của bạn.

Bây giờ tôi sẽ chỉ cho bạn cách bạn có thể hoàn thành điều này với Metal API.

Bạn bắt đầu quá trình thu thập thời gian chạy bằng cách tạo bộ mô tả đường ống của mình với trạng thái và chức năng, thêm nó vào kho lưu trữ, tạo ra tệp nhị phân GPU và tuần tự hóa nó vào hệ thống tệp để nhập và tải từ gói ứng dụng của bạn.

Thời gian chạy Metal 3 lưu trữ bộ mô tả đường ống của bạn cùng với tệp nhị phân GPU.

Bây giờ tôi sẽ chỉ cho bạn cách trích xuất chúng.

Nguồn kim loại cho phép bạn trích xuất tập lệnh đường ống JSON của mình từ một kho lưu trữ hiện có.

Điều này rất hữu ích để di chuyển thế hệ nhị phân của bạn từ thời gian chạy sang thời gian xây dựng ứng dụng.

Chỉ cần gọi nguồn kim loại với các bộ đệm phẳng và các tùy chọn thư mục đầu ra.

Kết quả là một tệp tập lệnh đường ống, bạn có thể chỉnh sửa để tạo các tệp nhị phân bổ sung.

Bây giờ, tôi sẽ chỉ cho bạn cách gọi chuỗi công cụ.

Tạo một tệp nhị phân GPU từ giai đoạn xây dựng dự án Xcode thật dễ dàng.

Chỉ cần gọi kim loại như bạn làm từ thiết bị đầu cuối với nguồn, tập lệnh đường ống và tệp đầu ra của bạn.

Thư viện kim loại đầu ra của bạn hiện chứa GPU nhị phân và có thể được triển khai trên bất kỳ thiết bị hỗ trợ chuỗi công cụ nào.

Và nếu thay vì nguồn, bạn có một thư viện Metal, bạn cũng có thể chuyển nó đến chuỗi công cụ.

Tạo một tệp nhị phân từ một thư viện Metal đã có từ trước cũng dễ dàng như vậy với công cụ dịch Metal.

Chỉ cần gọi metal-tt như bạn làm trong một thiết bị đầu cuối với nguồn, tập lệnh đường ống và tệp đầu ra của bạn.

Thư viện Metal kết quả của bạn hiện chứa GPU nhị phân cho tất cả các thiết bị được hỗ trợ chuỗi công cụ.

Bây giờ bạn đã biết cách tạo các tệp nhị phân ngoại tuyến, tôi sẽ xem lại cách tải chúng.

Chỉ cần cung cấp URL nhị phân khi tạo bộ mô tả lưu trữ và sử dụng nó để khởi tạo kho lưu trữ.

Thế là xong!

Để biết thêm thông tin về API lưu trữ nhị phân của Metal, vui lòng tham khảo các cuộc nói chuyện của những năm trước của chúng tôi.

Cuối cùng, một lưu ý về cách Metal xử lý khả năng tương thích nhị phân GPU cho các hiện vật được tạo ngoại tuyến.

Để đảm bảo các tệp nhị phân được tạo ngoại tuyến của bạn tương thích về phía trước với các phiên bản và sản phẩm hệ điều hành trong tương lai.

Metal duyên dáng nâng cấp kho lưu trữ nhị phân của bạn trong quá trình cập nhật hệ điều hành hoặc tại thời điểm cài đặt ứng dụng.

Nó làm như vậy không đồng bộ, và trong nền.

Tôi nóng lòng chờ đợi bạn khai thác những lợi ích của việc biên dịch ngoại tuyến để loại bỏ tình trạng nói lắp thời gian chạy và giảm thời gian khởi chạy đầu tiên và thời gian tải cấp độ mới.

Những cải tiến như vậy có thể hữu hình đối với những người khác và nâng cao trải nghiệm ứng dụng tổng thể của họ.

Bây giờ, đến Eylon.

Eylon: Cảm ơn, Galo.

Tiếp theo, tôi sẽ giới thiệu tùy chọn biên dịch mới, tối ưu hóa cho kích thước.

Trình biên dịch Metal tối ưu hóa mã mạnh mẽ cho hiệu suất thời gian chạy.

Một số tối ưu hóa mở rộng kích thước chương trình GPU, điều này có thể gây ra chi phí bất ngờ.

Ví dụ, hàm nội tuyến là một tối ưu hóa để tránh chi phí của một cuộc gọi hàm.

Nó hoạt động bằng cách nội tuyến nội dung của hàm được gọi vào trang web cuộc gọi.

Hạt nhân ví dụ này trông không giống như nhiều mã, nhưng sau khi nội tuyến, nó sẽ chứa một bản sao của các hàm 'f' và 'g', và cũng có khả năng của các hàm được gọi từ 'f' và 'g', chẳng hạn như trình trợ giúp và các hàm thư viện không nguyên thủy.

Một tối ưu hóa khác là mở vòng lặp, nội tuyến các bản sao bổ sung của phần thân vòng lặp, để phơi bày tính song song giữa các lần lặp và để tránh chi phí phân nhánh.

Trình biên dịch có thể hủy cuộn ít nhất hai lần lặp của vòng lặp hoặc nhiều như tất cả các lần lặp của một vòng lặp có giới hạn cố định.

Khi những tối ưu hóa như thế này tạo ra một chương trình rất lớn, trình biên dịch cũng phải dành nhiều thời gian hơn để biên dịch nó và trong một số tình huống, bạn có thể muốn tránh những chi phí đó.

Xcode 14 giới thiệu một chế độ tối ưu hóa kim loại mới: tối ưu hóa kích thước.

Chế độ này giới hạn các phép biến đổi mở rộng kích thước, chẳng hạn như nội tuyến và mở vòng lặp, khi trình biên dịch áp dụng tối ưu hóa hiệu suất.

Lợi ích dự kiến là giữ cho GPU nhị phân nhỏ hơn và thời gian biên dịch ngắn hơn, trong trường hợp tối ưu hóa mặc định được chứng minh là quá đắt.

Khi tối ưu hóa kích thước, kết quả có thể có hiệu suất thời gian chạy thấp hơn.

Điều đó có thực sự xảy ra hay không phụ thuộc vào chương trình, vì vậy bạn sẽ cần thử cả hai chế độ tối ưu hóa và so sánh.

Tối ưu hóa kích thước có thể không cải thiện kích thước và thời gian biên dịch cho tất cả các bộ đổ bóng.

Nó rất có thể mang lại lợi ích cho các chương trình lớn với các đường dẫn và vòng lặp cuộc gọi sâu, trong đó nội tuyến và mở cuộn là phổ biến.

Tùy chọn này đáng để thử bất cứ khi nào bạn gặp phải thời gian biên dịch dài bất ngờ từ tối ưu hóa mặc định.

Tùy chọn có sẵn cho dù biên dịch tại thời điểm xây dựng dự án hay trong thời gian chạy ứng dụng.

Đây là một trường hợp mà tối ưu hóa kích thước có thể tạo ra sự khác biệt.

Cycles là một dự án mã nguồn mở triển khai trình kết xuất sản xuất cho môi trường thiết kế Blender 3D và gần đây đã được cập nhật để hỗ trợ Metal.

Apple gần đây đã tham gia Quỹ Phát triển Blender và một trong những điều chúng tôi học được là các thuật toán truy tìm đường dẫn của Blender sử dụng các bộ đổ bóng tính toán lớn, với nhiều chức năng và vòng lặp trợ giúp và thời gian biên dịch của nó có thể tăng lên đến vài phút.

Hóa ra đó chính xác là loại đổ bóng có thể hưởng lợi từ tùy chọn tối ưu hóa kích thước mới của Metal 3.

Khi kết xuất những cảnh này trên GPU Apple Silicon, cho phép tối ưu hóa kích thước đã cải thiện Thời gian thiết lập của Blender, bao gồm biên dịch các đường ống đổ bóng, lên đến 1,4 lần.

Và nó cung cấp tốc độ đó với rất ít hoặc không có sự xuống cấp trong Thời gian kết xuất.

Một số kết xuất chậm lại đến 4%, và một số không chậm chút nào.

Vì vậy, hiệu suất thời gian chạy thấp hơn là có thể.

Nhưng trong một số trường hợp, tối ưu hóa kích thước cũng có thể cải thiện hiệu suất thời gian chạy.

Đây là một ví dụ.

Đây là những tốc độ Thời gian kết xuất cho cùng một cảnh từ việc cho phép tối ưu hóa kích thước trên GPU Intel.

Lợi ích không chỉ là biên dịch nhanh hơn, mà còn là một số kết xuất nhanh hơn, lên đến 1.6x.

Làm thế nào?

Bởi vì một chương trình GPU nhỏ hơn có thể tránh được một số hình phạt thời gian chạy đi kèm với kích thước lớn: nó có thể ít bị bỏ lỡ bộ nhớ cache lệnh hơn hoặc cần ít thanh ghi hơn, điều này có nghĩa là ít sự cố tràn vào bộ nhớ hơn hoặc thậm chí nhiều luồng song song hơn.

Hãy nhớ rằng, những kết quả này không phải là điển hình của tất cả các bộ đổ bóng và cảnh, và có thể giảm hiệu suất.

Đối với dự án của bạn, bạn sẽ cần đánh giá tác động thực tế đến cả thời gian biên dịch và hiệu suất thời gian chạy.

Bạn có thể kích hoạt tối ưu hóa kích thước khi biên dịch từ nguồn Kim loại, trong ba môi trường khác nhau.

Trong giao diện người dùng Xcode 14, chỉ định tối ưu hóa kích thước làm cài đặt xây dựng.

Trong "Trình biên dịch kim loại - Tùy chọn xây dựng" tìm cài đặt "Cấp độ tối ưu hóa".

Cấp độ "Mặc định" tối ưu hóa cho hiệu suất, như Metal đã làm trong quá khứ.

Cấp độ "Kích thước" cho phép tối ưu hóa kích thước.

Khi biên dịch nguồn Metal theo dòng lệnh, chỉ định tối ưu hóa cho kích thước bằng cách sử dụng tùy chọn '-Os'.

Ví dụ đầu tiên chỉ định tùy chọn cho một lệnh biên dịch và liên kết duy nhất.

Ví dụ thứ hai có hai lệnh biên dịch và chỉ định tùy chọn chỉ một trong số chúng để kích hoạt nó chỉ cho một số trình đổ bóng.

Tùy chọn không cần phải được chuyển đến lệnh liên kết hoặc bất kỳ lệnh tiếp theo nào.

Và bạn có thể sử dụng tối ưu hóa cho kích thước có hoặc không có tạo GPU nhị phân bằng cách sử dụng các lệnh được trình bày trước đó trong bài nói chuyện này.

Cuối cùng, khi biên dịch nguồn Metal trong thời gian chạy ứng dụng với API Khung kim loại như 'newLibraryWithSource', hãy chỉ định tối ưu hóa kích thước trong đối tượng 'MTLCompileOptions' bằng cách sử dụng thuộc tính 'optimizationLevel'.

Mức tối ưu hóa có thể là 'mặc định' hoặc 'kích thước'.

Tôi hy vọng dự án của bạn sẽ được hưởng lợi từ chế độ tối ưu hóa mới này trong trình biên dịch Metal.

Galo: Để kết thúc, tôi đã trình bày biên dịch ngoại tuyến, một quy trình làm việc mới để tạo các tệp nhị phân GPU hoàn toàn tại thời điểm xây dựng ứng dụng, để giảm tình trạng nói lắp trong ứng dụng, lần khởi chạy đầu tiên và thời gian tải cấp độ mới.

Eylon: Sau đó, tôi trình bày tối ưu hóa cho kích thước, một chế độ tối ưu hóa Kim loại mới khi biên dịch từ nguồn, để giảm kích thước chương trình và thời gian biên dịch.

Galo: Chúng tôi hy vọng những cải tiến này sẽ giúp ứng dụng hoặc trò chơi của bạn mang lại trải nghiệm người dùng được cải thiện.

Eylon: Với thời gian thiết lập và tải ngắn hơn, ít nói lắp hơn và quy trình làm việc mới, nhờ chi phí biên dịch thấp hơn trong thời gian chạy.

Cảm ơn bạn đã xem. ♪ ♪