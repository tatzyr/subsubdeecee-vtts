10132

♪まろやかなインストゥルメンタルヒップホップ音楽♪

♪

こんにちは、私の名前はミンディで、写真チームのエンジニアです。

今日は、あなたのアプリで写真の変更履歴にアクセスする方法について説明します。

PhotoKitは、フォトライブラリに保存されている写真、ビデオ、アルバムにアクセスして更新するための豊富なAPIセットを提供します。

PhotoKitは、写真、カスタムカメラ、または人々がユニークな方法でフォトライブラリを閲覧する方法を提供するアプリを管理または編集するために、深いレベルの写真へのアクセスと統合を必要とするアプリのために設計されています。

これらのタイプのアプリケーションは、フォトエクスペリエンスを密接に反映するために、フォトライブラリが時間の経過とともにどのように変化するかを監視したい場合があります。

人々が友人とハイキング旅行の写真を共有したり編集したりできるソーシャルハイキングアプリを作成したとしましょう。

誰かがアプリを起動すると、アプリは最新のハイキングワークアウトの開始と終了のタイムスタンプから写真を収集し、山での経験のコラージュを生成します。

コラージュは、フォトライブラリから選択した写真と同期します。

たとえば、誰かが友人からハイキングの写真を受け取った場合、アプリはこれらのアップデートを使用して新しいコラージュを生成します。

これまで、アプリが新しく挿入されたアセットと以前のハイキングコラージュへの変更を発見するために、アプリは一連のフェッチを実行する必要がありました。

どのアセットが挿入されたかを判断するために、アプリは最後のアプリの起動日より後に作成された日付でアセットを取得できます。

資産の更新と削除の決定は難しいです。

アプリは、すべてのコラージュですべての資産を再フェッチし、変更日を確認して資産の更新を決定する必要がありますが、資産の変更日は内部の写真処理活動によって設定できるため、これは誤検出をもたらす可能性があります。

フォトライブラリの削除は、すべての追跡されたアセットをフェッチして、フェッチで返されなかったアセットをデフする必要があるため、追跡がより困難です。

合計で、これは、アプリが起動されるたびに3つの別々のチェックを行う必要があることを意味し、アプリが大量の資産を表示している場合は特にコストがかかる可能性があります。

不確実な結果のために異なるフェッチとチェックを実行する代わりに、1つの統一されたAPI呼び出しで何が変わったのかを正確に知る方法があったらどうでしょうか?

さて、私たちはちょうどそれをやったと言うことに興奮しています!

新しい変更履歴APIを使用すると、フォトライブラリのオフライン更新を簡単に追跡できます。

変更履歴は、フォトライブラリへの挿入、更新、削除などの変更のタイムラインで構成されています。

このタイムラインの例では、過去3日間の変更履歴にさまざまなアセット、アルバム、フォルダの変更があります。

このタイムラインを使用して、過去2日間、またはアプリを最後に起動した時にどの変更が発生したかをどのように判断できますか?

特定の時点でのフォトライブラリの状態を表す永続的な変更トークンを使用できるようになりました。

このトークンは、アプリの起動中に保持することができ、サードパーティのアプリの変更を含む、そのトークン以降に発生したフォトライブラリへの変更を取得するために使用できます。

アプリが制限付きライブラリモードの場合、ユーザーが選択したPhotoKitオブジェクトの変更のみが返されることに注意してください。

この変更トークンはデバイスにローカルであり、いつでも永続的な変更またはフォトライブラリインスタンスからアクセスするのが安価です。

この新しいAPIは、macOS、iOS、iPadOS、tvOSなど、PhotoKitをサポートするすべてのプラットフォームで利用できます。

アプリが実行され、フォトライブラリで作業している間、アプリ内に永続的な変更トークンを保存できます。

後で、トークンを使用して、その後発生したフォトライブラリの変更を取得できます。

永続的な変更ごとに、アセット、アセットコレクション、コレクションリストの3種類の写真オブジェクトの変更の詳細を取得できます。

では、これはコードでどのように見えますか?

まず、最後に保存された変更トークンを使用して、永続的な変更を取得します。

次に、永続的な変更を列挙し、各永続的な変更オブジェクトの変更の詳細（この場合は「asset」タイプの）を取得します。

これらの変更の詳細は、変更トークン以降、どのローカル識別子が更新され、削除され、フォトライブラリに挿入されたかに関する情報を提供します。

これらの変更を処理した後、将来の使用のために最後の変更トークンを保存できます。

新しい永続的な履歴APIと既存の変更オブザーバーAPIを比較して対比しましょう。

PHChangesは、アクティブなインメモリフェッチ結果を処理し、アプリの実行中にフォトライブラリへのライブ変更を記録するために使用されます。

一方、永続的な履歴は、フォトライブラリへの長期にわたる変更を記録し、アプリがアクティブでない場合からの変更を報告するために使用できます。

アプリの要件に応じて、これらのAPIの両方またはどちらかを使用できます。

ハイキングアプリの例に戻ると、ハイキングコラージュを作成および更新するために、永続的な履歴APIを使用してアセットの変更を追跡したいと思います。

まず、最後に保存された変更トークンを使用して、永続的な変更を取得します。

次に、永続的な変更を反復し、関連する資産変更の詳細をつかみ、挿入、更新、削除された識別子を処理します。

アプリは変更の取得から返されるすべての情報を必要としないため、変更履歴からアプリに影響を与えるライブラリの変更を特定する必要があります。

アプリは、新しいハイキングワークアウトのためにどのアセットがフォトライブラリに追加され、以前のハイキングコラージュで参照されたアセットが更新および削除されたかを知ることが重要です。

私はすでに、永続的な変更を通じて列挙することから、挿入、更新、削除されたアセットのローカル識別子の3つのセットを特定しました。

これを反映するためにアプリを更新するにはどうすればよいですか?

insertedIdentifiersセットを使用して、挿入されたアセットを取得し、各ハイキングの開始日と終了日に対して作成日をチェックすることで、ハイキングのタイムスタンプの間に追加されたアセットを判断できます。

更新されたアセットに調整が適用される可能性があるため、新しいhasAdjustments APIを使用して、UIでアセットを再描画する必要があるかどうかを確認できます。

削除されたアセットのローカル識別子を使用して、どのコラージュを再生成する必要があるかを判断できます。

今、私はすべてのオフラインフォトライブラリの変更を処理し、私のアプリは最新です。

新しい変更履歴APIを使用する際に留意すべき点がいくつかあります。

まず、あなたとあなたのアプリにとって重要な変更を判断し、それらの変更のみを確認します。

パフォーマンスを向上させるために、複数の小さなリクエストではなく、更新および挿入されたアセットの1つの大きなフェッチリクエストを実行することを検討してください。

フォトライブラリは、内部での処理と同期活動のために大きく変更される可能性があるため、特にアプリが頻繁に起動しない場合は、大量の変更を列挙してしまう可能性があります。

このため、UIをブロックしないように、バックグラウンドスレッドの変更履歴を尋ねることをお勧めします。

永続的な履歴を取得するときに発生する可能性のあるエラーには2つのタイプがあります。

変更トークンが利用可能な変更履歴よりも古い場合、期限切れの変更トークンエラーが返されます。

場合によっては、永続的な変更は、発生した変更を完全に再構築するために信頼できず、変更の詳細が利用できないというエラーが返されます。

このような場合、アプリが最新であることを確認するために、フォトライブラリで追跡されたオブジェクトを再フェッチすることをお勧めします。

締めくくる前に、あなたと共有したい新しいPhotoKit APIがいくつかあります。

PhotoKitは、メディアサブタイプとスマートアルバムによる映画ビデオへのアクセスをサポートするようになりました。

2つの新しいエラーコードもあります。

フォトライブラリバンドルがmacOSのファイルプロバイダ同期ルートディレクトリにある場合、ライブラリが破損する可能性があり、変更を実行しようとするとエラーが返されます。

ネットワークの問題でアセットリソースが見つからない場合、リソース要求はネットワークエラーを返すようになりました。

すべての最新のアップデートについては、開発者ドキュメントを確認してください。

最後に、写真で作業してアクセスする最も簡単な方法であるため、写真ピッカーで今年のセッションを必ずチェックしてください。

私たちは、あなたが新しい変更履歴APIとPhotoKitのすべての素晴らしい新機能を使用することにとても興奮しています。

ありがとう！

♪