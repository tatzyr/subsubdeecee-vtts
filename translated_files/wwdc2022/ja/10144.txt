10144

♪ ♪

Zheng Naiwei:こんにちは、WWDCへようこそ。

私の名前はAppleのAVFoundationチームのZheng Naiweiです。

このセッションでは、HLSコンテンツステアリングに追加した新機能を使用して、ストリーミング配信の信頼性を向上させる方法について説明します。

今日は3つのトピックを取り上げます。

コンテンツステアリングについて聞いたことがない場合は、心配しないでください。

これは、ストリーミングサービスの品質を向上させるために、ストリーミングトラフィックを動的に誘導できるHLS技術の一部です。

私はあなたが軌道に乗るのを助けるために短いレビューをします。

次に、ストリーミングサービスの信頼性をさらに向上させるために、制限を超えたダイナミックステアリング能力をもたらすことができる新しいパスウェイクローニング機能を紹介します。

最後に、具体的な例を使用して、トラフィックを操縦するためのサーバーサイドロジックに影響を与える方法をご案内します。もう待たずに始めましょう。

コンテンツステアリングがなかった時代には、エラーフォールバックの場合のバリアント選択はHLS仕様で標準化されていませんでした。

また、異なるクライアント実装は、次のフォールバックバリアントを選択する際に異なる動作をする可能性があります。

しかし、これを行う典型的な方法は、多変量プレイリストのバリアント順序に従うことです。

ストリーミングプロバイダーがフォールバックCDNのセットを指定したい場合は、すべてのCDNからすべてのバリアントをリストし、マルチバリアントプレイリストで適切に並べ替える必要があります。

このようにして、クライアントプレーヤーが最初のバリアントで障害に遭遇した場合、選択からペナルティを受けた失敗したバリアントでプレイリストの次のバリアントに進むことができます。

この場合、クライアントプレーヤーがCDN1の6 Mbpsバリアントに問題があったため、多バリアントプレイリストの順序に従って、CDN1から次の3 Mbpsバリアントに移動したことがわかります。

残念ながら、CDN1の3 Mbpsバリアントも失敗した場合、クライアントプレーヤーはCDN1のバリアントなしで残り、CDN2の6 Mbpsバリアントに進みます。

フォールバックするバリアントがなくなるまで、これをオンとオンを行うことができます。

ただし、プレイリストオーサリングサーバーはフォールバックバリアントの順序を制御できますが、そのような制御は、マルチバリアントプレイリストを要求するクライアントの時点でのみ行われ、プレイリストが配布されると、フォールバックの順序を変更する方法はありません。

ここでコンテンツステアリングが登場します。

コンテンツステアリングを使用すると、ストリーミングプロバイダーは、異なるCDNホストでバリアントをパスウェイにグループ化できるようになりました。

エラーフォールバックの動作は、コンテンツステアリング用に標準化されました。

経路は好み順に並べられています。

この例では、CDN2とCDN3に続いて、上部のCDN1パスウェイが最も好まれます。

ストリーミングプロバイダーはまた、ステアリングサーバーをホストし、各クライアントプレーヤーのステアリングマニフェストを生成します。

ステアリングマニフェストは、パスウェイの優先順位のルールを定義するので、プレイヤーはバリアントストリーム間の選択とフォールバックのルールに従うことができます。

たとえば、ストリーミングプロバイダーがCDN1からCND2にトラフィックの一部をオフロードしようとしているとします。

新しいパスウェイ優先ルールでステアリングマニフェストを生成し、CDN1からプレイしているクライアントプレーヤーがステアリングマニフェストの更新を要求すると、ステアリングサーバーはルールの変更とともに準備されたステアリングマニフェストをクライアントに送信できます。

クライアントは、新しいパスウェイ優先度ルールを解析して表示し、再生セッションに適用します。

この場合、ルールはパスウェイCDN1とCDN2の間で設定順序を切り替え、クライアントプレーヤーがすぐにCDN2から切り替えて再生されるようにします。

その後、障害が発生した場合、クライアントはまず現在のパスウェイ内のフォールバックバリアントを枯渇させ、現在のパスウェイ優先度に従って最も好ましいパスウェイにフォールバックします。

この場合、CDN2のすべてのバリアントがエラーになった場合、クライアントプレーヤーは、次の優先パスウェイであるCDN1のバリアントから選択を開始できます。

コンテンツステアリングを世界規模に適用すると、より大きな地域のロードバランシング問題を解決できます。

当社のストリーミングサービスプロバイダーは、2つの主要なCDNプロバイダーで世界中で運営されているとしましょう。

これらのCDNをグローバルにクライアントプレーヤーに割り当てるために、ステアリングサーバーは2つの異なるステアリングマニフェストを用意しました。1つはCDN1を好み、もう1つはCDN2を好みます。

次に、北米と南米がCDN1を利用し、世界の他の地域がCDN2を利用するように、クライアントプレーヤーの地域に基づいてこれらのステアリングマニフェストを配布します。

世界地図の上部には、CDN1とCDN2の間のトラフィックの分布を表す水平スタックバーが表示されます。

現時点では、両方のCDNが世界のトラフィックの半分にサービスを提供しています。

しかし、時間の経過とともに、ストリーミングサービスプロバイダーは、世界的な日光シフトのためにCDN2へのトラフィックの大幅な増加を観察しました。

同時に、CDN1へのトラフィックは減少しています。

そこで、ストリーミングプロバイダーは、CDN1を使用するようにヨーロッパ地域を操縦することを決定しました。

CDN1を好むステアリングマニフェストを準備し、ヨーロッパ地域のクライアントに送信します。

現在、その地域のクライアントプレーヤーは、CDN2からオフロードしてCDN1にトラフィックを誘導します。

そして、世界のトラフィックはよりバランスが取れました。

それでは、コンテンツステアリングをサポートするHLS多変プレイリストを見てみましょう。

まず、この多変量プレイリストがコンテンツステアリングを使用していることを示すEXT-X-CONTENT-STEERINGタグが表示されます。

次に、クライアントがステアリングマニフェストの更新を要求する場所を指定するSERVER-URI属性があります。

次に、次のPATHWAY-ID属性は、起動時に再生を選択する最初の経路を指定します。

次に、各バリアントストリームにPATHWAY-ID属性が与えられ、それらをPathwaysにグループ化していることがわかります。

各パスウェイは、同じバリアントストリームのセットを持つ必要があり、違いはURIとメディアグループ名だけです。

この例では、CDN1とCDN2の2つのパスウェイがあります。

どちらも2つのバリアントストリーム、1つの6 Mbpsの高解像度ビデオと1つの3 Mbpsの低解像度ビデオが含まれています。

唯一の違いは、URIホスト名です。

また、パスウェイごとに異なるURIホスト名を持つ2つの異なるオーディオグループもあります。

以下は、JSONドキュメントであるステアリングマニフェストの例です。

PATHWAY-PRIORITYフィールドは、優先順のパスウェイIDのリストです。

したがって、この場合、受信クライアントプレーヤーはCDN2よりもCDN1を好みます。

これは、ステアリングサーバーがヨーロッパのクライアントに提供するステアリングマニフェストであり、CDN1を優先させます。

ステアリングマニフェストのPATHWAY-PRIORITYフィールドを変更することで、ステアリングサーバーはすべてのクライアントのステアリングポリシーを制御できます。

コンテンツステアリングの簡単な概要については、それだけです。

より詳細な説明が必要な場合は、私のWWDC21トーク、HLSコンテンツステアリングでグローバルストリーミングの可用性を向上させることをお気軽にチェックしてください。

しかし、よりスケーラブルで信頼性の高いストリーミングサービスをサポートするための私たちの旅はここで止まりません。

今日では、企業は過去に想像もできなかったことを達成するために、より汎用性の高いクラウドインフラストラクチャとツールにアクセスすることができ、私たちは技術の飛躍に追いつく必要があります。

ストリーミングサービスプロバイダーが今年大きく成長し、成長するユーザーベースの動的なトラフィック需要を満たす新しい方法を実験しているとしましょう。

彼らは、一時的なトラフィックのストレスを軽減するために、リアルタイムでCDNサーバーの艦隊を動的に生成することによってそれを行っています。

たとえば、CDN3の新しい艦隊を生成し、既存のクライアントに宣伝することができます。

しかし、ここでの課題は、既存のクライアントが要求したときに、動的に生成されたCDN情報が多変量プレイリストに含まれていないことです。

では、新しいCDNの出現をクライアントプレーヤーに伝えるために何ができますか?

これは、私たちの新しいパスウェイクローニング機能が便利な場所です。

これは、WWDC21で導入されたコンテンツステアリング1.2と下位互換性のある新機能です。

パスウェイクローニングを使用すると、ステアリングサーバーはコンパクトなマニフェスト定義を使用して既存のクライアントに新しいCDNをアナウンスできます。

パスウェイが構造同一であると仮定すると、既存のパスウェイをコピーして変更することで、新しいパスウェイを作成できます。

パスウェイの構造を見てみましょう。-パスウェイの構造を見てみましょう。

パスウェイは、1つまたは複数のバリアントストリームで構成されています。

各バリアントストリームは、1つのパスウェイにしかできません。

PATHWAY-ID属性が指定されていない場合は、暗黙的にデフォルトの「ドット」パスウェイに属します。

各バリアントストリームは、オーディオ、字幕、クローズドキャプションから、メディアタイプごとに0または1つのメディアグループを参照できます。

各メディアグループは、異なるパスウェイからでも、複数のバリアントストリームによって参照される場合があります。

既存のパスウェイから新しいパスウェイをクローンするときは、バリアントストリームだけでなく、参照されたメディアグループもクローンする必要があります。

次に、新しいパスウェイにするには、新しくクローンされたパスウェイのバリアントとレンディションストリームのURIを変更する必要があります。

たとえば、クローンされたパスウェイから6 Mbpsのバリアントストリームを見てみましょう。

この特定のバリアントストリームに示すようにURIがあるとします。

新しいパスウェイのURIになるように変更するには、最も柔軟な方法は、完全なURI行を全体的に置き換えることです。

これは、クローンされたパスウェイごとにステアリングマニフェストにURIのフルセットを格納する必要があることを意味します。

しかし、実際には、私たちは通常、それよりも良いことができます。

業界では、同じURIパス構造を保持する複数のCDNにストリーミングアセットを展開するのが一般的です。

そして、同じURIから提供されるアセットは、同じURIホスト名とクエリパラメータを共有します。

その場合は、ホストとクエリのパラメータの置き換えをマニフェストに保存し、すべてのクローンURIのコンポーネントを置き換えるだけで、新しいパスウェイが手に入りました。

マニフェストオブジェクトでパスウェイクローンを定義する方法を見てみましょう。

パスウェイクローンオブジェクトの配列を含むPATHWAY-CLONESフィールドを追加しました。

各パスウェイクローンオブジェクトは、既存のパスウェイからクローンされた新しいパスウェイを定義します。

この例では、パスウェイクローンオブジェクトが1つあります。

BASE-IDフィールドは、CDN1をクローンする元のパスウェイとして指定します。

IDフィールドは、新しいパスウェイIDをCDN3に指定します。

次に、URI置換ルールのオブジェクトを持つURI-REPLACEMENTフィールドがあります。

この例では、ホストとクエリパラメータの置換ルールを使用しており、ホスト部分を置き換え、それぞれストリームURIのクエリパラメータを挿入または置き換えます。

この場合、ホスト部分をcdn3.example.comに置き換え、クエリパラメータ「foo」を値xyzで、クエリパラメータ「bar」を値123に追加または設定します。

前のURIの例で、ホストとパラメータのURI置換を適用してみましょう。

まず、多変種プレイリストのURIに基づいて解決されたバリアントストリームURIがあります。

ステアリングマニフェストでは、HOST URI置換ルールを使用しました。

したがって、URIのホスト部分については、cdn3.example.comに置き換え、新しいURIの新しいホスト部分を手に入れました。

次に、クローンされたURIからURIパスコンポーネントを保持します。

最後に、URIクエリパラメータ置換ルールを適用します。

ここでは、元のURIに存在するため、「foo」パラメータを置き換えます。

次に、新しいパラメータであるため、「バー」パラメータを追加します。

次に、新しいURIの置換クエリパラメータ部分があります。

最終的な結果のURIは、新しいパスウェイCDN3からの6 MbpsバリアントストリームのURIになります。

クローンされたパスウェイの残りのバリアントとレンディションに同じURI置換ルールを適用します。

3 Mbpsバリアントストリームの場合、元のURIがあり、ホストとパラメータの置換ルールを適用して新しいURIを取得します。

オーディオと字幕の演奏にも同じことをします。

すべてのクローンバリアントとレンディションにURI置換ルールを適用した後、新しいCDNホストから機能する新しいパスウェイがあります。

別の例を挙げると、ストリーミングプロバイダーが、他の低ビットレートストリームとは異なる、特別にチューニングされた最速のCDNホストから最高帯域幅のビデオとオーディオストリームを提供したいとしましょう。

これは、stable-IDごとのURI置換ルールが便利な場所です。

HLSでは、バリアントとレンディションストリームを識別するために、STABLE-VARIANT-IDとSTABLE-RENDITION-ID属性が導入されました。

多変量プレイリストで設定することで、後で各バリアントまたはレンディションストリームを参照し、パスウェイクローンオブジェクトの安定したID、ステアリングマニフェストで参照し、ストリームごとのURI置換ルールを割り当てることができます。

これらの特定の特別なURI置換ルールを定義するには、多変量プレイリストのすべてのバリアントストリームとレンディションストリームに安定したIDを割り当てる必要があります。

たとえば、STABLE-RENDITION-ID「audio-en-ac3」をAC3英語オーディオに、STABLE-VARIANT-ID「video-4k-dv」を25 Mbps 4Kバリアントストリームに割り当てます。

次に、ステアリングマニフェストでは、安定したIDを参照して、2つの柔軟な交換ルールを追加できます。

バリアントストリームの場合、URIレコードへのSTABLE-VARIANT-IDの辞書を使用して、「URI-REPLACEMENT」オブジェクトに「PER-VARIANT-URIS」フィールドを追加しました。

ここでは、バリアントストリームのURIをSTABLE-VARIANT-ID「video-4k-dv」に次のURIに置き換えることを指定します。

レンディションストリームでは、URIレコードにSTABLE-RENDITION-IDの辞書を使用して、「URI-REPLACEMENT」オブジェクトに「PER-RENDITION-URIS」フィールドを追加しました。

ここでは、レンディションストリームのURIをSTABLE-RENDITION-ID「audio-en-ac3」に次のURIに置き換えることを指定します。

ここでは、URI置換を適用した後、4KビデオバリアントとAC3英語オーディオレンディションを除き、すべてのストリームが新しいcdn3.exmaple.comホストから提供され、faster.example.comホストを指し、異なるURIパスとクエリコンポーネントを持つ特別なURI置換ルールがあることがわかります。

パスウェイクローニングを使用すると、ストリーミングプロバイダーが新しいCDNフリートを動的に生成する場合、この例のCDN3では、ステアリングサーバーはステアリングマニフェストで既存のクライアントのパスウェイクローンとしてCDN3を追加できます。

また、ヨーロッパなどの地域を選択して、CDN3をプライマリパスウェイとして優先することもできます。

ヨーロッパのクライアントがステアリングマニフェストの更新を入手すると、トラフィックをCDN3に誘導します。

この講演の最後の部分では、ステアリングサーバーの詳細に焦点を移し、具体的な例を挙げてサーバーロジックを実装し、ロードバランシングのためにクライアントプレーヤーのトラフィックを操縦する方法を説明しましょう。

クライアントプレーヤーの沼地を管理およびオーケストレーションし、分割されたルールを適用する1つの方法は、すべてのクライアントをバケットに入れ、バケットレベルでルールを適用することです。

クライアントセッションの状態を維持せずに、ステアリングサーバーでバケットを実装するのは簡単です。

クライアント プレーヤーが最初のステアリング マニフェストを要求すると、ステアリング サーバー URI で HTTP GET リクエストを行います。

次に、サーバーは12の可能なバケットから均一な乱数を生成します。

ステアリングマニフェストを返すと、サーバーはバケット番号（この場合は7）をRELOAD-URI属性に追加します。これは、クライアントプレーヤーからの次のリクエストのステアリングマニフェストURIになります。

クライアントプレーヤーが次回ステアリングマニフェストを要求するときに、リクエストパラメータにバケット番号が記載され、サーバーはそれを抽出し、バケット番号に基づいてステアリングルールを適用できます。

では、簡単なバイパーティションステアリングルールを見てみましょう。

この場合、トラフィックの50%をCDN1に好み、残りの50%のトラフィックをCDN2に誘導したいと考えています。

バケット番号の観点からそのようなルールを書くことができます。

クライアントプレーヤーのバケット番号が最初の6つのバケットに該当する場合は、PATHWAY-PRIORITYがCDN1を好むステアリングマニフェストを返し、それ以外の場合はPATHWAY-PRIORITYがCDN2を好む状態でそれを返します。

クライアントはバケットに一様に割り当てられているため、12個のバケットを6つのバケットに分割すると、トラフィックを均等に分割できます。

さて、CDN3と呼ばれる新しいパスウェイが動的に生成されたとしましょう。

ステアリングサーバーは、マルチバリアントプレイリストからそれを知らないクライアントにパスウェイクローニングを使用してそれを宣伝することができます。

パスウェイクローニングを使用してステアリングマニフェストを構築する際の一般的な質問の1つは、PATHWAY-CLONES配列に含める必要があるパスウェイのセットを決定することです。

ルールは、クライアントの多変量プレイリストにないパスウェイを複製することです。

しかし、クライアントセッションに関するサーバー側の状態を維持することなく、ステアリングサーバーはクライアントの多変量プレイリストのパスウェイのセットをどのように知ることができますか?

これを行う1つの方法は、多変量プレイリストの生成中に、最初のステアリングサーバーURIにパスウェイのセットをクエリパラメータとして含めることです。

この場合、多変量プレイリストには、CDN1とCDN2の2つの経路が含まれています。

したがって、クエリパラメータとしてSERVER-URI属性にそれらを含めます。

その後、クライアントプレーヤーはURIにリクエストを送信し、パラメータをステアリングサーバーに運びます。

その後、ステアリングサーバーは、クライアントの多変量プレイリストのパスウェイのセットとしてパラメータを抽出できます。

次に、クライアントの多変量プレイリストのパスウェイのセットを使用して、利用可能なパスウェイのセットを差し引くことで、クローンするパスウェイのセットを計算できます。

この場合、利用可能なパスウェイはCDN1、2、および3であり、クライアントの多変量プレイリストのパスウェイはCDN1とCDN2であるため、PATHWAY-CLONES配列に含める必要があるパスウェイはCDN3です。

また、利用可能な3つのパスウェイがある場合、ステアリングサーバーがステアリングルールをどのように変更できるかを見てみましょう。

この場合、サーバーはCDN1、2、3でクライアントトラフィックを均等に分割したいと考えています。

このルールは、クライアントのバケット番号が12個のバケットの最初の3分の1に該当する場合はCDN1を優先するPATHWAY-PRIORITYを返し、クライアントのバケット番号が2番目の3番目の範囲に該当する場合はCDN2を優先するPATHWAY-PRIORITYを返し、それ以外の場合はCDN3を優先するPATHWAY-PRIORITYを返します。

このようにして、各パスウェイはクライアントトラフィックの3分の1にサービスを提供します。

私たちがカバーしたすべてで、あなたは今、あなた自身のダイナミックステアリングルールであなたのステアリングサーバーを構築するための設備が整っています。

そうすることで、ストリーミングサービスの信頼性をさらに向上させることができます。

今年のコンテンツステアリングの更新はこれでおそれです。

まだ行っていない場合は、より汎用性が高く、動的なトラフィックステアリングを提供するため、HLS CDNフォールバックメカニズムとしてコンテンツステアリングを採用してみてください。

また、新しいパスウェイクローニング機能を利用して、サービスの信頼性を向上させてください。

いつものように、技術的な詳細については、最新のIETF HLS仕様を確認してください。

また、変更を行う際に、HTTPライブストリーミングツールを使用してプレイリストを検証することを忘れないでください。

最後に、さらに質問や提案がある場合は、hls-interest@ietf.orgまでお気軽にお問い合わせください。

ご参加いただきありがとうございます。良い一日をお過ごしください。