10066

♪ ♪

Tarun Belagodu：こんにちは、Metal 3へようこそ。

私の名前はタルン・ベラゴドゥで、メタルの進化の最新情報を共有します。

まず、基本から始めましょう。

Metalは、Appleの低オーバーヘッドグラフィックスとコンピューティングAPIです。

これは、Apple製品の背後にある信じられないほど強力なGPUを駆動するための最速かつ最も効率的な方法であるように設計されています。

GPUに送信されるコマンドをマルチスレッドで直接制御し、明示的なシェーダーコンパイルをサポートする豊富なシェーディング言語と、複雑なアプリケーションやゲームをデバッグしてプロファイリングするのに役立つ深く統合されたツールを提供します。

導入以来、MetalはGPU駆動のレンダリング、機械学習、レイトレーシングに重点を置いて、多くの高度なグラフィックスとコンピューティング機能を追加してきました。

Appleシリコンは、すべての新しいMacで信じられないほどのグラフィックス性能と効率性への道を開きます。

そして、メタルはこれらの機能のロックを解除します。

今年、メタルはメタル3で次のレベルに飛躍しています。

Metal 3は、アプリやゲームがより速く実行され、素晴らしく見えるように、さらに高いパフォーマンスとレンダリング品質を可能にする強力な新機能セットです。

迅速なリソースの読み込みから始めましょう。

現代のゲームやアプリには厳しいアセットの読み込み要件があり、多くの小さなアセットリクエストをファイルからメタルリソースにすばやくストリーミングすることは、多くの場合、高品質のビジュアルの鍵です。

しかし、既存のストレージAPIは、大規模な一括リクエスト用に設計されています。

Metal 3の高速リソースロードを使用すると、グラフィックスやコンピューティングと同じ明示的なマルチスレッドコマンドモデルを使用して、多くの小さなロードを要求できます。

各リクエストはコマンドであり、多くのコマンドを非同期送信のためにキューに入れることができます。

追加の手順なしでメタルバッファとテクスチャに直接ロードされ、開発労力と転送時間の両方を節約できます。

高速リソースロードにより、すでに知っているMetal同期プリミティブを使用して、GPU操作とロード操作を簡単に調整できます。

テクスチャストリーミングシステムは、高速なリソース読み込みから本当に恩恵を受けています。

例を見てみましょう。 例を見てみましょう。

メタルスパーステクスチャは、アプリケーションがタイルの粒度でテクスチャをストリーミングすることを可能にします。

メタルスパーステクスチャ上に構築されたテクスチャストリーミングシステムは、4つのステップで構成されています。まず、前のフレームからのフィードバックに基づいて何をロードするかを決定します。

次に、ファイルストレージからタイルをロードします。

第三に、ステージングエリアからスパーステクスチャにコピーします。

そして最後に、あなたのフレームを描きます。

読み込みとコピーに時間がかかるほど、アプリが低品質で描画する時間が長くなります。

高速リソースロードは、ロードオーバーヘッドを最小限に抑え、ストレージハードウェアがキューにスループットを最大化するのに十分な要求があることを保証します。

これにより、より速く、より一貫したパフォーマンスが得られ、高品質の描画により多くの時間を費やすことができます。

迅速なリソースロードは、高品質のアセットストリーミングを実現するために書く必要があるコードを大幅に簡素化します。

高速リソースロードの詳細については、「Metal 3でリソースをより速くロードする」セッションをご覧ください。

次に、新しいオフラインコンパイルワークフローが、アプリの読み込み時間とスタッターを削減するのにどのように役立つかを説明します。

シェーダーバイナリは、Metalパイプライン作成プロセスの一環としてアプリが実行されている間に伝統的に生成されるGPU固有のマシンコードです。

これらのバイナリの生成は、通常、アプリの起動中にロード画面の後ろに隠される高価な操作です。

しかし、時にはフレーム内で発生する必要があり、その結果、フレームレートのスタッターが発生します。

これらのバイナリはMetalによってキャッシュされるため、コストを頻繁に支払うことはありませんが、そのコストはアプリの最初の起動時、またはバイナリが最初に必要なときにも観察されます。

オフラインコンパイルでは、実行時にシェーダーバイナリ生成を排除できます。

バイナリ生成をプロジェクトビルド時間に移行することで、ロード時にメタルパイプラインの作成に費やす時間を大幅に短縮し、それらのパイプラインがちょうど時間内に作成されたときにアプリのスタッターを減らすことができます。

吃音を減らすことが何を意味するのかを詳しく見てみましょう。

これは、エンコード中にMetalパイプライン状態オブジェクトを作成する必要があるゲームの例です。

これはメタルがこれまでに見たことのないパイプラインであるため、必要なシェーダーバイナリを生成します。

これは、フレームの残りの部分のエンコーディングを中断し、アプリがフレームレート目標を逃す長い操作です。

これは一度しか起こりませんが、ユーザーがフレームの吃音に気づくだけで十分です。

対照的に、オフラインコンパイルとは、すべてのパイプライン状態の作成が高速で、実行がスムーズになるように、シェーダーバイナリをビルド時に生成できることを意味します。

オフラインコンパイルは、アプリの読み込み時間にも劇的な影響を与える可能性があります。

例を見てみましょう。 例を見てみましょう。

ほとんどのアプリは、専用のロードフェーズで金属パイプライン状態オブジェクトの大部分を作成します。

そして、シェーダーバイナリは最初のロード時に生成されます。

アプリがそのようなパイプラインをたくさん作成する場合、これはユーザーにとって長い待ち時間になる可能性があります。

オフラインコンパイルでは、シェーダーバイナリ生成を再びプロジェクトビルド時間に移動できるため、ロード時間が短縮され、ユーザーをより迅速にアプリに誘導できます。

オフラインコンパイルは、多くの複雑なパイプラインを持つアプリのゲームチェンジャーです。

オフラインコンパイルやその他の改善の詳細については、「Metal 3でGPUバイナリをターゲットにして最適化する」セッションをチェックしてください。

それでは、Metalアプリケーションにプラットフォームに最適化されたグラフィックエフェクトを提供するMetalFXに移りましょう。

MetalFXアップスケーリングは、高性能なアップスケーリングとアンチエイリアスにより、より短い時間で高品質のグラフィックスをレンダリングするのに役立ちます。

パフォーマンスを向上させるために、時間的または空間的アルゴリズムの組み合わせを選択できます。

これが重要な理由です。

Retina解像度は、アプリやゲームに活用してもらいたい鮮明なディテールを提供しますが、これらすべてのピクセルを生成すると、パフォーマンスにも影響する可能性があります。

MetalFXアップスケーリングを使用すると、より低い解像度でピクセルを生成し、フレームワークがはるかに高いフレームレートで低コストで高品質で高解像度の画像を生成できます。

MetalFXは、高性能で高品質のアップスケーリングを実現する強力なフレームワークです。

MetalFXアップスケーリングの詳細については、「MetalFXアップスケーリングによるパフォーマンスの向上」セッションをご覧ください。

次は、メタルの新しいフレキシブルジオメトリパイプライン、メッシュシェーダーです。

従来のプログラム可能なグラフィックスパイプラインでは、シェーダーで頂点を変換し、固定機能ハードウェアによるラスタライズのためにプリミティブに組み立てることができます。

ほとんどのアプリケーションでは十分ですが、淘汰などの一部のユースケースでは、プリミティブ全体にアクセスする必要があります。

各頂点も独立して読み取られ、変換され、出力されます。

そのため、ドローの途中で頂点やプリミティブを追加することはできません。

高度なジオメトリ処理には、より多くの柔軟性が必要です。

そして、伝統的に、それは計算パスでジオメトリを前処理することを意味していました。

しかし、それには可変量の中間ジオメトリをデバイスメモリに保存する必要があり、予算を立てるのは難しいかもしれません。

メタルメッシュシェーダーは、代替ジオメトリ処理パイプラインを導入し、従来の頂点ステージを柔軟な2段階モデルに置き換え、ジオメトリの階層処理を可能にします。

第1段階では、オブジェクト全体を分析して、第2段階でジオメトリを拡張、縮小、または改良するかどうかを決定します。

中間デバイスのメモリストレージを必要とせずに、レンダリングパスにコンピューティング機能を提供することでこれを実現します。

メッシュシェーダーは、GPU主導のカリング、LOD選択、および手続き型ジオメトリ生成を実行するアプリに最適です。

詳しく見てみましょう。 

この例では、計算パスがサーフェスを評価し、そのジオメトリを生成します。

そのジオメトリとその描画コマンドは、後のレンダリングパスで消費するためにデバイスメモリに書き込まれます。

高い膨張係数と間接的なドローコールでは、必要なメモリの量を予測するのは難しい場合があります。

メッシュシェーダーは、レンダリングパイプラインで2つの計算のようなステージをインラインで実行することで、効率を向上させます。

オブジェクトステージは、入力を評価して、いくつのメッシュを生成する必要があるかを決定します。

そして、メッシュステージは実際のジオメトリを生成します。

これらのメッシュは、デバイスメモリへのラウンドトリップと頂点処理の必要性をバイパスして、ラスタライザーに直接送信されます。

メッシュシェーダーを使用すると、アプリの効率的な手続き型ジオメトリ、カリング、およびLODingシステムを構築できます。

メッシュシェーダーの詳細については、「メタルメッシュシェーダーでジオメトリを変換する」セッションをチェックしてください。

メタル3はまた、レイトレーシングパイプラインに大幅なスピードアップをもたらします。

加速構造の構築、交差、シェーディングからすべてが最適化されています。

Metalはまた、アプリをさらに最適化するために、GPU駆動のレイトレーシングパイプラインのサポートを追加します。

メタル3のレイトレーシングを以前に利用可能だったものと比較してみましょう。

メタル3レイトレースは、CPUとGPUの時間を大幅に節約します。

まず、加速構造はより短い時間で構築され、光線を描画してトレースするGPUの時間が増えます。

第二に、レイトレーシングの新しい間接コマンドバッファサポートのおかげで、カリングなどのCPU操作をGPUに移行できます。

最後に、Metal 3レイトレーシングは、プリミティブデータへの直接アクセスをサポートし、交差とシェーディングを合理化および最適化します。

メタル3レイトレーシングは、以前よりも良く、より強力になり続けています。

レイトレーシングの詳細については、「メタルレイトレーシングのパフォーマンスを最大化する」セッションをご覧ください。

さて、Metal 3が機械学習の推論とトレーニングをどのように加速するかを紹介します。

Metal 3には、機械学習を加速するための大きな改善があり、Macでのネットワークトレーニングを加速するための追加サポートと、グラフィックスおよびメディア処理アプリケーションにおけるML推論最適化の大幅な最適化があります。

TensorFlowは、Mac上でGPUアクセラレーションされた機械学習のための一般的なフレームワークです。

最近リリースされたMac Studioは、さまざまなネットワークで、CPUでのトレーニングと比較して、M1 Ultraで最大16倍のスピードアップを提供します。

また、Metal 3は、多くの新しいTensorFlow操作を加速します。

つまり、CPUとの同期が少なくなり、さらにスケーラブルなパフォーマンスを実現します。

PyTorchは、最近Metalを使用してGPUアクセラレーションを獲得したネットワークトレーニングのためのもう一つの非常に人気のあるMLフレームワークです。

また、M1 Ultraを搭載したMac Studioでは、CPUと比較して大幅なトレーニングスピードアップを実現できます。

たとえば、BERTモデルを最大6.5倍速く、ResNet50を最大8.5倍速くトレーニングできます。

Metalは、Appleシリコン全体でML推論を最適化し、パフォーマンスを最大化します。

これは、BlackMagic DesignのDaVinci Resolveのような金属ベースの高性能ビデオおよび画像処理アプリケーションに特に役立ちます。

DaVinci Resolveは、ワークフローで金属と機械学習を広範囲に使用するカラーグレーディングに焦点を当てたビデオ制作プラットフォームです。

そして、結果は信じられないほどです。

機械学習の加速に対するMetalのサポートにより、BlackMagic Designは編集とカラーグレーディングのワークフローとMLベースのツールのパフォーマンスを劇的に向上させました。

機械学習のアップデートの詳細については、「Accelerate machine learning with Metal」セッションをご覧ください。

それでは、先ほど説明したMetal 3の機能をサポートするハードウェアをお伝えします。

Metal 3は、A13 BionicまたはM1チップ以降を搭載したiPhoneとiPad、および最新のAMDおよびIntel GPUを搭載したすべてのAppleシリコンMacシステムとMacシステムを含む、すべての最新のiOS、iPadOS、およびmacOSデバイスでサポートされています。

また、特定のデバイスがMetal 3をサポートしているかどうかを調べるには、MetalデバイスのsupportsFamilyクエリを使用します。

メタル3は機能以上のものです。また、高度な開発者ツールの包括的なセットも含まれています。

今からいくつかお見せしましょう。

Xcode 14のMetal Dependency Viewerを使用すると、レンダラー全体を視覚化したり、1回のパスにズームしたりすることがさらに簡単になります。

また、GPU主導のパイプラインを採用したり、高速なリソースロードと同期したりしやすくするために、依存関係ビューアには、依存関係の分析と検証に役立つ同期エッジが含まれています。

Xcode 14で改良された加速構造ビューアは、Metal 3の最適化されたレイトレーシングを最大限に活用するのに役立ちます。

まず、シーン内の個々のプリミティブを強調表示できるようになりました。

そして、プリミティブを選択すると、左側のアウトラインに関連付けられたプリミティブデータが表示されます。

最後に、シーンにモーション情報がある場合、加速構造ビューアはさまざまな時点を視覚化できるようになりました。

そして、それはXcode 14の開発者ツールのアップデートのいくつかを簡単に見るだけです。

Dylibサポート、新しいリソースリスト、シェーダーエディタのファイルナビゲーション、カスタムバッファビューアレイアウトなど、他の多くの新機能があります。

ツールとMetal 3の進歩を最大限に活用する方法の詳細については、高度なグラフィックス、ゲーム、プロアプリを構築するのに役立つこれらの他のセッションを必ずチェックしてください。

今日は、パフォーマンスと品質を向上させるためのMetal 3の高度な機能を紹介しました。高品質のテクスチャストリーミングのための高速リソースロード。より短いロード時間とより少ないスタッタリングのためのオフラインコンパイル。より少ない時間で高解像度でレンダリングするMetalFXアップスケーリング。高度なジオメトリ処理のためのメッシュシェーダー。レイトレーシングのためのより高速な加速構造構築、交差、およびシェーディング。そしてより加速された機械学習

最後に、GPU駆動のパイプラインやレイトレーシングなどの高度な機能を使用するのに役立つ高度なツールをいくつか紹介しました。

新しいコードサンプルとドキュメントの詳細については、developer.apple.com/Metalをご覧ください。

ご参加いただきありがとうございます。